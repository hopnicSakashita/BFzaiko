# マスタ管理機能 詳細設計書

## 1. 機能概要

### 機能名
マスタ管理システム（Master Data Management System）

### 機能目的
在庫管理システムの基盤データ管理として、製品情報・取引先情報・区分情報等の各種マスタデータの統合管理を行い、システム全体のデータ整合性確保と業務効率化を実現する。

### システム位置づけ
- **基盤システム**: 全業務機能の基礎となるマスタデータ管理
- **参照整合性保証**: システム全体でのデータ品質維持
- **運用効率化**: 動的区分管理による設定変更の簡素化

### 主要管理対象マスタ
1. **区分マスタ（KBN_MST）**: 動的区分管理システム
2. **製品マスタ（PRD_MST）**: 製品・商材の統合管理
3. **取引先マスタ（CZTR_MST）**: 得意先・加工会社・その他の管理
4. **加工マスタ（CPRC_MST）**: 加工プロセス・外注管理
5. **バーコードマスタ（CBCD_MST）**: 製品別バーコード情報管理
6. **加工集計グループマスタ（CPRG_MST）**: 加工レポート用グループ管理

## 2. 区分マスタ（KBN_MST）管理機能

### 2.1 機能概要

#### テーブル構造
- **KBN_ID**: 区分ID（主キー1）
- **KBN_NO**: 区分番号（主キー2、表示順序）
- **KBN_NM**: 区分名（表示名）
- **KBN_FLG**: フラグ（0:有効、9:削除）

#### システム特徴
- **動的区分管理**: 一つのテーブルで複数区分を統合管理
- **設定の柔軟性**: コード変更なしでの区分値変更
- **API連携**: JSON形式でのデータ提供機能

### 2.2 事前定義区分

#### 標準区分定義
- **RANK**: ランク区分（A、B、C、D）
- **GSPEC**: グラデーション仕様区分
- **GCOLOR**: グラデーション色区分

#### フラグ管理
- **0**: 有効
- **1**: 無効
- **9**: 削除済み

### 2.3 区分マスタCRUD機能

#### 一覧表示機能（/master/kbn_list）
- **検索条件**: 区分ID、有効フラグ絞り込み
- **表示順**: KBN_ID、KBN_NO順
- **フィルタリング**: 有効データのみ表示オプション

#### 新規作成・編集機能（/master/kbn_form）
- **入力検証**: 必須項目チェック、重複チェック
- **論理削除**: KBN_FLG=9による削除フラグ管理

#### API連携機能（/api/master/kbn_list）
- **JSON応答**: 区分データのJSON形式提供
- **外部連携**: 他システムとの区分データ共有

## 3. 製品マスタ（PRD_MST）管理機能

### 3.1 機能概要

#### テーブル構造
- **PRD_ID**: 製品ID（主キー）
- **PRD_NM**: 製品名
- **PRD_RANK**: 品質ランク（KBN_MST.RANK参照）
- **PRD_FLG**: フラグ（0:有効、9:削除）

#### システム特徴
- **参照整合性**: KBN_MSTとの連携
- **品質ランク管理**: A,B,C,Dランクによる品質分類
- **検索機能**: 製品ID、製品名による柔軟な検索

### 3.2 製品マスタCRUD機能

#### 一覧表示機能（/master/prd_list）
- **検索条件**: 製品ID、製品名、ランク
- **ページング**: 大量データの効率的表示
- **ソート機能**: 各列でのソート対応

#### 新規作成・編集機能（/master/prd_form）
- **入力検証**: 製品ID重複チェック、ランク値検証
- **区分連携**: KBN_MSTからのランク値取得
- **論理削除**: フラグによる削除管理

## 4. 取引先マスタ（CZTR_MST）管理機能

### 4.1 機能概要

#### テーブル構造
- **CZTR_ID**: 取引先ID（主キー）
- **CZTR_NM**: 取引先名
- **CZTR_KBN**: 取引先区分（1:得意先、2:加工会社、3:その他）
- **CZTR_FLG**: フラグ（0:有効、9:削除）

#### システム特徴
- **区分別管理**: 得意先、加工会社、その他の分類管理
- **出荷先連携**: 出荷データとの参照整合性
- **加工依頼連携**: 加工会社データとの連携

### 4.2 取引先マスタCRUD機能

#### 一覧表示機能（/master/cztr_list）
- **区分フィルタ**: 取引先区分による絞り込み
- **検索機能**: 取引先ID、名称検索
- **有効データ表示**: アクティブな取引先のみ表示

#### 新規作成・編集機能（/master/cztr_form）
- **区分設定**: プルダウンによる区分選択
- **重複チェック**: 取引先ID重複防止
- **参照チェック**: 削除前の参照データ確認

## 5. 加工マスタ（CPRC_MST）管理機能

### 5.1 機能概要

#### テーブル構造
- **CPRC_ID**: 加工ID（主キー）
- **CPRC_NM**: 加工名
- **CPRC_TO**: 加工会社ID（CZTR_MST参照）
- **CPRC_FLG**: フラグ（0:有効、9:削除）

#### システム特徴
- **外注管理**: 加工会社との連携
- **加工プロセス**: 各種加工工程の定義
- **参照整合性**: 取引先マスタとの連携

### 5.2 加工マスタCRUD機能

#### 一覧表示機能（/master/cprc_list）
- **加工会社連携**: CZTR_MSTとのJOIN表示
- **検索機能**: 加工ID、加工名検索
- **有効データ絞り込み**: アクティブな加工のみ表示

#### 新規作成・編集機能（/master/cprc_form）
- **加工会社選択**: 取引先マスタからの選択
- **入力検証**: 必須項目チェック、参照整合性確認
- **削除制御**: 使用中加工の削除防止

## 6. バーコードマスタ（CBCD_MST）管理機能

### 6.1 機能概要

#### テーブル構造
- **CBCD_ID**: バーコードID（自動採番）
- **CBCD_PRD_ID**: 製品ID（PRD_MST参照）
- **CBCD_TO**: 出荷先ID
- **CBCD_NM**: 製品名
- **CBCD_NO1/NO2**: バーコード１・２
- **CBCD_FLG**: フラグ

#### システム特徴
- **製品連携**: 製品マスタとの参照関係
- **出荷先別管理**: 出荷先ごとのバーコード管理
- **複数バーコード**: 1製品に複数バーコード対応

### 6.2 バーコードマスタCRUD機能

#### 一覧表示機能（/master/cbcd_list）
- **製品連携表示**: 製品名との組み合わせ表示
- **出荷先フィルタ**: 出荷先による絞り込み
- **検索機能**: 製品ID、バーコード値検索

#### 新規作成・編集機能（/master/cbcd_form）
- **製品選択**: プルダウンによる製品選択
- **バーコード検証**: フォーマット・重複チェック
- **出荷先管理**: 出荷先別バーコード設定

## 7. 加工集計グループマスタ（CPRG_MST）管理機能

### 7.1 機能概要

#### テーブル構造
- **CPRG_ID**: グループID（主キー）
- **CPRG_NM**: グループ名
- **CPRG_FLG**: フラグ（0:有効、9:削除）

#### システム特徴
- **集計機能**: レポート用グループ分類
- **加工分析**: 加工状況の集計・分析
- **動的グループ**: 必要に応じたグループ追加

### 7.2 加工集計グループマスタCRUD機能

#### 一覧表示機能（/total/processing_matrix_cprg）
- **グループ別表示**: 加工状況のマトリックス表示
- **集計データ**: グループ別加工件数・金額集計
- **フィルタリング**: 期間・グループ絞り込み

#### 新規作成・編集機能
- **グループ定義**: グループ名・条件設定
- **集計ルール**: 集計対象・計算方法設定
- **表示制御**: レポート表示順序設定

## 8. 共通機能

### 8.1 データ検証機能
- **必須項目チェック**: NULL値・空文字チェック
- **参照整合性**: 外部キー制約確認
- **重複チェック**: 主キー・ユニーク制約確認

### 8.2 論理削除機能
- **フラグ管理**: FLG=9による削除状態管理
- **削除前チェック**: 参照データ存在確認
- **復元機能**: 削除フラグ解除による復元

### 8.3 エラーハンドリング
- **トランザクション管理**: 一貫性保持
- **エラーログ**: 詳細なエラー情報記録
- **ユーザー通知**: わかりやすいエラーメッセージ

## 9. 関連ファイル・設定

### 9.1 主要実装ファイル
- **ルーティング**: `app/routes_master.py`
- **データモデル**: `app/models_master.py`
- **集計処理**: `app/routes_total.py`

### 9.2 テンプレートファイル
- **区分マスタ**: `app/templates/master/kbn_list.html`, `app/templates/master/kbn_form.html`
- **製品マスタ**: `app/templates/master/prd_list.html`, `app/templates/master/prd_form.html`
- **取引先マスタ**: `app/templates/master/cztr_list.html`, `app/templates/master/cztr_form.html`
- **加工マスタ**: `app/templates/master/cprc_list.html`, `app/templates/master/cprc_form.html`
- **バーコードマスタ**: `app/templates/master/cbcd_list.html`, `app/templates/master/cbcd_form.html`
- **加工集計**: `app/templates/total/processing_matrix_cprg.html`

### 9.3 データベース関連
- **テーブル作成**: `sql/CREATE_KBN_MST.sql`, `sql/CREATE_PRD_MST.sql`, `sql/CREATE_CZTR_MST.sql`, `sql/CREATE_CPRC_MST.sql`, `sql/CREATE_CBCD_MST.sql`, `sql/CREATE_CPRG_MST.sql`
- **制約・インデックス**: 主キー制約、外部キー制約、ユニーク制約

---

**作成日**: 2025年7月  
**更新日**: 2025年7月  
**バージョン**: 1.0  
**対象システム**: BFZaiko在庫管理システム（マスタ管理機能）