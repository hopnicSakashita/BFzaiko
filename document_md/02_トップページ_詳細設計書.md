# BFトップページ（受注残一覧）詳細設計書

## 1. 画面概要

### 画面名
BFトップページ（受注残一覧）

### 画面目的
**バイフォーカル（BF）レンズ専用**の受注残数を製品・取引先・加工種別ごとに集計して一覧表示し、BF在庫管理の状況を把握できるダッシュボード機能を提供する。

### システム位置づけ
- **BFセクション**のメイン画面（ナビゲーション「BF」配下）
- BF規格マスタ（BFSP_MST）を基準とした専用ダッシュボード
- 一般システムとは独立したBF専用管理画面

### アクセス情報
- **URL**: `/`
- **HTTPメソッド**: GET
- **認証**: 必須（@login_required）

## 2. 業務概要

### 主要業務
1. **BF受注残データ**の自動集計・表示
2. **BF製品規格別**（ベース・加入度数・L/R・色）での分類表示
3. **BF取引先別**（コロンバス・ダラス・ヤンガー・ヤンガーEU）での受注残表示
4. **BF加工種別**（NC：ノンコート、HC：ハードコート）での分類表示
5. **BF在庫数**の表示（NC在庫・HC在庫）

### 表示条件
- BF受注残または在庫が0より大きいもののみ表示
- 未出荷の有効なBF受注データのみ対象（BRCP_FLG = 0）
- BF製品規格のソート順（BFSP_SORT）に基づく表示順序

### 業務上の重要性
- **BFシステム全体**の受注状況と在庫状況を一元把握するダッシュボード
- BF在庫管理と出荷計画の基礎となる重要な情報源
- BF取引先別・加工種別での受注残バランスの可視化
- **一般システムとは独立**したBF専用の業務状況監視機能

## 3. 処理フロー

### 3.1 メイン処理フロー
```
1. ユーザーがトップページ（/）にアクセス
   ↓
2. @login_required デコレータで認証チェック
   ↓
3. routes.py の index() 関数実行
   ↓
4. BrcpDat.get_order_summary() メソッド呼び出し
   ↓
5. 受注残データの集計処理実行
   ↓
6. index.html テンプレートをレンダリング
   ↓
7. 受注残一覧表示
```

### 3.2 受注残集計処理フロー（BrcpDat.get_order_summary()）
```
1. データベースセッション取得
   ↓
2. CTEを使った複雑なSQLクエリ実行
   ├─ OrderSummary CTE: 受注残数集計
   │  ├─ BRCP_DAT（受注データ）から未出荷データ抽出
   │  ├─ Get_ODR_ZAN_Qty_BF()で受注残計算
   │  └─ 製品ID・加工区分・受注会社でグループ化
   │
   └─ StockSummary CTE: 在庫数集計
      ├─ BPRD_DAT（製造データ）から在庫数抽出
      ├─ Get_Zaiko_Qty_BF()で在庫数計算
      └─ 製品ID・加工区分でグループ化
   ↓
3. メインクエリで結合・集計
   ├─ BFSP_MST（製品マスタ）をベースにLEFT JOIN
   ├─ 取引先別・加工種別での集計
   └─ BFSP_SORT順での並び替え
   ↓
4. 結果を辞書形式で整形して返却
```

## 4. 画面レイアウト

### 4.1 画面構造
```
├── base.html（共通テンプレート）
│   ├── 共通ヘッダー（ナビゲーション）
│   ├── サイドメニュー
│   └── メインコンテンツエリア
│       ├── ページタイトル「受注残一覧」
│       └── 受注残データ一覧テーブル
```

### 4.2 受注残一覧テーブル
```
┌──────┬──────┬──────┬──────┬──────┬──────┬──────┬──────┬──────┬──────┬──────┬──────┬──────┐
│製品ID│ベース│加入度数│ L/R │ 色  │NC在庫│HC在庫│ｺﾛﾝﾊﾞｽ│ダラス│ｺﾛﾝﾊﾞｽ│ダラス│ヤンガー│ヤンガー │
│      │      │      │     │     │     │     │NC残 │NC残 │HC残 │HC残 │HC残  │EU_HC残│
├──────┼──────┼──────┼──────┼──────┼──────┼──────┼──────┼──────┼──────┼──────┼──────┼──────┤
│ 1001 │  2   │ 150  │  L  │ BR  │  50 │  20 │  30 │  15 │  20 │  10 │   5  │   0   │
│ 1002 │  4   │ 200  │  R  │ SG  │   0 │  30 │   0 │  25 │  35 │   5 │   0  │  10   │
└──────┴──────┴──────┴──────┴──────┴──────┴──────┴──────┴──────┴──────┴──────┴──────┴──────┘
```

## 5. データ項目

### 5.1 表示項目

#### 製品情報
- **製品ID** (prd_id)
  - データソース: BFSP_MST.BFSP_PRD_ID
  - 表示形式: 4桁の製品識別子
  - 例: "1001", "1002"

- **ベース** (base)
  - データソース: BFSP_MST.BFSP_BASE
  - 表示形式: 数値（1桁）
  - 意味: レンズのベースカーブ

- **加入度数** (adp)
  - データソース: BFSP_MST.BFSP_ADP
  - 表示形式: 数値（3桁）
  - 単位: 度数（例：150 = 1.50D）

- **L/R** (lr)
  - データソース: BFSP_MST.BFSP_LR
  - 表示形式: 文字（"L" または "R"）
  - 意味: 左右区分

- **色** (clr)
  - データソース: BFSP_MST.BFSP_CLR
  - 表示形式: 2文字コード
  - 例: "BR"（ブラウン）、"SG"（グレー）

#### 在庫情報
- **NC在庫** (nc_stock)
  - データソース: BPRD_DAT（Get_Zaiko_Qty_BF関数経由）
  - 表示形式: 数値（0以上）、バッジ形式（緑：在庫あり、グレー：在庫なし）
  - 意味: ノンコート在庫数

- **HC在庫** (hc_stock)
  - データソース: BPRD_DAT（Get_Zaiko_Qty_BF関数経由）
  - 表示形式: 数値（0以上）、バッジ形式（緑：在庫あり、グレー：在庫なし）
  - 意味: ハードコート在庫数

#### 受注残情報（取引先・加工種別）
- **コロンバスNC残** (nc_c)
  - データソース: BRCP_DAT（Get_ODR_ZAN_Qty_BF関数経由）
  - 条件: 受注会社=501 AND 加工区分=0
  - 表示形式: 数値（0以上）

- **ダラスNC残** (nc_d)
  - データソース: BRCP_DAT（Get_ODR_ZAN_Qty_BF関数経由）
  - 条件: 受注会社=502 AND 加工区分=0
  - 表示形式: 数値（0以上）

- **コロンバスHC残** (hc_c)
  - データソース: BRCP_DAT（Get_ODR_ZAN_Qty_BF関数経由）
  - 条件: 受注会社=501 AND 加工区分=1
  - 表示形式: 数値（0以上）

- **ダラスHC残** (hc_d)
  - データソース: BRCP_DAT（Get_ODR_ZAN_Qty_BF関数経由）
  - 条件: 受注会社=502 AND 加工区分=1
  - 表示形式: 数値（0以上）

- **ヤンガーHC残** (hc_y)
  - データソース: BRCP_DAT（Get_ODR_ZAN_Qty_BF関数経由）
  - 条件: 受注会社=503 AND 加工区分=1
  - 表示形式: 数値（0以上）

- **ヤンガーEU_HC残** (hc_y_eu)
  - データソース: BRCP_DAT（Get_ODR_ZAN_Qty_BF関数経由）
  - 条件: 受注会社=504 AND 加工区分=1
  - 表示形式: 数値（0以上）

## 6. 業務ルール

### 6.1 表示条件
- 受注残数または在庫数が0より大きい製品のみ表示
- 並び順: BFSP_MST.BFSP_SORT の昇順
- 表示対象: 未出荷の受注データ（BRCP_FLG = 0）

### 6.2 データ計算ルール
- **受注残数計算**: SQL Server関数 `Get_ODR_ZAN_Qty_BF()` 使用
- **在庫数計算**: SQL Server関数 `Get_Zaiko_Qty_BF()` 使用
- **集計単位**: 製品ID × 加工区分 × 受注会社

### 6.3 取引先・加工区分定数
- **コロンバス**: ORDER_CMP_COLUMBUS (501)
- **ダラス**: ORDER_CMP_DALLAS (502)
- **ヤンガー**: ORDER_CMP_YOUNGER (503)
- **ヤンガーEU**: ORDER_CMP_YOUNGER_EU (504)
- **ノンコート**: PROC_NON_COAT (0)
- **ハードコート**: PROC_HARD_COAT (1)

## 7. エラーハンドリング

### 7.1 エラーパターン
- **データベース接続エラー**: SQLAlchemyエラー
- **SQL実行エラー**: クエリ実行時のエラー
- **認証エラー**: 未ログイン時のアクセス

### 7.2 エラーハンドリング方法
- **ログ出力**: log_error()関数でエラー詳細を記録
- **エラー表示**: HTTP 500エラーでエラー内容を表示
- **セッション管理**: finally節で必ずセッションクローズ
- **認証制御**: @login_required による自動リダイレクト

## 8. 関連ファイル・関数

### 8.1 主要ファイル
- **ルーティング**: `app/routes.py` - `index()` 関数
- **テンプレート**: `app/templates/index.html`
- **ベーステンプレート**: `app/templates/base.html`
- **モデル**: `app/models.py` - `BrcpDat` クラス

### 8.2 主要関数・メソッド
- **index()**: メインルーティング関数
- **BrcpDat.get_order_summary()**: 受注残・在庫集計メソッド
- **@login_required**: 認証制御デコレータ

### 8.3 データベーステーブル（BFシステム専用）
- **BRCP_DAT**: BF受注データテーブル
- **BPRD_DAT**: BF製造データテーブル
- **BFSP_MST**: BF規格マスタテーブル（BF専用製品仕様）

### 8.4 一般システムとの棲み分け
- **BFシステム**: BFSP_MST基準、バイフォーカル専用仕様
- **一般システム**: PRD_MST基準、汎用製品対応
- **データ独立性**: 各システムで独立したテーブル構成

### 8.4 SQL関数
- **Get_ODR_ZAN_Qty_BF()**: 受注残数量計算関数
- **Get_Zaiko_Qty_BF()**: 在庫数量計算関数

### 8.5 定数ファイル
- **app/constants.py**: DatabaseConstants クラス
  - 取引先定数（ORDER_CMP_*）
  - 加工区分定数（PROC_*）
  - フラグ定数（BRCP_FLG_*）

## 9. UI仕様

### 9.1 スタイル仕様
- **フレームワーク**: Bootstrap 5
- **テーブル**: table-bordered, table-hover
- **在庫バッジ**: bg-success（在庫あり）、bg-secondary（在庫なし）
- **フォントサイズ**: 0.9rem（読みやすさ重視）

### 9.2 レスポンシブ対応
- **table-responsive**: 横スクロール対応
- **container-fluid**: 全幅使用
- **モバイル対応**: 小画面でもテーブル表示可能

---

**作成日**: 2025年7月  
**更新日**: 2025年7月  
**バージョン**: 1.0  
**対象システム**: BFZaiko在庫管理システム