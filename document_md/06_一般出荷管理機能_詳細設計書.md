# 一般出荷管理機能 詳細設計書

## 1. 機能概要

### 機能名
一般出荷管理機能（汎用出荷システム）

### 機能目的
**一般製品（BF以外）**の出荷業務を効率的に管理するため、出荷区分（出荷・加工・欠損）による多目的管理と、入庫から出荷までの一連のワークフローを提供する。

### システム位置づけ
- **一般セクション**の中核機能（ナビゲーション「一般」配下）
- 一般専用データテーブル（CSHK_DAT、CPRD_DAT、PRD_MST）を使用
- BF出荷管理（/shipments）とは独立したシステム

### 主要機能
1. **一般出荷一覧画面**: 一般出荷データの検索・一覧表示・PDF出力
2. **入庫データ管理**: 一般製品の入庫データ作成・編集・一覧表示
3. **加工依頼管理**: 加工会社への依頼データ管理
4. **在庫詳細・集計表示**: 製品・ランク別の在庫管理
5. **出荷データ作成**: 入庫データからの出荷データ作成

## 2. 一般出荷一覧画面

### 2.1 画面概要

#### アクセス情報
- **URL**: `/common/shipment_list`
- **HTTPメソッド**: GET
- **認証**: 必須（@login_required）
- **ナビゲーション**: 一般 > 出荷一覧

#### 画面目的
一般出荷データの検索・一覧表示により、一般製品の出荷状況把握と管理業務の効率化を図る。

### 2.2 処理フロー

#### メイン処理フロー
```
1. 一般出荷一覧画面アクセス（/common/shipment_list）
   ↓
2. 認証チェック（@login_required）
   ↓
3. 検索条件パラメータ取得
   ├─ 出荷日範囲（date_from, date_to）
   ├─ 手配日範囲（ord_date_from, ord_date_to）
   └─ 出荷先ID（cshk_to）
   ↓
4. 一般出荷検索実行（ShipmentCommon.get_shipment_list()）
   ↓
5. 検索結果表示
   ├─ 一般出荷一覧テーブル表示
   ├─ PDF出力機能
   ├─ バーコード生成機能
   └─ 削除機能（条件付き）
```

#### 一般出荷検索処理フロー（ShipmentCommon.get_shipment_list()）
```
1. データベースセッション取得
   ↓
2. 一般専用テーブル結合クエリ構築
   ├─ CSHK_DAT（一般出荷データ）をベースとする
   ├─ CPRD_DAT（一般入庫データ）とLEFT JOIN
   ├─ PRD_MST（製品マスタ）とLEFT JOIN
   ├─ KBN_MST（区分マスタ）とLEFT JOIN（ランク名取得）
   └─ CZTR_MST（取引先マスタ）とLEFT JOIN
   ↓
3. 出荷区分による絞り込み
   ├─ CSHK_KBN = 0（出荷）のみ対象
   └─ 検索条件による動的フィルタリング
   ↓
4. 並び順設定（出荷日降順）
   ↓
5. 一般出荷検索結果返却
```

### 2.3 データ項目

#### 検索条件項目
- **出荷日（開始）**: CSHK_DAT.CSHK_DT（日付入力）
- **出荷日（終了）**: CSHK_DAT.CSHK_DT（日付入力）
- **手配日（開始）**: CSHK_DAT.CSHK_ORD_DT（日付入力）
- **手配日（終了）**: CSHK_DAT.CSHK_ORD_DT（日付入力）
- **出荷先**: CSHK_DAT.CSHK_TO（セレクトボックス）

#### 表示項目
- **出荷ID**: CSHK_DAT.CSHK_ID
- **手配日**: CSHK_DAT.CSHK_ORD_DT
- **出荷日**: CSHK_DAT.CSHK_DT
- **出荷先**: CZTR_MST.CZTR_NM
- **製品名**: PRD_MST.PRD_DSP_NM
- **LOT**: CPRD_DAT.CPDD_LOT
- **分割番号**: CPRD_DAT.CPDD_SPRIT1/CPDD_SPRIT2
- **ランク**: KBN_MST.KBN_NM（ランク名）
- **出荷数**: CSHK_DAT.CSHK_QTY
- **操作**: 削除ボタン（削除可能な場合のみ）

### 2.4 業務ルール
- 全検索条件は任意項目（空白での全件検索可能）
- 出荷区分が「出荷」（CSHK_KBN=0）のデータのみ表示
- 出荷日降順での並び替え（最新データ優先表示）
- 削除可能条件: 出荷区分=出荷 かつ フラグ=有効

## 3. 出荷区分による管理システム

### 3.1 出荷区分定義

#### 出荷区分の種類
```python
# constants.py より
CSHK_KBN_SHIPMENT = 0    # 出荷
CSHK_KBN_PROCESS = 1     # 加工
CSHK_KBN_LOSS = 2        # 欠損
```

#### 3.1.1 出荷（CSHK_KBN=0）
- **目的**: 得意先への実際の製品出荷
- **必須項目**: CSHK_TO（出荷先ID）
- **管理画面**: 一般出荷一覧（/common/shipment_list）
- **業務フロー**: 入庫 → 出荷
- **データ紐付け**: 受注データとの照合（任意）

#### 3.1.2 加工（CSHK_KBN=1）
- **目的**: 加工会社への加工依頼
- **必須項目**: CSHK_PRC_ID（加工ID）
- **管理画面**: 加工依頼一覧（/common/process_request_list）
- **業務フロー**: 入庫 → 加工依頼 → 加工戻り → 新入庫
- **データ紐付け**: 加工戻りデータ（CPRC_DAT）との照合

#### 3.1.3 欠損（CSHK_KBN=2）
- **目的**: 在庫欠損・破損の記録
- **必須項目**: なし（出荷先・加工ID不要）
- **管理画面**: 出荷一覧（欠損として表示）
- **業務フロー**: 入庫 → 欠損記録
- **データ紐付け**: なし

### 3.2 加工管理ワークフロー

#### 加工依頼から戻りまでの流れ
```
1. 入庫データ作成（CPRD_DAT）
   ↓
2. 加工依頼作成（CSHK_DAT, CSHK_KBN=1）
   ├─ CSHK_PRC_ID（加工会社ID）指定
   └─ CSHK_PDD_ID（入庫データID）紐付け
   ↓
3. 加工依頼PDF出力・送付
   ↓
4. 加工戻りデータ登録（CPRC_DAT）
   ├─ CPCD_SHK_ID（加工依頼ID）紐付け
   ├─ 合格数量・不合格数量記録
   └─ ランク分類情報
   ↓
5. 合格分の新入庫データ自動作成（CPRD_DAT）
```

## 4. 入庫データ管理機能

### 4.1 機能概要

#### アクセス情報
- **一覧URL**: `/common/cprd_dat_list`
- **作成URL**: `/common/cprd_dat_create`
- **編集URL**: `/common/cprd_dat_edit/<int:cpdd_id>`
- **ナビゲーション**: 一般 > 入庫データ一覧

#### 機能目的
一般製品の入庫データを管理し、出荷・加工の基準データとして活用する。

### 4.2 データ項目

#### 入庫データ（CPRD_DAT）
- **入庫ID**: CPDD_ID（主キー、自動採番）
- **製品ID**: CPDD_PRD_ID（PRD_MST.PRD_ID）
- **LOT番号**: CPDD_LOT（6桁数値）
- **分割番号1**: CPDD_SPRIT1（2桁数値）
- **分割番号2**: CPDD_SPRIT2（2桁数値）
- **ランク**: CPDD_RANK（2桁数値、KBN_MST連携）
- **数量**: CPDD_QTY（5桁数値）
- **フラグ**: CPDD_FLG（0:有効、1:無効）
- **加工データID**: CPDD_PCD_ID（CPRC_DAT.CPCD_ID）

### 4.3 業務ルール
- **LOT管理**: 製品ID + LOT + 分割番号での一意管理
- **ランク分類**: KBN_MST（区分マスタ）によるランク名管理
- **在庫計算**: 入庫数量 - 出荷数量合計 = 在庫残数
- **加工連携**: 加工戻りデータからの自動入庫データ作成

## 5. データベース設計（一般専用）

### 5.1 主要テーブル

#### CSHK_DAT（一般出荷データテーブル）
```sql
CREATE TABLE CSHK_DAT (
    CSHK_ID decimal(10) identity(1,1),    -- 出荷ID（主キー）
    CSHK_KBN decimal(1),                  -- 出荷区分（0:出荷,1:加工,2:欠損）
    CSHK_TO decimal(3),                   -- 出荷先ID
    CSHK_PRC_ID decimal(10),              -- 加工ID
    CSHK_PRD_ID varchar(5),               -- 製品ID
    CSHK_DT datetime2,                    -- 出荷日
    CSHK_ORD_DT datetime2,                -- 手配日
    CSHK_PDD_ID decimal(10),              -- 入庫ID（CPRD_DAT.CPDD_ID）
    CSHK_RCP_ID decimal(10),              -- 受注ID
    CSHK_QTY decimal(5),                  -- 出荷数量
    CSHK_FLG decimal(1),                  -- フラグ（0:有効,1:無効）
    PRIMARY KEY (CSHK_ID)
);
```

#### CPRD_DAT（一般入庫データテーブル）
```sql
CREATE TABLE CPRD_DAT (
    CPDD_ID decimal(10) identity(1,1),    -- 入庫ID（主キー）
    CPDD_PRD_ID varchar(5),               -- 製品ID（PRD_MST.PRD_ID）
    CPDD_LOT decimal(6),                  -- LOT番号
    CPDD_SPRIT1 decimal(2),               -- 分割番号1
    CPDD_SPRIT2 decimal(2),               -- 分割番号2
    CPDD_RANK decimal(2),                 -- ランク
    CPDD_QTY decimal(5),                  -- 入庫数量
    CPDD_FLG decimal(1),                  -- フラグ（0:有効,1:無効）
    CPDD_PCD_ID decimal(10),              -- 加工データID（CPRC_DAT.CPCD_ID）
    PRIMARY KEY (CPDD_ID)
);
```

#### 関連テーブル（一般専用）
- **PRD_MST**: 製品マスタテーブル（一般製品情報）
- **KBN_MST**: 区分マスタテーブル（ランク情報）
- **CZTR_MST**: 取引先マスタテーブル（出荷先・加工先情報）
- **CPRC_DAT**: 加工戻りデータテーブル

### 5.2 重要なSQL関数（一般専用）
- **Get_CPRD_ZAN_Qty(CPDD_ID)**: 一般在庫残数計算
- **Get_CSHK_PRC_ZAN_Qty(CSHK_ID)**: 加工残数計算

### 5.3 フラグ定義
- **CSHK_FLG**: 0=有効、1=無効
- **CPDD_FLG**: 0=有効、1=無効

## 6. BF出荷管理との違い

### 6.1 一般出荷管理（汎用システム）
- **データテーブル**: CSHK_DAT、CPRD_DAT、PRD_MST（一般製品用）
- **機能**: 汎用的な出荷管理、出荷区分による多目的管理
- **URL**: `/common/shipment_list`、`/common/*`
- **実装ファイル**: `routes_common.py`、`shipment_common.py`
- **製品マスタ**: PRD_MST（製品マスタ）
- **特徴**: 入庫→出荷、加工ワークフロー、ランク管理

### 6.2 BF出荷管理（専用システム）
- **データテーブル**: BSHK_DAT、BPRD_DAT、BRCP_DAT（BF専用）
- **機能**: BFレンズ特化、ノンコート/ハードコート管理
- **URL**: `/shipments`、`/shipping/*`
- **実装ファイル**: `routes.py`、`shipment.py`
- **製品マスタ**: BFSP_MST（BF規格マスタ）
- **特徴**: 受注→製造→出荷、BF専用規格管理

### 6.3 主要相違点
1. **データ構造**: 一般テーブルとBF専用テーブルの完全分離
2. **業務フロー**: 入庫ベース vs 受注ベース
3. **管理粒度**: LOT・ランク管理 vs BF規格管理
4. **出荷区分**: 多目的利用 vs 出荷専用
5. **加工管理**: 加工ワークフロー vs コート処理

## 7. 関連ファイル・関数

### 7.1 主要ファイル
- **ルーティング**: `app/routes_common.py`
  - `shipment_list()` - 出荷一覧表示
  - `cprd_dat_list()` - 入庫データ一覧
  - `process_request_list()` - 加工依頼一覧
  - `stock_detail()` - 在庫詳細表示
  - `stock_summary()` - 在庫集計表示

- **モデル**: `app/shipment_common.py` - `ShipmentCommon`クラス（一般専用）
- **テンプレート**: 
  - `app/templates/common/common_shipment_list.html`
  - `app/templates/common/cprd_dat_list.html`
  - `app/templates/common/process_request_list.html`
  - `app/templates/common/common_stock_detail.html`
  - `app/templates/common/common_stock_summary.html`

### 7.2 JavaScript機能
- **日付入力制御**: 開始日≦終了日の相互制御
- **Ajax削除処理**: 確認ダイアログ付き削除機能
- **検索条件保持**: セッションストレージによる検索条件復元

### 7.3 定数ファイル
- **app/constants.py**: DatabaseConstants クラス
  - CSHK_KBN_*（出荷区分定数）
  - 一般出荷管理専用の定数定義

## 8. UI仕様

### 8.1 一般出荷一覧画面
- **検索フォーム**: 日付範囲・出荷先によるフィルタリング
- **一覧テーブル**: Bootstrap table-hover、responsive対応
- **操作ボタン**: PDF出力、バーコード生成、削除（条件付き表示）

### 8.2 レスポンシブ対応
- **Bootstrap 5**: モバイル対応
- **table-responsive**: 横スクロール対応
- **動的UI**: JavaScript による操作性向上

### 8.3 ユーザビリティ
- **検索条件保持**: ページ遷移後の検索条件復元
- **日付入力支援**: カレンダーウィジェット、入力制御
- **エラー表示**: 統一されたアラート表示機能

---

**作成日**: 2025年7月  
**更新日**: 2025年7月  
**バージョン**: 1.0  
**対象システム**: BFZaiko在庫管理システム（一般専用）