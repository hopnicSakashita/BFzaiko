# BF受注データ入力画面 詳細設計書

## 1. 画面概要

### 画面名
受注データ入力画面

### 画面目的
眼鏡レンズの受注データを新規登録または既存データを更新する。出荷先・受注日・客先注文番号・加工種別を指定して、製品ごとの受注数量を入力・管理する。

### アクセス情報
- **URL**: `/order_input`
- **HTTPメソッド**: GET, POST
- **認証**: 必須（@login_required）

## 2. 業務概要

### 主要業務
1. 受注ヘッダー情報の入力（出荷先、受注日、客先注文番号、加工種別）
2. 既存受注データの検索・表示
3. 製品別受注数量の入力・編集
4. 受注データの新規登録・更新・削除
5. 画面状態の動的制御（入力可/不可の切り替え）

### 業務上の重要性
- 受注から出荷までの業務フローの起点となる重要な画面
- 在庫管理と出荷計画の基礎となる受注データの正確な入力
- 取引先別・加工種別での受注管理による効率的な業務運営

### 重要な業務ルール
- 同一の受注条件（出荷先+受注日+客先注文番号+加工種別）は1件のみ
- 既存データがある場合は上書き更新
- 数量が0の製品は自動削除
- 出荷先ID=601（加工宛）は選択不可
- 出荷済みデータの変更制限（出荷済み確認後エラー表示）

## 3. 処理フロー

### 3.1 メイン処理フロー
```
1. 画面アクセス（/order_input）
   ↓
2. 認証チェック（@login_required）
   ↓
3. order_input()関数実行
   ↓
4. マスタデータ取得
   ├─ CZTR_MST取得（出荷先一覧）
   └─ BFSP_MST取得（製品一覧）
   ↓
5. GET: テンプレートレンダリング（初期表示）
   POST: フォームデータ処理
   ↓
6. ヘッダー入力 → 「表示」ボタンクリック
   ↓
7. /api/orders/search API呼び出し（BrcpDat.search実行）
   ↓
8. 既存データ検索・表示
   ↓
9. 数量入力 → 「登録」ボタンクリック
   ↓
10. /api/orders/save API呼び出し（BrcpDat.save実行）
   ↓
11. データベース保存・トランザクション制御
```

### 3.2 既存データ検索処理フロー（BrcpDat.search()）
```
1. 入力データ検証
   ├─ 必須項目チェック（受注日、客先注文番号、加工種別、出荷先）
   └─ データ型チェック
   ↓
2. 既存データ検索SQL実行
   ├─ BRCP_DATテーブル検索
   ├─ 検索条件: 受注日+客先注文番号+加工種別+出荷先
   └─ 製品別数量データ取得
   ↓
3. 検索結果処理
   ├─ exists: 既存データ有無判定（boolean）
   └─ details: 製品別数量データリスト
   ↓
4. JSON形式で結果返却
```

### 3.3 受注データ保存処理フロー（BrcpDat.save()）
```
1. トランザクション開始（session.begin()）
   ↓
2. 製品別保存処理ループ
   ├─ 既存データ確認（BRCP_DAT検索）
   ├─ 出荷済みチェック（dbo.Get_ODR_ZAN_Qty_BF関数使用）
   └─ データ更新分岐処理
   ↓
3. 更新分岐ロジック
   ├─ 既存データ+数量>0: UPDATE処理
   ├─ 既存データ+数量=0: DELETE処理
   ├─ 新規データ+数量>0: INSERT処理
   └─ 新規データ+数量=0: 処理対象外
   ↓
4. トランザクション制御
   ├─ 全件成功: commit
   └─ エラー発生: rollback + エラー返却
```

## 4. 画面レイアウト

### 4.1 画面構造
```
├── base.html（共通テンプレート）
│   ├── 共通ヘッダー（ナビゲーション）
│   ├── サイドメニュー
│   └── メインコンテンツエリア
│       ├── ページタイトル「受注データ入力」
│       ├── 受注ヘッダー入力セクション
│       ├── 操作ボタンセクション
│       └── 製品別数量入力テーブル
```

### 4.2 受注ヘッダー入力セクション
```
┌─────────────────────────────────────────────────────────────┐
│                    受注データ入力                           │
├─────────────────────────────────────────────────────────────┤
│ 出荷先: [取引先選択ドロップダウン▼]                         │
│ 受注日: [日付入力_____] (YYYY-MM-DD形式)                    │
│ 客先注文番号: [テキスト入力_________________]                │
│ 加工種別: ○ノンコート ○ハードコート                       │
│                                                             │
│ [表示] [キャンセル] [登録]                                  │
└─────────────────────────────────────────────────────────────┘
```

### 4.3 製品別数量入力テーブル
```
┌──────┬──────┬──────┬──────┬──────┬──────────┐
│製品ID│ベース│加入度数│ L/R │ 色  │ 受注数量  │
├──────┼──────┼──────┼──────┼──────┼──────────┤
│ 1001 │  2   │ 150  │  L  │ BR  │[___]     │
│ 1002 │  4   │ 200  │  R  │ SG  │[___]     │
│ 1003 │  6   │ 225  │  L  │ BR  │[___]     │
└──────┴──────┴──────┴──────┴──────┴──────────┘
```

## 5. データ項目

### 5.1 入力項目（ヘッダー情報）

#### 出荷先
- **項目名**: order_cmp
- **データソース**: CZTR_MST.CZTR_ID
- **データ型**: INTEGER
- **入力方式**: ドロップダウンリスト選択
- **必須/任意**: 必須
- **制約**: ID=601（加工宛）は選択不可

#### 受注日
- **項目名**: order_date
- **データソース**: BRCP_DAT.BRCP_DT
- **データ型**: DATE
- **入力方式**: 日付入力フィールド
- **必須/任意**: 必須
- **フォーマット**: YYYY-MM-DD

#### 客先注文番号
- **項目名**: order_no
- **データソース**: BRCP_DAT.BRCP_ORDER_NO
- **データ型**: VARCHAR(20)
- **入力方式**: テキスト入力フィールド
- **必須/任意**: 必須

#### 加工種別
- **項目名**: proc
- **データソース**: BRCP_DAT.BRCP_PROC
- **データ型**: INTEGER
- **入力方式**: ラジオボタン
- **必須/任意**: 必須
- **選択肢**: 0（ノンコート）、1（ハードコート）

### 5.2 入力項目（明細情報）

#### 製品ID
- **表示項目**: prd_id
- **データソース**: BFSP_MST.BFSP_PRD_ID
- **表示形式**: 4桁の製品識別子
- **編集可否**: 表示のみ

#### 受注数量
- **項目名**: quantity
- **データソース**: BRCP_DAT.BRCP_QTY
- **データ型**: INTEGER
- **入力方式**: 数値入力フィールド
- **必須/任意**: 任意（0の場合は削除）
- **範囲**: 0以上の整数

### 5.3 表示項目（製品詳細）

#### ベース、加入度数、L/R、色
- **データソース**: BFSP_MST各項目
- **表示形式**: 製品識別用の参考情報
- **編集可否**: 表示のみ

## 6. 業務ルール

### 6.1 受注データ一意性ルール
- **一意キー**: 出荷先 + 受注日 + 客先注文番号 + 加工種別
- **制約**: 同一条件の受注データは1件のみ存在可能
- **動作**: 既存データがある場合は上書き更新

### 6.2 数量管理ルール
- **数量0**: 自動的にデータ削除（DELETE処理）
- **数量>0**: データ登録・更新（INSERT/UPDATE処理）
- **未入力**: 0として扱う

### 6.3 出荷済みデータ制御ルール
- **出荷済み確認**: dbo.Get_ODR_ZAN_Qty_BF関数で受注残数確認
- **制約**: 受注残数≠受注数量の場合、変更不可
- **エラーメッセージ**: 「出荷済みのため変更できません」

### 6.4 出荷先制限ルール
- **制限対象**: 出荷先ID=601（加工宛）
- **制約**: 選択肢から除外
- **理由**: 業務フロー上、直接入力不可

## 7. API仕様

### 7.1 受注データ検索API
- **URL**: `/api/orders/search`
- **メソッド**: POST
- **Content-Type**: application/json

#### リクエスト
- **order_date**: 受注日（YYYY-MM-DD形式）
- **order_no**: 客先注文番号（文字列）
- **proc**: 加工種別（0=ノンコート、1=ハードコート）
- **order_cmp**: 出荷先ID（数値）

#### レスポンス（成功時）
- **exists**: 既存データ有無（true/false）
- **details**: 製品別数量データの配列
  - prd_id: 製品ID
  - quantity: 受注数量

#### レスポンス（エラー時）
- **error**: エラーメッセージ（文字列）

### 7.2 受注データ保存API
- **URL**: `/api/orders/save`
- **メソッド**: POST
- **Content-Type**: application/json

#### リクエスト
- **order_date**: 受注日（YYYY-MM-DD形式）
- **order_no**: 客先注文番号（文字列）
- **proc**: 加工種別（0=ノンコート、1=ハードコート）
- **order_cmp**: 出荷先ID（数値）
- **details**: 製品別数量データの配列
  - prd_id: 製品ID
  - quantity: 受注数量（0の場合は削除対象）

#### レスポンス（成功時）
- **success**: 処理成功フラグ（true）
- **message**: 成功メッセージ（文字列）

## 8. エラーハンドリング

### 8.1 入力エラーパターン
- **必須項目未入力**: 「必須項目を入力してください」
- **日付形式エラー**: 「正しい日付形式で入力してください（YYYY-MM-DD）」
- **数量範囲エラー**: 「数量は0以上の整数で入力してください」

### 8.2 業務エラーパターン
- **出荷済みデータ変更**: 「この受注データは既に出荷済みのため変更できません」
- **データベースエラー**: 「データベース処理でエラーが発生しました」
- **トランザクションエラー**: 「データ保存に失敗しました」

### 8.3 エラーハンドリング方法
- **APIレベル**: JSON形式でエラー情報返却
- **画面レベル**: AppAlerts.showError()でモーダル表示
- **ログレベル**: log_error()でサーバーログ出力
- **トランザクション**: 自動rollbackによるデータ整合性保証

## 9. JavaScript実装

### 9.1 主要関数

#### handleDisplay()
- **機能**: 受注データ検索処理
- **処理内容**: /api/orders/search API呼び出し
- **結果処理**: 検索結果を数量入力フィールドに反映
- **エラー処理**: 検索エラー時の適切なメッセージ表示

#### handleSave()
- **機能**: 受注データ保存処理
- **処理内容**: /api/orders/save API呼び出し
- **結果処理**: 保存結果に応じたメッセージ表示
- **エラー処理**: 保存エラー時の適切なエラーハンドリング

#### disableHeaderInputs()
- **機能**: ヘッダー項目の入力不可制御
- **目的**: 数量入力中のデータ整合性確保
- **制御対象**: 出荷先、受注日、客先注文番号、加工種別の入力フィールド

### 9.2 UI制御機能
- **2重送信防止**: ボタン無効化による制御
- **入力フォーカス制御**: 数量入力フィールドのフォーカス/ブラー
- **動的バリデーション**: リアルタイム入力チェック

## 10. 関連ファイル・関数

### 10.1 主要ファイル
- **ルーティング**: `app/routes.py` - `order_input()`, `search_order()`, `save_order()`
- **テンプレート**: `app/templates/order_input.html`
- **モデル**: `app/models.py` - `BrcpDat`クラス

### 10.2 データベーステーブル
- **BRCP_DAT**: 受注データテーブル（メイン）
- **CZTR_MST**: 取引先マスタテーブル
- **BFSP_MST**: BF規格マスタテーブル

### 10.3 SQL関数
- **dbo.Get_ODR_ZAN_Qty_BF()**: 受注残数量計算関数

### 10.4 定数ファイル
- **app/constants.py**: DatabaseConstants クラス
  - PROC_NON_COAT, PROC_HARD_COAT
  - BRCP_FLG_NOT_SHIPPED
  - SHIPMENT_TO_PROCESS

---

**作成日**: 2025年7月  
**更新日**: 2025年7月  
**バージョン**: 1.0  
**対象システム**: BFZaiko在庫管理システム