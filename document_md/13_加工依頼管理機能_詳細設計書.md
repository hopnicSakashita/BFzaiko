# 加工依頼管理機能 詳細設計書

## 1. 機能概要

### 機能名
加工依頼管理機能（一般加工依頼システム）

### 機能目的
**一般製品の加工依頼業務**を効率的に管理するため、加工依頼データの検索・表示・管理と、加工戻りデータの作成・編集・削除機能を提供する。

### システム位置づけ
- **共通機能セクション**の中核機能（ナビゲーション「共通」配下）
- 一般加工依頼データテーブル（CSHK_DAT、CPRC_DAT）を使用
- 加工依頼（CSHK_KBN=1）と出荷（CSHK_KBN=0）を区別した管理

### 主要機能
1. **加工依頼一覧画面**: 加工依頼データの多条件検索・一覧表示・PDF出力
2. **加工戻りデータ作成画面**: 加工依頼からの戻りデータの作成・一括登録・編集・削除
3. **API機能群**: 加工戻りデータ一覧取得・在庫状況確認
4. **在庫管理連携**: 加工戻りデータから作成された製造データの在庫管理

## 2. 加工依頼一覧画面

### 2.1 画面概要

#### アクセス情報
- **URL**: `/common/process_request_list`
- **HTTPメソッド**: GET（初期表示・検索実行）
- **認証**: 必須（@login_required）
- **ナビゲーション**: 共通 > 加工依頼一覧

#### 画面目的
加工依頼データ（CSHK_KBN=1）の多条件検索・一覧表示により、加工依頼状況の把握と管理業務の効率化を図る。

### 2.2 処理フロー

#### メイン処理フロー
```
1. 加工依頼一覧画面アクセス（/common/process_request_list）
   ↓
2. 認証チェック（@login_required）
   ↓
3. GET: 初期画面表示（検索フォーム表示）
   GET: 検索実行（search=1パラメータ）
   ↓
4. 検索条件パラメータ処理
   ├─ 日付範囲（date_from, date_to）
   ├─ 製品ID（prd_id）
   ├─ 加工ID（prc_id）
   └─ 加工先ID（cztr_id）
   ↓
5. マスタデータ取得
   ├─ 製品マスタ（PRD_MST）
   ├─ 加工マスタ（CPRC_MST）
   └─ 取引先マスタ（CZTR_MST）- 加工会社のみ
   ↓
6. 加工依頼検索実行（ShipmentCommon.get_process_request_list()）
   ↓
7. 検索結果表示
   ├─ 加工依頼一覧テーブル表示
   ├─ PDF出力ボタン表示
   └─ 戻り入力ボタン表示（未完了の場合）
```

#### 加工依頼検索処理フロー（ShipmentCommon.get_process_request_list()）
```
1. データベースセッション取得
   ↓
2. 加工依頼専用テーブル結合クエリ構築
   ├─ CSHK_DAT（出荷データ）をベースとする
   ├─ CPRD_DAT（製造データ）とLEFT JOIN
   ├─ PRD_MST（製品マスタ）とLEFT JOIN
   ├─ KBN_MST（区分マスタ）とLEFT JOIN（ランク名取得）
   ├─ CPRC_MST（加工マスタ）とLEFT JOIN
   ├─ CZTR_MST（取引先マスタ）とLEFT JOIN
   └─ Get_CSHK_PRC_ZAN_Qty関数で戻り残数計算
   ↓
3. 加工依頼専用条件での動的WHERE句生成
   ├─ CSHK_KBN = 1（加工依頼区分）
   ├─ 加工依頼日範囲による絞り込み
   ├─ 製品IDによる絞り込み
   ├─ 加工IDによる絞り込み
   └─ 加工先IDによる絞り込み
   ↓
4. 並び順設定（加工依頼日降順）
   ↓
5. 加工依頼検索結果返却
```

#### 加工依頼検索データ抽出条件
- **基本結合条件**:
  - CSHK_DAT.CSHK_PDD_ID = CPRD_DAT.CPDD_ID（製造IDで結合）
  - CPRD_DAT.CPDD_PRD_ID = PRD_MST.PRD_ID（製品IDで結合）
  - CPRD_DAT.CPDD_RANK = KBN_MST.KBN_NO（ランクで結合）
  - CSHK_DAT.CSHK_PRC_ID = CPRC_MST.CPRC_ID（加工IDで結合）
  - CPRC_MST.CPRC_TO = CZTR_MST.CZTR_ID（加工先で結合）
- **動的検索条件**:
  - 加工依頼区分: CSHK_DAT.CSHK_KBN = 1
  - 加工依頼日開始: CSHK_DAT.CSHK_DT >= :date_from
  - 加工依頼日終了: CSHK_DAT.CSHK_DT <= :date_to
  - 製品ID: CSHK_DAT.CSHK_PRD_ID = :prd_id
  - 加工ID: CSHK_DAT.CSHK_PRC_ID = :prc_id
  - 加工先ID: CPRC_MST.CPRC_TO = :cztr_id
- **並び順**: CSHK_DAT.CSHK_DT DESC（加工依頼日降順）

### 2.3 データ項目

#### 検索条件項目
- **加工依頼日（開始）**: CSHK_DAT.CSHK_DT（日付入力）
- **加工依頼日（終了）**: CSHK_DAT.CSHK_DT（日付入力）
- **製品ID**: CSHK_DAT.CSHK_PRD_ID（セレクトボックス）
- **加工名**: CSHK_DAT.CSHK_PRC_ID（セレクトボックス）
- **加工先**: CPRC_MST.CPRC_TO（セレクトボックス）

#### 表示項目
- **依頼ID**: CSHK_DAT.CSHK_ID
- **加工依頼日**: CSHK_DAT.CSHK_DT
- **製品ID**: CSHK_DAT.CSHK_PRD_ID
- **依頼数量**: CSHK_DAT.CSHK_QTY（バッジ表示）
- **加工名**: CPRC_MST.CPRC_NM
- **加工先**: CZTR_MST.CZTR_NM
- **戻り残数**: Get_CSHK_PRC_ZAN_Qty関数（色分けバッジ表示）
- **操作**: 戻り入力ボタン（CSHK_FLG=0の場合のみ）

### 2.4 業務ルール
- 全検索条件は任意項目（空白での全件検索可能）
- 加工依頼日降順での並び替え（最新データ優先表示）
- 戻り残数の色分け表示（0=緑、>0=黄、エラー=赤）
- 戻り入力ボタンは未完了（CSHK_FLG=0）の場合のみ表示
- PDF出力は検索条件を引き継いで実行

## 3. 加工戻りデータ作成機能

### 3.1 画面概要

#### アクセス情報
- **表示URL**: `/common/cprc_dat/<int:cshk_id>/create`
- **保存URL**: `/common/cprc_dat`（POST）
- **更新URL**: `/common/cprc_dat/update`（POST）
- **削除URL**: `/common/cprc_dat/delete`（POST）
- **認証**: 必須（@login_required）
- **ナビゲーション**: 加工依頼一覧 > 戻り入力ボタン

#### 画面目的
加工依頼からの戻りデータ作成。一括登録・編集・削除機能付き。

### 3.2 画面構成（3つの情報セクション）

**1. 出荷データ情報セクション**
- **表示項目**: 出荷ID、製品ID、製品名、LOT、ランク、出荷数量、戻っていない残数、出荷日、加工名
- **データソース**: CSHK_DAT（出荷データ）、CPRD_DAT（製造データ）、PRD_MST（製品マスタ）、KBN_MST（区分マスタ）、CPRC_MST（加工マスタ）
- **抽出条件**: 
  - CSHK_DAT.CSHK_ID = :cshk_id（指定された出荷ID）
  - CSHK_DAT.CSHK_KBN = 1（加工依頼区分）
  - 戻っていない残数: Get_CSHK_PRC_ZAN_Qty関数で計算
- **目的**: 加工依頼の詳細情報確認と戻り残数把握

**2. 加工戻りデータ入力セクション**
- **動的フォーム**: 行追加・削除機能
- **入力項目**: 戻り日、戻り数、戻り不良数、検品不良数、合格数（自動計算）
- **バリデーション**: 必須項目チェック、数値範囲チェック、数量整合性チェック
- **自動計算**: 合格数 = 戻り数 - 戻り不良数 - 検品不良数

**3. 加工戻りデータ一覧セクション**
- **表示項目**: ID、戻り日、戻り数、戻り不良数、検品不良数、合格数、操作
- **操作機能**: 編集ボタン、削除ボタン
- **データソース**: CPRC_DAT（加工データ）

### 3.3 処理フロー

#### 画面表示処理フロー
```
1. 出荷IDを指定して加工戻りデータ作成画面アクセス
   ↓
2. 出荷データ存在確認（ShipmentCommon.get_by_cshk_id_with_details()）
   ↓
3. 加工依頼区分チェック（CSHK_KBN = 1）
   ↓
4. 戻っていない残数取得（ShipmentCommon.get_prc_zan_qty()）
   ↓
5. 画面表示（出荷データ情報 + 入力フォーム + 既存データ一覧）
```

#### データ作成処理フロー（一括登録）
```
1. フォームデータ収集（JavaScript）
   ↓
2. クライアントサイドバリデーション
   ├─ 必須項目チェック（戻り日、戻り数）
   ├─ 数値範囲チェック（1-99999）
   └─ 数量整合性チェック
   ↓
3. 各データを順次登録（Promise.all）
   ├─ /common/cprc_dat（POST）
   ├─ CprcDatModel.create()
   └─ エラーハンドリング
   ↓
4. 製造データ自動作成処理
   ├─ 合格数 > 0 の場合のみ実行
   ├─ 加工マスタから加工後製品ID取得
   ├─ 元の製造データからランク情報取得
   ├─ 戻り日をYYMMDD形式でLOT番号生成
   └─ CPRD_DATに新規製造データ作成
   ↓
5. 登録結果表示
   ├─ 成功件数・失敗件数表示
   ├─ エラー詳細表示
   └─ 一覧更新
```

#### データ更新処理フロー
```
1. 編集ボタンクリック
   ↓
2. モーダル表示（既存データ設定）
   ↓
3. データ更新実行
   ├─ /common/cprc_dat/update（POST）
   ├─ CprcDatModel.update()
   ├─ 関連製造データ更新処理
   │  ├─ CPCD_PCD_IDで関連製造データ検索
   │  ├─ 製造データの出荷状況チェック
   │  └─ 未出荷の場合のみ数量更新
   └─ エラーハンドリング
   ↓
4. 更新結果表示・一覧更新
```

#### データ削除処理フロー
```
1. 削除ボタンクリック
   ↓
2. 確認ダイアログ表示
   ↓
3. データ削除実行
   ├─ /common/cprc_dat/delete（POST）
   ├─ CprcDatModel.delete()
   ├─ 関連製造データ削除処理
   │  ├─ CPCD_PCD_IDで関連製造データ検索
   │  ├─ 製造データの出荷状況チェック
   │  └─ 未出荷の場合のみ削除実行
   └─ エラーハンドリング
   ↓
4. 削除結果表示・一覧更新
```

### 3.4 データ項目

#### 入力項目
- **戻り日**: CPCD_DATE（日付入力、必須）
- **戻り数**: CPCD_QTY（数値入力、必須、1-99999）
- **戻り不良数**: CPCD_RET_NG_QTY（数値入力、0-99999）
- **検品不良数**: CPCD_INS_NG_QTY（数値入力、0-99999）
- **合格数**: CPCD_PASS_QTY（自動計算、読み取り専用）

#### 表示項目
- **出荷ID**: CSHK_DAT.CSHK_ID
- **製品ID**: CSHK_DAT.CSHK_PRD_ID
- **製品名**: PRD_MST.PRD_DSP_NM
- **LOT**: CPRD_DAT.CPDD_LOT
- **ランク**: KBN_MST.KBN_NM
- **出荷数量**: CSHK_DAT.CSHK_QTY
- **戻っていない残数**: Get_CSHK_PRC_ZAN_Qty関数
- **出荷日**: CSHK_DAT.CSHK_DT
- **加工名**: CPRC_MST.CPRC_NM

### 3.5 業務ルール
- 戻り日は必須項目（今日の日付がデフォルト）
- 戻り数は1から99999の範囲で入力
- 戻り不良数・検品不良数は0から99999の範囲で入力
- 合格数は自動計算（戻り数 - 戻り不良数 - 検品不良数）
- **合格数 > 0 の場合、自動的に製造データ（CPRD_DAT）を作成**
  - 加工マスタ（CPRC_MST）の加工後製品ID（CPRC_AF_PRD_ID）を使用
  - 元の製造データからランク情報を継承
  - 戻り日をYYMMDD形式でLOT番号を自動生成
  - 分割番号1、2は0で初期化
- **加工戻りデータ削除時は関連製造データも連動削除**
  - CPCD_PCD_IDで関連製造データを特定
  - 製造データが未出荷の場合のみ削除実行
  - 既に出荷済みの場合は削除不可
- **加工戻りデータ更新時は関連製造データも連動更新**
  - 合格数変更時に製造データの数量を更新
  - 製造データが未出荷の場合のみ更新実行
  - 既に出荷済みの場合は更新不可
- 一括登録時は各行のデータを順次処理
- エラーが発生した場合は詳細を表示
- 編集・削除は既存データのみ可能

## 4. API機能群

### 4.1 加工戻りデータ一覧取得API

#### 機能概要
- **URL**: `/common/api/get_cprc_dat_list/<int:shk_id>`
- **HTTPメソッド**: GET
- **認証**: 必須（@login_required）
- **目的**: 出荷IDに関連する加工戻りデータ一覧を非同期取得

#### 処理フロー
```
1. 出荷IDパラメータ取得・検証
   ↓
2. CprcDatModel.get_by_shk_id()実行
   ↓
3. 加工戻りデータ一覧取得
   ↓
4. JSONレスポンス返却
   ├─ success: true/false
   ├─ data: 加工戻りデータ配列
   └─ error: エラーメッセージ（失敗時）
```

#### レスポンス形式
```json
{
  "success": true,
  "data": [
    {
      "CPCD_ID": 1,
      "CPCD_DATE": "2024-01-15",
      "CPCD_QTY": 100,
      "CPCD_RET_NG_QTY": 5,
      "CPCD_INS_NG_QTY": 3,
      "CPCD_PASS_QTY": 92
    }
  ]
}
```

### 4.2 在庫管理連携機能

#### 在庫詳細画面
- **URL**: `/common/stock_detail/<prd_id>/<rank>`
- **目的**: 加工戻りデータから作成された製造データ（CPRD_DAT）の在庫状況確認
- **表示項目**: 製品ID、ランク、LOT、在庫数量、製造日
- **データソース**: CprdDatModel.get_stock_detail()

#### 在庫集計一覧画面
- **URL**: `/common/stock_summary`
- **目的**: 製品・ランク別の在庫数量集計表示
- **集計項目**: 製品名、ランク名、在庫数量、製造データ件数
- **データソース**: CprdDatModel.get_stock_summary()

#### 業務上の重要性
- **加工完了確認**: 加工戻りデータから作成された製造データの在庫状況を確認
- **次工程準備**: 加工後の製品が在庫として利用可能かどうかの確認
- **在庫管理**: 加工依頼管理と在庫管理の連携による業務効率化

## 5. PDF出力機能

### 5.1 機能概要
- **URL**: `/common/process_request_pdf`
- **HTTPメソッド**: GET
- **認証**: 必須（@login_required）
- **出力形式**: PDF

### 5.2 処理フロー
```
1. PDF出力リクエスト（検索条件引き継ぎ）
   ↓
2. 検索条件パラメータ処理
   ├─ 日付範囲（date_from, date_to）
   ├─ 製品ID（prd_id）
   ├─ 加工ID（prc_id）
   └─ 加工先ID（cztr_id）
   ↓
3. PDF出力処理実行（export_pdf.py）
   ├─ 加工依頼データ取得
   ├─ PDFテンプレート適用
   └─ PDFファイル生成
   ↓
4. PDFレスポンス返却
```

### 5.3 出力項目
- **加工依頼一覧**: 依頼ID、加工依頼日、製品ID、依頼数量、加工名、加工先、戻り残数
- **検索条件**: 適用された検索条件の表示
- **出力日時**: PDF生成日時

## 6. データベース設計

### 6.1 主要テーブル

#### CSHK_DAT（出荷データ）
- **CSHK_ID**: 出荷ID（主キー）
- **CSHK_KBN**: 出荷区分（0=出荷、1=加工、2=欠損）
- **CSHK_PRD_ID**: 製品ID
- **CSHK_PDD_ID**: 製造ID
- **CSHK_PRC_ID**: 加工ID
- **CSHK_DT**: 出荷日
- **CSHK_QTY**: 数量
- **CSHK_FLG**: フラグ

#### CPRC_DAT（加工データ）
- **CPCD_ID**: 加工データID（主キー）
- **CPCD_SHK_ID**: 出荷ID（外部キー）
- **CPCD_DATE**: 戻り日
- **CPCD_QTY**: 戻り数
- **CPCD_RET_NG_QTY**: 戻り不良数
- **CPCD_INS_NG_QTY**: 検品不良数
- **CPCD_PASS_QTY**: 合格数

### 6.2 関連テーブル
- **CPRD_DAT**: 製造データ（LOT、ランク情報）
- **PRD_MST**: 製品マスタ（製品名）
- **KBN_MST**: 区分マスタ（ランク名）
- **CPRC_MST**: 加工マスタ（加工名）
- **CZTR_MST**: 取引先マスタ（加工先名）

### 6.3 ストアド関数
- **Get_CSHK_PRC_ZAN_Qty**: 加工戻り残数計算関数

### 6.4 製造データ自動作成ロジック

#### 作成条件
- 加工戻りデータの合格数（CPCD_PASS_QTY）> 0
- 加工マスタに加工後製品ID（CPRC_AF_PRD_ID）が設定されている

#### 作成データ項目
- **CPDD_PRD_ID**: CPRC_MST.CPRC_AF_PRD_ID（加工後製品ID）
- **CPDD_LOT**: 戻り日のYYMMDD形式（例：2024-01-15 → 240115）
- **CPDD_SPRIT1**: 0（固定）
- **CPDD_SPRIT2**: 0（固定）
- **CPDD_RANK**: 元の製造データ（CPRD_DAT）のランクを継承
- **CPDD_QTY**: 合格数（CPCD_PASS_QTY）
- **CPDD_FLG**: 0（有効）
- **CPDD_PCD_ID**: 作成された加工データID（CPCD_ID）

#### 処理フロー
```
1. 加工戻りデータ作成（CPRC_DAT）
   ↓
2. 合格数チェック（CPCD_PASS_QTY > 0）
   ↓
3. 加工マスタから加工後製品ID取得
   ↓
4. 元の製造データからランク情報取得
   ↓
5. 戻り日からLOT番号生成（YYMMDD形式）
   ↓
6. 新規製造データ作成（CPRD_DAT）
   ↓
7. 在庫として利用可能
```

## 7. エラーハンドリング

### 7.1 データベースエラー
- **OperationalError**: データベース接続エラー
- **SQLAlchemyError**: SQL実行エラー
- **ValueError**: データ変換エラー

### 7.2 バリデーションエラー
- **必須項目未入力**: 戻り日、戻り数
- **数値範囲エラー**: 1-99999の範囲外
- **数量整合性エラー**: 不良数合計が戻り数を超過
- **製造データ作成エラー**: 加工マスタに加工後製品IDが未設定
- **削除制限エラー**: 関連製造データが既に出荷済みのため削除不可
- **更新制限エラー**: 関連製造データが既に出荷済みのため更新不可

### 7.3 エラー表示
- **フラッシュメッセージ**: 画面表示用エラーメッセージ
- **JSONレスポンス**: API用エラーレスポンス
- **アラート表示**: JavaScript用エラーメッセージ

## 8. セキュリティ

### 8.1 認証・認可
- **@login_required**: 全機能でログイン必須
- **セッション管理**: Flask-Loginによるセッション管理

### 8.2 入力値検証
- **サーバーサイド**: SQLAlchemyによる型変換・バリデーション
- **クライアントサイド**: JavaScriptによる事前チェック

### 8.3 SQLインジェクション対策
- **パラメータ化クエリ**: SQLAlchemy ORM使用
- **プリペアドステートメント**: text()関数による安全なSQL実行

## 9. パフォーマンス

### 9.1 データベース最適化
- **インデックス**: 主要検索項目へのインデックス設定
- **JOIN最適化**: 必要なテーブルのみ結合
- **ページネーション**: 大量データ対応（将来拡張）

### 9.2 フロントエンド最適化
- **非同期処理**: JavaScriptによる一括登録
- **キャッシュ**: マスタデータのキャッシュ活用
- **レスポンシブデザイン**: モバイル対応

