# データ取込機能 詳細設計書

## 1. 機能概要

### 機能名
データ取込システム（Data Import System）

### 機能目的
外部システムや手作業で作成されたCSVファイル・Excelファイルからのデータ一括取込機能により、効率的なデータ入力と業務の自動化を実現する。

### システム位置づけ
- **データ入力基盤**: 大量データの効率的入力機能
- **業務自動化**: 手作業データ入力の削減
- **データ品質管理**: 取込時の検証・エラーハンドリング

### 主要取込機能
1. **ノンコートCSV取込**: ノンコート製造データの一括取込
2. **共通CSV取込**: 一般入庫データの取込
3. **バーコードCSV取込**: バーコードマスタの一括更新
4. **ハードコートExcel取込**: Excel形式の指示データ取込

## 2. 共通機能

### 2.1 ファイルアップロード処理

#### セキュリティ機能
- **ファイル名検証**: secure_filename()による安全化
- **ファイルサイズ制限**: 最大アップロードサイズ制御
- **MIME型チェック**: 許可された形式のみ受付

#### 一時ファイル管理
- **一時保存**: アップロードファイルの一時保存
- **自動削除**: 処理完了後の自動クリーンアップ
- **エラー時削除**: 処理失敗時の確実な削除

### 2.2 エンコーディング対応

#### 自動判定機能
- **UTF-8**: Unicode対応
- **Shift-JIS**: 日本語環境対応
- **BOM処理**: UTF-8 BOM自動除去

#### 変換処理
- **文字化け防止**: 適切なエンコーディング変換
- **エラー処理**: 変換不可文字のハンドリング

### 2.3 トランザクション管理

#### 一貫性保証
- **全件成功**: 全データ正常時のみコミット
- **部分成功**: エラー行スキップ、正常分のみ登録
- **全件失敗**: 致命的エラー時の全件ロールバック

#### エラー回復
- **リトライ機能**: 一時的エラーの自動再試行
- **手動リカバリ**: エラーデータの個別修正機能

### 2.4 エラーハンドリング

#### エラー分類
- **ファイルエラー**: 形式不正、エンコーディング不正
- **データエラー**: 必須項目不足、型変換エラー
- **ビジネスエラー**: 参照データ不存在、重複データ
- **一意制約エラー**: 重複データ検出、制約違反
- **システムエラー**: データベース接続エラー、権限エラー

#### エラー対応
- **行単位エラー**: エラー行スキップ、継続処理
- **致命的エラー**: 全体処理中断、ロールバック
- **エラーレポート**: 詳細なエラー情報提供

## 3. ノンコートCSV取込機能

### 3.1 機能概要

#### アクセス情報
- **URL**: `/import_csv`
- **テンプレート**: `app/templates/import_csv.html`
- **対象ファイル**: CSV形式（UTF-8, Shift-JIS対応）

#### 取込対象データ
- **BPRD_MEI**: 製造明細データ（詳細管理）
- **BPRD_DAT**: 製造データ（集計管理）
- **自動連携**: BPRD_MEI → BPRD_DAT集計更新

### 3.2 データ処理フロー

#### 取込処理ステップ
```
1. ファイルアップロード・検証
   ├─ ファイル形式チェック
   ├─ エンコーディング検出
   └─ ファイルサイズ制限確認
   ↓
2. CSV解析・データ抽出
   ├─ ヘッダー行検証
   ├─ データ型変換
   └─ 必須項目チェック
   ↓
3. ビジネスロジック検証
   ├─ BFSP_MST参照確認
   ├─ 重複データチェック
   └─ データ整合性確認
   ↓
4. データベース更新
   ├─ BPRD_MEI新規登録
   ├─ BPRD_DAT集計更新
   └─ トランザクション管理
   ↓
5. 結果レポート生成
```

### 3.3 CSV列構造とデータ抽出仕様

**必要列数**: 最低76列（75列目まで使用）

**主要列の抽出方法**:
- **1列目（row[0]）**: 製品情報文字列
  - 形式: `XXXXXXXXXX-XX-X`（例: 1234567890-12-1）
  - 製品ID抽出: 最初の4文字（`col1_value[:4]`）
  - ロット番号抽出: 5-10文字目（`col1_value[4:10]`）
  - 製造番号抽出: 12-13文字目 + 15-16文字目（`col1_value[11:13] + col1_value[15:16]`）

- **75列目（row[74]）**: 数量データ
  - 数値変換: `int(qty_value_75)`
  - 0の場合はスキップ
  - 正の値の場合のみBPRD_DAT・BPRD_MEIに登録

**データ変換処理**:
```
1列目文字列 → 製品ID・ロット番号・製造番号分解
75列目文字列 → 数量数値変換
```

### 3.4 データ変換・検証ルール

#### 必須項目検証
- **製品ID**: BFSP_MST参照確認
- **ロット番号**: 数値型・正の値チェック
- **数量**: 数値型・0以上チェック（75列目）

#### データ変換処理
- **文字列分割**: 1列目のハイフン区切り文字列分解
- **数値変換**: 文字列 → int型（数量・ロット番号・製造番号）
- **製品ID抽出**: 文字列位置指定による抽出（4文字）

### 3.5 一意制約管理

#### BPRD_MEI一意制約
- **制約項目**: BPDM_PRD_ID + BPDM_LOT + BPDM_NO
- **重複チェック**: 同一組み合わせの存在確認
- **重複時処理**: エラーとしてスキップ、重複カウント増加

#### BPRD_DAT集計処理
- **制約項目**: BPDD_PRD_ID + BPDD_LOT
- **既存データ処理**: 数量加算更新
- **新規データ処理**: 新規レコード作成

## 4. 共通CSV取込機能

### 4.1 機能概要

#### アクセス情報
- **URL**: `/common/csv_import_common`
- **テンプレート**: `app/templates/common/csv_import_common.html`
- **対象データ**: 一般入庫・出荷データ

#### 取込対象テーブル
- **CPRD_DAT**: 一般製品データ

### 4.2 データ処理フロー

#### 取込処理ステップ
```
1. ファイルアップロード・検証
   ├─ ファイル形式チェック
   ├─ エンコーディング検出
   └─ ファイルサイズ制限確認
   ↓
2. CSV解析・データ抽出
   ├─ ヘッダー行検証
   ├─ データ型変換
   └─ 必須項目チェック
   ↓
3. ビジネスロジック検証
   ├─ PRD_MST参照確認（製品区分=1のみ）
   ├─ 重複データチェック
   └─ データ整合性確認
   ↓
4. データベース更新
   ├─ CPRD_DAT新規登録（ランク別）
   └─ トランザクション管理
   ↓
5. 結果レポート生成
```

### 4.3 CSV列構造とデータ抽出仕様

**必要列数**: 最低76列（75列目・76列目を使用）

**主要列の抽出方法**:
- **1列目（row[0]）**: 製品情報文字列
  - 形式: `XXXXXXXXXX-XX-X`（例: 1234567890-12-1）
  - 製品ID抽出: 最初の4文字または5文字（文字列長による判定）
  - ロット番号抽出: 5-10文字目または6-11文字目
  - スプリット1抽出: ハイフン後の最初の数値
  - スプリット2抽出: ハイフン後の2番目の数値（存在しない場合は0）

- **75列目（row[74]）**: ランク1数量データ
  - 数値変換: `int(qty_value_75)`
  - CPDD_RANK = 1で登録

- **76列目（row[75]）**: ランク2数量データ
  - 数値変換: `int(qty_value_76)`
  - CPDD_RANK = 2で登録

**データ変換処理**:
```
1列目文字列 → 製品ID・ロット番号・スプリット値分解
75列目文字列 → ランク1数量数値変換
76列目文字列 → ランク2数量数値変換
```

### 4.4 データ変換・検証ルール

#### 必須項目検証
- **製品ID**: PRD_MST参照確認（製品区分=1のみ）
- **ロット番号**: 数値型・正の値チェック
- **数量**: 数値型・0以上チェック（75列目・76列目）

#### データ変換処理
- **文字列分割**: 1列目のハイフン区切り文字列分解
- **数値変換**: 文字列 → int型（数量・ロット番号・スプリット値）
- **製品ID抽出**: 文字列位置指定による抽出（4文字または5文字）

### 4.5 一意制約管理

#### CPRD_DAT一意制約
- **制約項目**: CPDD_PRD_ID + CPDD_LOT + CPDD_SPRIT1 + CPDD_SPRIT2 + CPDD_RANK
- **ランク別処理**: ランク1（75列目）・ランク2（76列目）で別レコード作成
- **重複チェック**: 同一組み合わせの存在確認
- **重複時処理**: エラーとしてスキップ、重複カウント増加

## 5. バーコードCSV取込機能

### 5.1 機能概要

#### アクセス情報
- **URL**: `/barcode_import`
- **テンプレート**: `app/templates/barcode_import.html`
- **対象ファイル**: CSV形式

#### 取込対象データ
- **BBCD_DAT**: バーコード取込テーブル
- **全件更新**: 既存データ削除後の新規登録

### 5.2 CSV列構造とデータ抽出仕様

**必要列数**: 最低3列

**主要列の抽出方法**:
- **1列目（row[0]）**: BBCD_ID（バーコードID）
  - 最大20文字
  - 必須項目

- **2列目（row[1]）**: BBCD_NO（バーコード番号）
  - 最大60文字

- **3列目（row[2]）**: BBCD_NM（バーコード名）
  - 最大30文字

### 5.3 データ変換・検証ルール

#### 必須項目検証
- **バーコードID**: 最大20文字制限
- **バーコード番号**: 最大60文字制限
- **バーコード名**: 最大30文字制限

### 5.4 一意制約管理

#### BBCD_DAT一意制約
- **制約項目**: BBCD_ID
- **事前処理**: 既存データ全件削除（DELETE FROM BBCD_DAT）
- **重複チェック**: 同一BBCD_IDの存在確認
- **重複時処理**: エラーとしてスキップ、重複カウント増加

## 6. ハードコートExcel取込機能

### 6.1 機能概要

#### アクセス情報
- **URL**: `/hardcoat_read_excel`
- **テンプレート**: `app/templates/hardcoat_read_excel.html`
- **対象ファイル**: Excel形式（.xlsx, .xls）

#### 取込対象データ
- **ハードコート指示データ**: 加工指示情報
- **数量・仕様情報**: 加工数量・仕様詳細
- **スケジュール情報**: 加工予定日・納期

### 6.2 Excel処理仕様

#### ワークシート構成
- **指示シート**: 加工指示メイン情報
- **詳細シート**: 明細データ（複数行対応）
- **設定シート**: 取込パラメータ設定

#### データ抽出ルール
- **固定セル**: 指定セル位置からの値取得
- **範囲データ**: 開始行から終了行までの一括取得
- **テンプレート検証**: 期待する形式との照合

### 6.3 データ変換・登録処理

#### 変換処理
- **Excel日付**: シリアル値 → 日付型変換
- **数式セル**: 計算結果値の取得
- **結合セル**: 左上セル値の使用

#### 登録処理
- **BPRD_DAT更新**: ハードコート加工区分での登録
- **BSHK_DAT連携**: 出荷データとの自動連携
- **製造番号採番**: システム自動採番

## 7. 一意制約チェック処理

### 7.1 共通処理フロー
```
1. SQL COUNT文による重複確認
   ├─ 対象テーブル指定
   ├─ 制約項目での絞り込み
   └─ 件数取得
   ↓
2. 重複判定
   ├─ 件数 > 0: 重複あり
   └─ 件数 = 0: 重複なし
   ↓
3. 重複時処理
   ├─ エラーメッセージ生成
   ├─ 重複カウント増加
   └─ 処理スキップ
   ↓
4. 新規データ処理
   ├─ 既存データ確認
   ├─ 更新または新規作成
   └─ データベース登録
```

## 8. 運用・監視機能

### 8.1 処理ログ

#### ログ出力内容
- **処理開始/終了**: タイムスタンプ付き処理状況
- **件数情報**: 処理件数・成功件数・エラー件数
- **エラー詳細**: エラー内容・発生行・対処方法

#### ログレベル管理
- **INFO**: 正常処理情報
- **WARNING**: 警告レベルのエラー
- **ERROR**: 致命的エラー

### 8.2 パフォーマンス最適化

#### バッチ処理
- **バルクインサート**: 大量データの効率的登録
- **バッチコミット**: 一定件数ごとのコミット実行
- **メモリ管理**: 大容量ファイルのストリーミング処理

#### 処理状況表示
- **プログレスバー**: 処理進捗のリアルタイム表示
- **処理時間表示**: 予想完了時間の算出

## 9. 関連ファイル・設定

### 9.1 主要実装ファイル
- **CSV取込**: `app/import_csv.py`
- **Excel取込**: `app/import_excel.py`
- **ルーティング**: `app/routes.py`, `app/routes_common.py`

### 9.2 テンプレートファイル
- **CSV取込**: `app/templates/import_csv.html`
- **Excel取込**: `app/templates/hardcoat_read_excel.html`
- **バーコード取込**: `app/templates/barcode_import.html`
- **共通CSV取込**: `app/templates/common/csv_import_common.html`

### 9.3 設定ファイル
- **アップロード設定**: Flask UPLOAD_FOLDER設定
- **ファイルサイズ制限**: MAX_CONTENT_LENGTH設定
- **エンコーディング設定**: デフォルト文字コード設定

### 9.4 依存ライブラリ
- **pandas**: CSV・Excel読み込み
- **openpyxl**: Excel操作
- **chardet**: エンコーディング自動判定

---

**作成日**: 2025年7月  
**更新日**: 2025年7月  
**バージョン**: 1.0  
**対象システム**: BFZaiko在庫管理システム（データ取込機能）