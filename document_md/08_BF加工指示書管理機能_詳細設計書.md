# BF加工指示書管理機能 詳細設計書

## 1. 機能概要

### 機能名
BF加工指示書管理機能（加工手配機能）

### 機能目的
**バイフォーカル（BF）レンズ**のハードコート加工工程において、指定出荷日の加工対象データを検索・一覧表示し、加工業者向けの指示書をExcel形式で出力することで、ノンコート在庫からハードコート加工への工程管理を効率化する。

### システム位置づけ
- **BFセクション**の製造管理機能（ナビゲーション「BF」> 加工手配）
- BSHK_DAT（BF出荷データ）から加工宛（出荷先ID=601）のデータ抽出
- ハードコート指図Excel出力による外部加工業者との連携基盤

### 主要機能
1. **加工指示書検索画面**: 出荷日指定による加工対象データ検索・一覧表示
2. **Excel出力機能**: ハードコート指図書のExcel形式自動生成・ダウンロード
3. **在庫連携**: BPRD_DAT（BF製造データ）との連携による正確な加工依頼数管理

## 2. 加工指示書検索・表示機能

### 2.1 画面概要

#### アクセス情報
- **URL**: `/proc_order`
- **HTTPメソッド**: GET, POST
- **認証**: 必須（@login_required）
- **ナビゲーション**: BF > 加工手配

#### 画面目的
指定出荷日におけるハードコート加工対象データの検索・一覧表示により、加工業者への依頼準備と工程管理を効率化する。

### 2.2 処理フロー

#### メイン処理フロー
```
1. 加工指示書画面アクセス（/proc_order）
   ↓
2. 認証チェック（@login_required）
   ↓
3. GET: 初期画面表示（検索フォーム表示）
   POST: 検索実行
   ↓
4. 検索条件取得・検証（ProcOrderSearchForm）
   ├─ 出荷日必須チェック
   ├─ 日付フォーマット検証（YYYY-MM-DD）
   └─ サーバーサイドバリデーション
   ↓
5. 加工対象データ検索（Shipment.get_by_dt_CT()）
   ├─ 出荷先ID = 601（加工宛）フィルタ
   ├─ 未出荷データ（BSHK_FLG = 0）のみ
   ├─ 指定出荷日のデータ抽出
   └─ BFSP_SORT順でソート
   ↓
6. 検索結果表示（proc_order.html）
   ├─ 加工対象データ一覧テーブル
   └─ Excel出力ボタン表示
```

#### 加工対象データ取得詳細
- **データ結合**: BSHK_DAT（出荷データ）、BFSP_MST（製品マスタ）、BPRD_DAT（製造データ）の3テーブル結合
- **抽出条件**: 
  - 指定出荷日の完全一致（CAST(BSHK_DT AS DATE) = :dt）
  - 出荷先ID = 601（加工宛）
  - 出荷フラグ = 0（未出荷）
- **並び順**: BFSP_SORT（製品規格ソート順）昇順
- **取得項目**: 出荷データ、製品仕様、製造ロット情報

### 2.3 データ項目

#### 検索条件項目
- **出荷日**: BSHK_DAT.BSHK_DT（日付入力、必須項目）

#### 表示項目
| 列名 | データソース | 型 | 業務的意味 |
|------|-------------|-------|-----------|
| LOT | BPRD_DAT.BPDD_LOT | decimal(6,0) | 製造ロット番号 |
| ベース | BFSP_MST.BFSP_BASE | decimal(1,0) | レンズベースカーブ |
| 加入度数 | BFSP_MST.BFSP_ADP | decimal(3,0) | 遠近両用度数 |
| L/R | BFSP_MST.BFSP_LR | varchar(1) | 左右識別 |
| 色 | BFSP_MST.BFSP_CLR | varchar(2) | 色コード（BR/SG等） |
| 加工依頼数 | BSHK_DAT.BSHK_QTY | decimal(5,0) | ハードコート加工数量 |

### 2.4 業務ルール
- **加工対象条件**: 出荷先ID = 601（DatabaseConstants.SHIPMENT_TO_PROCESS）
- **未出荷限定**: BSHK_FLG = 0（未出荷データのみ表示）
- **日付完全一致**: CAST(BSHK_DT AS DATE) での日付比較
- **並び順**: BFSP_SORT（製品規格ソート順）昇順で表示

## 3. Excel出力機能

### 3.1 機能概要

#### アクセス情報
- **URL**: `/proc_order_export_excel`
- **HTTPメソッド**: POST
- **認証**: 必須（@login_required）

#### 機能目的
検索結果データを加工業者向けのハードコート指図書Excel形式で出力し、外部加工工程との連携を効率化する。

### 3.2 処理フロー

#### Excel出力処理フロー
```
1. Excel出力リクエスト（/proc_order_export_excel）
   ↓
2. 検索条件再取得・データ検索
   ├─ 同じ出荷日条件でShipment.get_by_dt_CT()実行
   └─ データ存在チェック
   ↓
3. 一時作業環境準備
   ├─ tempfile.mkdtemp()で一時ディレクトリ作成
   └─ セキュリティ考慮のファイル管理
   ↓
4. Excel生成処理（write_to_proc_excel()）
   ├─ テンプレートファイル検証
   ├─ テンプレートコピー・ワークブック作成
   ├─ データ書き込み処理
   └─ ファイル保存
   ↓
5. ダウンロードレスポンス生成
   ├─ ファイル名: ハードコート指図_YYYYMMDD.xlsx
   ├─ MIMEタイプ設定（application/vnd.openxml...）
   └─ バイナリデータレスポンス
   ↓
6. リソースクリーンアップ
   ├─ 一時ファイル削除
   └─ 一時ディレクトリ削除
```

#### Excel生成処理詳細
- **テンプレート管理**: 環境変数PROC_EXCEL_PATHで指定されたテンプレートファイルを使用
- **ファイル操作**: テンプレートを一時ディレクトリにコピーして作業用ファイルを作成
- **シート管理**: 20行毎に新シートを作成し、原紙シートをコピーして使用
- **データ書き込み**: 指定された列に製品仕様、数量、ロット情報を順次書き込み
- **カゴ番号**: 自動連番で1から開始
- **最終処理**: 原紙シートを削除してファイルを保存

### 3.3 Excel出力仕様

#### テンプレート仕様
- **テンプレートファイル**: `EXCEL/ハードコート指図.xlsx`
- **環境変数**: `PROC_EXCEL_PATH`で指定可能
- **テンプレートシート**: 「原紙」シート使用
- **出力ファイル名**: `ハードコート指図_YYYYMMDD.xlsx`

#### データマッピング
| Excel列 | 項目名 | データソース | 備考 |
|---------|--------|-------------|------|
| A列 | カゴ番号 | 自動連番 | 1から開始 |
| B列 | ベース | BFSP_MST.BFSP_BASE | ベースカーブ値 |
| C列 | 加入度数 | BFSP_MST.BFSP_ADP | 遠近両用度数 |
| D列 | L/R | BFSP_MST.BFSP_LR | 左右識別 |
| E列 | 色 | BFSP_MST.BFSP_CLR | 色コード |
| F列 | 数量 | BSHK_DAT.BSHK_QTY | 加工依頼数量 |
| U列 | LOT | BPRD_DAT.BPDD_LOT | 製造ロット |
| V列 | 出荷ID | BSHK_DAT.BSHK_ID | トレーサビリティ用 |

#### シート分割仕様
- **書き込み開始行**: 5行目（ExcelConstants.WRITE_START_ROW）
- **最大行数**: 1シートあたり20行（ExcelConstants.MAX_ROWS_PER_SHEET）
- **シート名**: 1, 2, 3... （自動連番）
- **原紙シート**: データ書き込み完了後に削除

## 4. データベース連携

### 4.1 主要テーブル

#### BSHK_DAT（BF出荷データテーブル）
```sql
-- 加工指示書の基本データソース
SELECT BSHK_ID, BSHK_PRD_ID, BSHK_LOT, BSHK_QTY, BSHK_DT, BSHK_TO, BSHK_FLG
FROM BSHK_DAT
WHERE BSHK_TO = 601      -- 加工宛
  AND BSHK_FLG = 0       -- 未出荷
  AND CAST(BSHK_DT AS DATE) = '指定日'
```

#### BFSP_MST（BF規格マスタテーブル）
- 製品仕様情報（ベース、加入度数、L/R、色）
- BFSP_SORT による表示順序制御
- バーコード情報（BFSP_Y_BCD, BFSP_Y_GTIN）

#### BPRD_DAT（BF製造データテーブル）
- 製造ロット番号（BPDD_LOT）の提供
- 在庫数量計算の基盤データ
- 製造ID（BPDD_ID）による出荷データとの連携

### 4.2 在庫計算機能連携

#### Get_Zaiko_Qty_BF関数
- **機能**: BF在庫残数計算（SQL Server関数）
- **計算式**: 製造数量（BPDD_QTY） - 出荷数量合計（BSHK_QTY）
- **対象テーブル**: BPRD_DAT（製造データ）とBSHK_DAT（出荷データ）の結合
- **戻り値**: 在庫残数（0以上の数値）
- **用途**: 加工指示書での在庫確認、出荷可能数量の計算

## 5. BF系統と一般系統の区別

### 5.1 BF系統（加工指示書機能）
- **対象テーブル**: BSHK_DAT（BF出荷データ）
- **製品マスタ**: BFSP_MST（BF規格マスタ）
- **製造データ**: BPRD_DAT（BF製造データ）
- **加工工程**: ノンコート（PROC=0） → ハードコート（PROC=1）
- **出荷先**: 601（DatabaseConstants.SHIPMENT_TO_PROCESS）専用

### 5.2 一般系統
- **対象テーブル**: CSHK_DAT（一般出荷データ）
- **製品マスタ**: PRD_MST（製品マスタ）
- **製造データ**: CPRD_DAT（一般製造データ）
- **出荷区分**: 0=出荷、1=加工、2=欠損（DatabaseConstants.CSHK_KBN_*）
- **出荷先**: 複数の一般出荷先対応

## 6. バーコード機能との連携

### 6.1 トレーサビリティ管理
- **出荷ID出力**: Excel V列にBSHK_ID出力
- **LOT番号管理**: 製造ロットによる追跡可能性
- **製品識別**: BFSP_Y_BCD、BFSP_Y_GTIN活用

### 6.2 加工完了後連携
- 出荷IDによる加工完了データ照合
- バーコード読み取りによる実績更新
- 加工前後のデータ整合性チェック

## 7. エラーハンドリング

### 7.1 業務エラーパターン
- **日付エラー**: 不正な日付フォーマット、未来日指定
- **データ不存在**: 指定日に加工対象データなし
- **テンプレートエラー**: Excel テンプレートファイル不存在・破損

### 7.2 システムエラーパターン
- **ファイルI/Oエラー**: 一時ディレクトリ作成失敗、Excel 読み書きエラー
- **メモリエラー**: 大量データ処理時のメモリ不足
- **データベースエラー**: 接続エラー、SQL実行エラー

### 7.3 エラーハンドリング方法
- **テンプレートファイルエラー**: ファイル不存在時のエラーログ記録とユーザー通知
- **メモリエラー**: 大量データ処理時のメモリ不足エラーの適切な処理
- **予期しないエラー**: その他の例外発生時の包括的エラーハンドリング
- **リソースクリーンアップ**: 一時ディレクトリの確実な削除処理
- **ユーザー通知**: 各エラー種別に応じた適切なメッセージ表示と画面遷移

## 8. 関連ファイル・関数

### 8.1 主要ファイル
- **ルーティング**: `app/routes.py`
  - `proc_order()` (599-623行)
  - `proc_order_export_excel()` (625-668行)

- **業務ロジック**: `app/shipment.py`
  - `Shipment.get_by_dt_CT()` (157-188行)

- **Excel出力**: `app/export_excel.py`
  - `write_to_proc_excel()` (45-120行)

- **フォーム**: `app/forms.py`
  - `ProcOrderSearchForm` (175-178行)

- **テンプレート**: `app/templates/proc_order.html`

### 8.2 設定・データファイル
- **Excelテンプレート**: `EXCEL/ハードコート指図.xlsx`
- **環境変数**: `.env` - `PROC_EXCEL_PATH`
- **定数**: `app/constants.py`
  - `DatabaseConstants.SHIPMENT_TO_PROCESS` (601)
  - `ExcelConstants.WRITE_START_ROW` (5)
  - `ExcelConstants.MAX_ROWS_PER_SHEET` (20)

### 8.3 SQL関数
- **在庫計算**: `sql/Get_Zaiko_Qty_BF.sql`
- **受注残計算**: `sql/Get_ODR_ZAN_Qty_BF.sql`

---

**作成日**: 2025年7月  
**更新日**: 2025年7月  
**バージョン**: 1.0  
**対象システム**: BFZaiko在庫管理システム（BF専用）