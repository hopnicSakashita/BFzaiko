# BF出荷管理機能 詳細設計書

## 1. 機能概要

### 機能名
BF出荷管理機能（BF専用出荷システム）

### 機能目的
**バイフォーカル（BF）レンズ専用**の出荷業務を効率的に管理するため、BF特有の製造工程（ノンコート・ハードコート）に対応した出荷データの検索・表示・作成・削除機能を提供する。

### システム位置づけ
- **BFセクション**の中核機能（ナビゲーション「BF」配下）
- BF専用データテーブル（BSHK_DAT、BPRD_DAT、BRCP_DAT）を使用
- 一般出荷管理（/common/shipment_list）とは独立したシステム

### 主要機能
1. **BF出荷一覧画面**: BF出荷データの多条件検索・一覧表示・PDF出力
2. **BF出荷作成（ノンコート）**: ノンコート在庫からのBF出荷データ作成
3. **BF出荷作成（ハードコート）**: ハードコート在庫からのBF出荷データ作成
4. **ハードコート自動出荷**: ハードコート在庫の自動出荷機能
5. **BF出荷削除機能**: BF出荷データの削除と関連データ復旧

## 2. BF出荷一覧画面

### 2.1 画面概要

#### アクセス情報
- **URL**: `/shipments`
- **HTTPメソッド**: GET（初期表示）、POST（検索実行）
- **認証**: 必須（@login_required）
- **ナビゲーション**: BF > 出荷データ

#### 画面目的
BF出荷データの多条件検索・一覧表示により、BF出荷状況の把握と管理業務の効率化を図る。

### 2.2 処理フロー

#### メイン処理フロー
```
1. BF出荷一覧画面アクセス（/shipments）
   ↓
2. 認証チェック（@login_required）
   ↓
3. GET: 初期画面表示（検索フォーム表示）
   POST: 検索実行
   ↓
4. 検索条件フォーム処理
   ├─ ShipmentSearchForm バリデーション
   └─ BFマスタデータ取得（BFSP_MST選択肢生成）
   ↓
5. BF出荷検索実行（Shipment.search()）
   ↓
6. 検索結果表示
   ├─ BF出荷一覧テーブル表示
   ├─ PDF出力ボタン表示
   ├─ バーコード保存ボタン表示
   └─ 削除ボタン表示（削除可能な場合）
```

#### BF出荷検索処理フロー（Shipment.search()）
```
1. データベースセッション取得
   ↓
2. BF専用テーブル結合クエリ構築
   ├─ BSHK_DAT（BF出荷データ）をベースとする
   ├─ BPRD_DAT（BF製造データ）とJOIN
   ├─ BFSP_MST（BF規格マスタ）とJOIN
   ├─ BRCP_DAT（BF受注データ）とLEFT JOIN
   └─ CZTR_MST（取引先マスタ）とLEFT JOIN
   ↓
3. BF専用条件での動的WHERE句生成
   ├─ BF製品規格による絞り込み
   ├─ BFコーティング種別（NC/HC）による絞り込み
   └─ 日付範囲・部分一致検索対応
   ↓
4. 並び順設定（出荷日降順）
   ↓
5. BF出荷検索結果返却
```

#### BF出荷検索データ抽出条件
- **基本結合条件**:
  - BSHK_DAT.BSHK_PDD_ID = BPRD_DAT.BPDD_ID（製造IDで結合）
  - BPRD_DAT.BPDD_PRD_ID = BFSP_MST.BFSP_PRD_ID（製品IDで結合）
  - BSHK_DAT.BSHK_RCP_ID = BRCP_DAT.BRCP_ID（受注IDでLEFT JOIN）
  - BSHK_DAT.BSHK_TO = CZTR_MST.CZTR_ID（出荷先でLEFT JOIN）
- **動的検索条件**:
  - ベース: BFSP_MST.BFSP_BASE = :base
  - 加入度数: BFSP_MST.BFSP_ADP = :adp
  - L/R: BFSP_MST.BFSP_LR = :lr
  - 色: BFSP_MST.BFSP_CLR = :color
  - コーティング種別: BRCP_DAT.BRCP_PROC = :proc_type（NC/HC）
  - 出荷日: CAST(BSHK_DAT.BSHK_DT AS DATE) = :shipment_date
  - 出荷先: CZTR_MST.CZTR_ID = :destination
  - 受注番号: BRCP_DAT.BRCP_ORDER_NO = :order_no
  - 出荷ステータス: BSHK_DAT.BSHK_FLG = :shipment_status
  - 手配日: BSHK_DAT.BSHK_ORD_DT = :order_date
- **並び順**: BSHK_DAT.BSHK_DT DESC（出荷日降順）

### 2.3 データ項目

#### 検索条件項目（BF専用）
- **ベース**: BFSP_MST.BFSP_BASE（BF規格ベース）
- **加入度数**: BFSP_MST.BFSP_ADP（BF規格加入度数）
- **L/R**: BFSP_MST.BFSP_LR（BF規格L/R）
- **色**: BFSP_MST.BFSP_CLR（BF規格色）
- **コーティング**: BRCP_DAT.BRCP_PROC（ラジオボタン: NC/HC/全て）
- **出荷日**: BSHK_DAT.BSHK_DT（日付範囲）
- **出荷先**: BSHK_DAT.BSHK_TO（セレクトボックス）
- **受注番号**: BRCP_DAT.BRCP_ORDER_NO（テキスト入力）
- **出荷ステータス**: BSHK_DAT.BSHK_FLG（セレクトボックス）
- **手配日**: BSHK_DAT.BSHK_ORD_DT（日付範囲）

#### 表示項目（BF専用）
- **手配日**: BSHK_DAT.BSHK_ORD_DT
- **出荷日**: BSHK_DAT.BSHK_DT
- **出荷先**: CZTR_MST.CZTR_NM
- **客先注文番号**: BRCP_DAT.BRCP_ORDER_NO
- **LOT**: BPRD_DAT.BPDD_LOT（BF製造LOT）
- **ベース・加入度数・L/R・色**: BFSP_MST各項目（BF規格）
- **出荷数**: BSHK_DAT.BSHK_QTY
- **コート日**: BPRD_DAT.BPDD_CRT（ハードコートの場合）
- **コーティング**: BRCP_DAT.BRCP_PROC（NC/HC表記）
- **出荷状況**: BSHK_DAT.BSHK_FLG（日本語変換表示）
- **操作**: 削除ボタン（削除可能な場合のみ）

### 2.4 業務ルール（BF専用）
- 全検索条件は任意項目（空白での全件検索可能）
- 出荷日降順での並び替え（最新データ優先表示）
- BF出荷ステータスの日本語表示（DatabaseConstants.SHIPMENT_STATUS_LABELS使用）
- 削除可能条件: 加工前（BSHK_FLG < BSHK_FLG_PROCESSED）

## 3. BF出荷作成機能

### 3.1 BF出荷作成（ノンコート）

#### アクセス情報
- **表示URL**: `/shipping/create/<int:stock_id>`
- **保存URL**: `/shipping/save/<int:stock_id>`
- **認証**: 必須（@login_required）
- **ナビゲーション**: NC在庫検索 > 出荷ボタン

#### 画面目的
BFノンコート在庫からの出荷データ作成。BF受注残との照合機能付き。

#### 画面構成（4つの情報セクション）

**1. 在庫情報セクション**
- **表示項目**: ベース、加入度数、L/R、カラー、LOT、在庫数
- **データソース**: BFSP_MST（製品仕様）、BPRD_DAT（在庫情報）
- **抽出条件**: 
  - BPRD_DAT.BPDD_ID = :stock_id（指定された在庫ID）
  - BPRD_DAT.BPDD_PRD_ID = BFSP_MST.BFSP_PRD_ID（製品IDで結合）
  - 在庫数: Get_Zaiko_Qty_BF(BPDD_ID)関数で計算
- **目的**: 出荷対象在庫の詳細情報確認

**2. 受注残情報セクション（2分割表示）**
- **ノンコート受注残**: BFノンコート受注残一覧
  - **抽出条件**:
    - BPRD_DAT.BPDD_ID = :stock_id（指定された在庫ID）
    - BPRD_DAT.BPDD_PRD_ID = BRCP_DAT.BRCP_PRD_ID（製品IDで結合）
    - BRCP_DAT.BRCP_PROC = :brcp_proc_noncoat（ノンコート受注）
    - BRCP_DAT.BRCP_FLG = :brcp_flg_not_shipped（未出荷）
    - Get_ODR_ZAN_Qty_BF(BRCP_ID) > 0（受注残あり）
    - 並び順: BRCP_DT, BRCP_ORDER_NO（受注日、注文番号順）
- **ハードコート受注残**: BFハードコート受注残一覧
  - **抽出条件**:
    - BPRD_DAT.BPDD_ID = :stock_id（指定された在庫ID）
    - BPRD_DAT.BPDD_PRD_ID = BRCP_DAT.BRCP_PRD_ID（製品IDで結合）
    - BRCP_DAT.BRCP_PROC = :brcp_proc_hardcoat（ハードコート受注）
    - BRCP_DAT.BRCP_FLG = :brcp_flg_not_shipped（未出荷）
    - Get_ODR_ZAN_Qty_BF(BRCP_ID) > 0（受注残あり）
    - 並び順: BRCP_DT, BRCP_ORDER_NO（受注日、注文番号順）
- **表示項目**: 受注日、注文番号、出荷先、数量
- **データソース**: BRCP_DAT（受注データ）、CZTR_MST（取引先）
- **目的**: 出荷先決定時の参考情報提供

**3. 加工指図セクション**
- **表示項目**: 加工指図日付、加工指図数量、LOT
- **データソース**: BSHK_DAT（加工指図データ）
- **抽出条件**:
  - BPRD_DAT.BPDD_PRD_ID = :prd_id（製品ID）
  - BSHK_DAT.BSHK_PDD_ID = BPRD_DAT.BPDD_ID（製造IDで結合）
  - BSHK_DAT.BSHK_TO = :ship_to（出荷先=加工先）
  - BSHK_DAT.BSHK_FLG = :bshk_flg_not_shipped（未出荷）
- **目的**: 加工履歴の確認と出荷計画の参考

**4. 出荷情報入力セクション**
- **動的フォーム**: 出荷先追加・削除機能
- **入力項目**: 出荷先、出荷日、手配日、数量
- **バリデーション**: 必須項目チェック、数量制限
- **出荷先データ**: CZTR_MST全件取得（get_shipping_destinations()）

#### 処理フロー
```
1. BF在庫IDを指定して出荷作成画面アクセス
   ↓
2. BF在庫情報取得（Shipment.get_stock_info()）
   ├─ BF在庫数量確認（Get_Zaiko_Qty_BF関数）
   └─ BF製品仕様情報取得（BFSP_MST）
   ↓
3. BF受注残情報取得
   ├─ BFノンコート受注残（Shipment.get_noncoat_orders()）
   └─ BFハードコート受注残（Shipment.get_hardcoat_orders()）
   ↓
4. BF関連情報取得
   ├─ BF出荷先マスタ（Shipment.get_shipping_destinations()）
   └─ BF加工指図履歴（Shipment.get_proc_order()）
   ↓
5. BF出荷作成フォーム表示
   ↓
6. ユーザー入力・送信
   ↓
7. BF出荷データ保存処理（save_shipping()）
```

#### BF出荷データ保存処理フロー
```
1. トランザクション開始
   ↓
2. BF入力データ検証
   ├─ 出荷数量合計 ≤ BF在庫数量チェック
   └─ 必須項目入力チェック
   ↓
3. BF出荷データ作成ループ（出荷先ごと）
   ├─ BSHK_DAT レコード作成（BF出荷データ）
   ├─ FIFO方式によるBF受注データ紐付け
   └─ BF在庫フラグ更新（出荷済み設定）
   ↓
4. BF関連データ更新
   ├─ BF受注フラグ更新（出荷済み設定）
   └─ BF在庫フラグ更新（完全出荷時）
   ↓
5. トランザクションコミット
```

### 3.2 BF出荷作成（ハードコート）

#### アクセス情報
- **表示URL**: `/shipping/create_hard/<int:stock_id>`
- **保存URL**: `/shipping/save_hard/<int:stock_id>`
- **ナビゲーション**: HC在庫検索 > 出荷ボタン

#### 画面構成（4つの情報セクション）

**1. 在庫情報セクション**
- **表示項目**: ベース、加入度数、L/R、カラー、LOT、在庫数、**コート日**
- **データソース**: BFSP_MST（製品仕様）、BPRD_DAT（在庫情報）
- **抽出条件**: 
  - BPRD_DAT.BPDD_ID = :stock_id（指定された在庫ID）
  - BPRD_DAT.BPDD_PRD_ID = BFSP_MST.BFSP_PRD_ID（製品IDで結合）
  - 在庫数: Get_Zaiko_Qty_BF(BPDD_ID)関数で計算
  - コート日: BPRD_DAT.BPDD_CRT（ハードコート加工日）
- **目的**: 出荷対象ハードコート在庫の詳細情報確認
- **特徴**: ノンコートと異なりコート日が表示される

**2. 受注残情報セクション（1分割表示）**
- **ハードコート受注残のみ**: BFハードコート受注残一覧
- **抽出条件**:
  - BPRD_DAT.BPDD_ID = :stock_id（指定された在庫ID）
  - BPRD_DAT.BPDD_PRD_ID = BRCP_DAT.BRCP_PRD_ID（製品IDで結合）
  - BRCP_DAT.BRCP_PROC = :brcp_proc_hardcoat（ハードコート受注）
  - BRCP_DAT.BRCP_FLG = :brcp_flg_not_shipped（未出荷）
  - Get_ODR_ZAN_Qty_BF(BRCP_ID) > 0（受注残あり）
  - 並び順: BRCP_DT, BRCP_ORDER_NO（受注日、注文番号順）
- **表示項目**: 受注日、注文番号、出荷先、数量
- **データソース**: BRCP_DAT（受注データ）、CZTR_MST（取引先）
- **目的**: ハードコート出荷先決定時の参考情報提供

**3. 加工指図セクション**
- **表示項目**: 加工指図日付、加工指図数量、LOT
- **データソース**: BSHK_DAT（加工指図データ）
- **抽出条件**:
  - BPRD_DAT.BPDD_PRD_ID = :prd_id（製品ID）
  - BSHK_DAT.BSHK_PDD_ID = BPRD_DAT.BPDD_ID（製造IDで結合）
  - BSHK_DAT.BSHK_TO = :ship_to（出荷先=加工先）
  - BSHK_DAT.BSHK_FLG = :bshk_flg_not_shipped（未出荷）
- **目的**: 加工履歴の確認と出荷計画の参考

**4. 出荷情報入力セクション**
- **動的フォーム**: 出荷先追加・削除機能
- **入力項目**: 出荷先、出荷日、手配日、数量
- **バリデーション**: 必須項目チェック、数量制限
- **出荷先制限**: 加工先（ID=601）は選択肢から除外
- **出荷先データ**: CZTR_MST全件取得（get_shipping_destinations()）

#### ノンコートとの差分
- **対象在庫**: BFハードコート加工済み（BPDD_PROC = 1）
- **受注残表示**: BFハードコート受注残のみ（ノンコート受注残は非表示）
- **出荷先制限**: 加工先（ID=601）は選択肢から除外
- **追加表示項目**: コート日（BPDD_CRT）

### 3.3 ハードコート自動出荷機能

#### アクセス情報
- **URL**: `/hardcoat_auto_shipping`
- **認証**: 必須（@login_required）
- **ナビゲーション**: BF > HC自動出荷

#### 機能目的
BFハードコート在庫の自動出荷により、出荷業務の効率化と標準化を図る。

#### 処理フロー
```
1. 自動出荷条件入力
   ├─ BF製品規格指定（ベース、加入度数、L/R、色）
   ├─ 出荷先・手配日・出荷日指定
   └─ 出荷数量指定
   ↓
2. BF在庫チェック（/hardcoat_check_stock）
   ├─ BF在庫数量確認（Get_Zaiko_Qty_BF）
   └─ 利用可能在庫リスト表示
   ↓
3. 自動出荷実行（/hardcoat_auto_shipping_save）
   ├─ Shipment.auto_shipping_hardcoat()実行
   ├─ BPDD_LOT昇順（古い順）での自動選択
   └─ BF受注残との自動照合
```

#### 自動出荷ロジック（BF専用）
- **優先順位**: BPDD_LOTの昇順（古いBFロットから出荷）
- **在庫チェック**: 出荷数量≤BF利用可能在庫数
- **受注照合**: 出荷先が「加工」「欠損」以外の場合はBF受注残と照合
- **分割出荷**: 複数BFロットからの自動分割出荷対応

#### 自動出荷データ抽出条件
- **製品検索条件**:
  - BFSP_MST.BFSP_BASE = :base
  - BFSP_MST.BFSP_ADP = :adp
  - BFSP_MST.BFSP_LR = :lr
  - BFSP_MST.BFSP_CLR = :clr
- **在庫検索条件**:
  - BPRD_DAT.BPDD_PRD_ID = :prd_id（製品ID）
  - BPRD_DAT.BPDD_PROC = :proc_hardcoat（ハードコート加工済み）
  - BPRD_DAT.BPDD_FLG = :flg_not_shipped（未出荷）
  - Get_Zaiko_Qty_BF(BPDD_ID) > 0（在庫有り）
  - 並び順: BPDD_LOT（ロット昇順）
- **受注検索条件**（出荷先が加工・欠損以外の場合）:
  - BRCP_DAT.BRCP_ORDER_CMP = :ship_to（出荷先）
  - BRCP_DAT.BRCP_PRD_ID = :prd_id（製品ID）
  - BRCP_DAT.BRCP_PROC = :proc_hardcoat（ハードコート受注）
  - BRCP_DAT.BRCP_FLG = :brcp_flg_not_shipped（未出荷）
  - Get_ODR_ZAN_Qty_BF(BRCP_ID) > 0（受注残あり）
  - 並び順: BRCP_DT（受注日昇順）

### 3.4 データ項目

#### 表示項目（BF在庫情報）
- **製造ID**: BPRD_DAT.BPDD_ID（BF製造ID）
- **製品ID**: BPRD_DAT.BPDD_PRD_ID（BF製品ID）
- **LOT**: BPRD_DAT.BPDD_LOT（BF製造LOT）
- **製品仕様**: BFSP_MST各項目（BFベース、加入度数、L/R、色）
- **在庫数**: Get_Zaiko_Qty_BF(BPDD_ID)
- **コート日**: BPRD_DAT.BPDD_CRT（ハードコートの場合）

#### 表示項目（BF受注残情報）
- **受注会社**: BRCP_DAT.BRCP_ORDER_CMP
- **客先注文番号**: BRCP_DAT.BRCP_ORDER_NO
- **受注日**: BRCP_DAT.BRCP_DT
- **受注残数**: Get_ODR_ZAN_Qty_BF(BRCP_ID)

#### 表示項目（BF加工指図情報）
- **加工指図日付**: BSHK_DAT.BSHK_DT
- **加工指図数量**: BSHK_DAT.BSHK_QTY
- **LOT**: BPRD_DAT.BPDD_LOT

#### 入力項目（BF出荷情報）
- **出荷先**: BSHK_DAT.BSHK_TO（セレクトボックス）
- **出荷数量**: BSHK_DAT.BSHK_QTY（数値入力）
- **出荷日**: BSHK_DAT.BSHK_DT（日付入力）
- **手配日**: BSHK_DAT.BSHK_ORD_DT（日付入力）

### 3.5 動的フォーム機能

#### 出荷先追加・削除機能
- **追加機能**: 「出荷先を追加」ボタンによる動的フォーム追加
- **削除機能**: 各出荷先行の「削除」ボタンによる削除
- **制限**: 最低1つの出荷先は必須（削除不可）
- **実装**: JavaScriptによるDOM操作

#### フォームバリデーション
- **必須項目チェック**: 出荷先、出荷日、手配日、数量
- **数量制限**: 最小値1以上
- **2重送信防止**: 送信ボタンの無効化処理
- **エラーハンドリング**: アラート表示によるユーザー通知

#### Ajax通信処理
- **データ形式**: JSON形式でのサーバー送信
- **送信項目**: 出荷先、出荷日、手配日、数量の配列
- **レスポンス処理**: 成功時はリダイレクト、失敗時はエラー表示
- **ボタン制御**: 送信中はボタン無効化、完了後は有効化

### 3.6 業務ルール（BF専用）
- **分割出荷**: 複数BF出荷先への分割出荷対応
- **数量制限**: 出荷数量合計 ≤ BF在庫数量
- **FIFO原則**: 先入先出によるBF受注データとの紐付け
- **加工除外**: 出荷先が加工（ID=601）の場合はBF受注紐付けなし
- **在庫連動**: BF出荷登録時の在庫フラグ自動更新
- **動的フォーム**: 出荷先の動的追加・削除による柔軟な出荷計画
- **受注残照合**: 在庫情報と受注残情報の同時表示による出荷判断支援
- **加工履歴**: 加工指図履歴の表示による出荷タイミングの最適化

## 4. BF出荷削除機能

### 4.1 機能概要

#### アクセス情報
- **URL**: `/shipment/<int:shipment_id>`
- **HTTPメソッド**: DELETE
- **認証**: 必須（@login_required）

#### 機能目的
誤登録されたBF出荷データの削除とBF関連データの自動復旧。

### 4.2 処理フロー

#### BF削除処理フロー
```
1. 削除確認ダイアログ表示（JavaScript）
   ↓
2. Ajax通信によるBF削除API呼び出し
   ↓
3. BF削除可能性チェック
   ├─ 加工済み（BSHK_FLG ≥ BSHK_FLG_PROCESSED）は削除不可
   └─ 納品書発行済み（BSHK_FLG ≥ BSHK_FLG_DELIVERED）は削除不可
   ↓
4. BF関連データ復旧処理
   ├─ BF受注フラグ復旧（削除出荷分のBF受注残復旧）
   └─ BF在庫フラグ復旧（削除後のBF在庫状態更新）
   ↓
5. BF出荷データ削除（BSHK_DAT）
   ↓
6. 画面リロード・メッセージ表示
```

### 4.3 削除制限ルール（BF専用）
- **削除可能**: 手配済み（BSHK_FLG_ARRANGED）まで
- **削除不可**: 加工済み（BSHK_FLG_PROCESSED）以降
- **削除不可**: 納品書発行済み（BSHK_FLG_DELIVERED）以降

### 4.4 データ復旧ルール（BF専用）
- **BF受注フラグ**: 削除された出荷数量分のBF受注残を復旧
- **BF在庫フラグ**: 削除後にBF在庫が存在する場合は在庫有りに復旧

## 5. データベース設計（BF専用）

### 5.1 主要テーブル

#### BSHK_DAT（BF出荷データテーブル）
```sql
CREATE TABLE BSHK_DAT (
    BSHK_ID decimal(10) identity(1,1),    -- BF出荷ID（主キー）
    BSHK_TO decimal(3),                   -- 出荷先ID
    BSHK_PDD_ID decimal(8),               -- BF製造ID（BPRD_DAT.BPDD_ID）
    BSHK_RCP_ID decimal(10),              -- BF受注ID（BRCP_DAT.BRCP_ID）
    BSHK_DT datetime2,                    -- 出荷日
    BSHK_QTY decimal(5),                  -- 出荷数量
    BSHK_FLG decimal(1),                  -- 出荷フラグ（ステータス管理）
    BSHK_ORD_DT datetime2,                -- 手配日
    PRIMARY KEY (BSHK_ID)
);
```

#### 関連テーブル（BF専用）
- **BPRD_DAT**: BF製造データテーブル（BF在庫情報）
- **BRCP_DAT**: BF受注データテーブル（BF受注残情報）
- **BFSP_MST**: BF規格マスタテーブル（BF製品仕様）
- **CZTR_MST**: 取引先マスタテーブル（出荷先情報）

### 5.2 重要なSQL関数（BF専用）
- **Get_Zaiko_Qty_BF(BPDD_ID)**: BF在庫数量計算
- **Get_ODR_ZAN_Qty_BF(BRCP_ID)**: BF受注残数量計算

### 5.3 BF出荷フラグ定義
- **0**: 手配済み（BSHK_FLG_ARRANGED）
- **1**: 加工済み（BSHK_FLG_PROCESSED）
- **2**: 納品書発行済み（BSHK_FLG_DELIVERED）

### 5.4 BF出荷先定義
- **601**: 加工宛（SHIPMENT_TO_PROCESS）
- **999**: 欠損（ORDER_CMP_MISSING）
- **その他**: 通常のBF出荷先（コロンバス、ダラス、ヤンガーなど）

## 6. 一般出荷管理との違い

### 6.1 BF出荷管理（専用システム）
- **データテーブル**: BSHK_DAT、BPRD_DAT、BRCP_DAT（BF専用）
- **機能**: BFレンズ特化、ノンコート/ハードコート別管理、自動出荷機能
- **URL**: `/shipments`、`/shipping/*`、`/hardcoat_auto_shipping`
- **実装ファイル**: `routes.py`、`shipment.py`
- **製品マスタ**: BFSP_MST（BF規格マスタ）

### 6.2 一般出荷管理（共通システム）
- **データテーブル**: CSHK_DAT、CPRD_DAT（一般製品用）
- **機能**: 汎用的な出荷管理、出荷区分（出荷/加工/欠損）による管理
- **URL**: `/common/shipment_list`、`/common/*`
- **実装ファイル**: `routes_common.py`、`shipment_common.py`
- **製品マスタ**: PRD_MST（製品マスタ）

### 6.3 主要相違点
1. **データ構造**: BF専用テーブルと一般テーブルの完全分離
2. **業務ルール**: BFレンズ特有のコート処理と自動出荷ロジック
3. **UI/UX**: BF専用の検索条件とフォーム項目
4. **在庫管理**: BF専用在庫残数計算関数の使用
5. **製品規格**: BF規格マスタによる専用製品管理

## 7. 関連ファイル・関数

### 7.1 主要ファイル
- **ルーティング**: `app/routes.py`
  - `shipment_list()` (524-569行)
  - `create_shipping()` (420-455行)
  - `create_shipping_hard()` (762-790行)
  - `hardcoat_auto_shipping()` (1135-1165行)

- **モデル**: `app/shipment.py` - `Shipment`クラス（BF専用）
- **フォーム**: `app/forms.py` - `ShipmentSearchForm`
- **テンプレート**: 
  - `app/templates/shipment_list.html`
  - `app/templates/shipping/create.html`
  - `app/templates/shipping/create_hard.html`
  - `app/templates/hardcoat_auto_shipping.html`

### 7.2 定数ファイル
- **app/constants.py**: DatabaseConstants クラス
  - SHIPMENT_STATUS_LABELS（BF出荷ステータス）
  - BSHK_FLG_*（BF出荷フラグ定数）
  - SHIPMENT_TO_PROCESS（加工先ID）
  - PROC_NON_COAT、PROC_HARD_COAT（BF加工種別）

---

**作成日**: 2025年7月  
**更新日**: 2025年7月  
**バージョン**: 1.0  
**対象システム**: BFZaiko在庫管理システム（BF専用）