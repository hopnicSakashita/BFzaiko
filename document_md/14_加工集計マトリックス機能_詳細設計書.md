# 加工集計マトリックス機能 詳細設計書

## 1. 機能概要

### 機能名
加工集計マトリックス機能（Processing Matrix Function）

### 機能目的
加工集計グループマスタ（CPRG_MST）を基盤として、製品・加工別の在庫状況をマトリックス形式で可視化し、加工業務の効率化と在庫管理の最適化を支援する。

### システム位置づけ
- **集計・分析機能**: 加工業務の状況把握・分析
- **在庫管理支援**: 加工前後在庫の可視化
- **業務効率化**: 加工残数の把握による業務調整支援

### 主要機能群
1. **加工集計グループ管理**: CPRG_MSTによるグループ定義
2. **マトリックス表示**: 行・列による在庫状況可視化
3. **在庫データ集計**: 加工前・加工中・加工後在庫の統合表示
4. **印刷・出力**: マトリックス表の印刷機能

## 2. 加工集計グループマスタ（CPRG_MST）

### 2.1 テーブル構造

#### 基本項目
- **CPRG_ID**: グループID（主キー、5文字）
- **CPRG_PRD_ID**: 製品ID（主キー、5文字）
- **CPRG_PRC_ID**: 加工ID（主キー、5桁数値）
- **CPRG_G_NM**: グループ名（20文字）
- **CPRG_COL_NM**: 列名（20文字）
- **CPRG_ROW_NM**: 行名（20文字）
- **CPRG_AF_PRD_ID**: 加工後製品ID（5文字）
- **CPRG_COL_KEY**: 列キー（2桁数値）
- **CPRG_ROW_KEY**: 行キー（2桁数値）

#### データ関係
- **製品マスタ連携**: CPRG_PRD_ID → PRD_MST.PRD_ID
- **加工マスタ連携**: CPRG_PRC_ID → CPRC_MST.CPRC_ID
- **加工後製品連携**: CPRG_AF_PRD_ID → PRD_MST.PRD_ID

### 2.2 マスタ管理機能

#### 実装クラス
- **CprgMstModel**: `app/models_total.py`
- **主要メソッド**: `get_all()`, `create()`, `update()`, `delete()`

#### CRUD機能
- **一覧表示**: `/total/cprg/list`
- **新規作成**: `/total/cprg/create`
- **編集**: `/total/cprg/<id>/<prd_id>/<prc_id>/edit`
- **削除**: `/total/cprg/<id>/<prd_id>/<prc_id>/delete`

## 3. マトリックス表示機能

### 3.1 画面構成

#### アクセス情報
- **URL**: `/total/processing_matrix_cprg`
- **テンプレート**: `app/templates/total/processing_matrix_cprg.html`
- **認証**: 必須（@login_required）

#### 画面レイアウト
```
┌─────────────────────────────────────────────────────────────┐
│ 加工集計マトリックス                                          │
├─────────────────────────────────────────────────────────────┤
│ 検索条件                                                      │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 加工集計グループ: [▼選択してください_________________]    │ │
│ │ [検索] [クリア]                                         │ │
│ └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ 加工集計マトリックス表                                        │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 行名/列名 │ 列名1 │ 列名2 │ 列名3 │ ...                │ │
│ ├───────────┼───────┼───────┼───────┼─────────────────────┤ │
│ │ 行名1     │ 在庫数│ 在庫数│ 在庫数│ ...                │ │
│ │           │ 加工残│ 加工残│ 加工残│                     │ │
│ │           │ 加工後│ 加工後│ 加工後│                     │ │
│ ├───────────┼───────┼───────┼───────┼─────────────────────┤ │
│ │ 行名2     │ 在庫数│ 在庫数│ 在庫数│ ...                │ │
│ │           │ 加工残│ 加工残│ 加工残│                     │ │
│ │           │ 加工後│ 加工後│ 加工後│                     │ │
│ └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ 凡例                                                        │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 数値の意味: 在庫数 / 加工残数 / 加工後在庫              │ │
│ │ 表示形式: 「-」= データなし                             │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 検索機能

#### 検索条件
- **加工集計グループ**: CPRG_MST.CPRG_ID（必須選択）

#### 検索処理フロー
```
1. 加工集計グループ選択
   ↓
2. 検索ボタンクリック
   ↓
3. マトリックスデータ取得
   ├─ get_processing_matrix_data()
   ├─ get_cprg_details()
   └─ テンプレート表示
   ↓
4. マトリックス表表示
```

### 3.3 マトリックス表示ロジック

#### データ取得処理
マトリックス表示に必要なデータは以下の3つの観点から取得される：

1. **在庫数取得処理**
   - 対象テーブル: CPRG_MST、CPRD_DAT
   - 計算関数: Get_CPRD_ZAN_Qty
   - 条件: 在庫残数が0より大きいデータのみ

2. **加工残数取得処理**
   - 対象テーブル: CPRG_MST、CSHK_DAT
   - 計算関数: Get_CSHK_PRC_ZAN_Qty
   - 条件: 加工残数が0より大きいデータのみ

3. **加工後在庫取得処理**
   - 対象テーブル: CPRG_MST、CPRD_DAT
   - 計算関数: Get_CPRD_ZAN_Qty
   - 条件: 加工後製品IDの在庫残数が0より大きいデータのみ

#### 表示データ項目
- **在庫数**: 加工前の製品在庫数
- **加工残数**: 加工中の数量
- **加工後在庫**: 加工完了後の在庫数

#### 表示形式
- **数値表示**: バッジ形式での数量表示
- **色分け**: 在庫数（青）、加工残数（黄）、加工後在庫（緑）
- **データなし**: 「-」表示

## 4. データ処理機能

### 4.1 在庫計算関数

#### Get_CPRD_ZAN_Qty関数
- **目的**: 入庫データの在庫残数計算
- **対象**: CPRD_DAT（一般入庫データ）
- **計算式**: 入庫数量 - 出荷数量 - 加工数量

#### Get_CSHK_PRC_ZAN_Qty関数
- **目的**: 加工出荷データの加工残数計算
- **対象**: CSHK_DAT（一般出荷データ）
- **計算式**: 加工数量 - 加工戻り数量

### 4.2 データ集計処理

#### マトリックスデータ構築
マトリックス表示用のデータは以下の手順で構築される：

1. **SQLクエリ実行**: 3つのUNION ALLクエリによるデータ取得
2. **データ集計**: 列キー・行キーによるグループ化
3. **マトリックス形式変換**: 辞書形式でのデータ構造化
4. **数値集計**: 在庫数・加工残数・加工後在庫の合計計算

#### データ構造
マトリックスデータは以下の構造で管理される：
- **キー**: (列キー, 行キー)のタプル
- **値**: 在庫数・加工残数・加工後在庫の辞書

### 4.3 エラーハンドリング

#### データベースエラー処理
- **接続エラー**: セッション管理による自動再接続
- **SQLエラー**: ログ出力とユーザーへのエラー表示
- **データ不整合**: デフォルト値（0）での表示

#### 表示エラー処理
- **データなし**: 「-」表示
- **数値エラー**: 0として表示
- **キーエラー**: 空データとして処理

## 5. 印刷・出力機能

### 5.1 印刷機能

#### 印刷ボタン
- **表示条件**: 検索結果が存在する場合のみ表示
- **実行方法**: JavaScriptによる印刷実行

#### 印刷スタイル
印刷時には以下のスタイルが適用される：
- **ボタン・アラート非表示**: 印刷に不要な要素を隠す
- **カード境界線**: 印刷用の境界線表示
- **フォントサイズ**: 12px（印刷用最適化）
- **バッジ境界線**: 印刷用の境界線表示

### 5.2 出力形式

#### 印刷レイアウト
- **A4縦**: 標準印刷サイズ
- **ページ分割**: カード単位での改ページ制御
- **フォントサイズ**: 12px（印刷用最適化）

#### 表示項目
- **マトリックス表**: 全データ表示
- **凡例**: 数値の意味説明
- **ヘッダー**: 機能名・検索条件

## 6. セキュリティ・性能

### 6.1 セキュリティ対策

#### 認証・認可
- **ログイン必須**: @login_requiredデコレータによる認証制御
- **セッション管理**: Flask-Sessionによるセッション制御
- **CSRF対策**: フォーム送信時のCSRFトークン検証

#### データ保護
- **SQLインジェクション対策**: パラメータ化クエリ使用
- **XSS対策**: テンプレートエンジンによる自動エスケープ
- **入力検証**: サーバーサイドでのデータ検証

### 6.2 性能最適化

#### データベース最適化
- **インデックス活用**: 主キー・外部キーによる高速検索
- **クエリ最適化**: UNION ALLによる効率的なデータ取得
- **セッション管理**: 適切なセッション開始・終了

#### フロントエンド最適化
- **レスポンシブデザイン**: Bootstrap 5による適応的レイアウト
- **条件付き表示**: 検索結果存在時のみデータ表示
- **印刷最適化**: 印刷専用CSSによる表示制御

### 6.3 運用・保守

#### ログ機能
- **エラーログ**: データベースエラーの詳細記録
- **アクセスログ**: ユーザーアクセスの追跡
- **パフォーマンスログ**: 処理時間の監視

#### 監視・アラート
- **データ不整合検出**: 在庫計算結果の妥当性チェック
- **パフォーマンス監視**: クエリ実行時間の監視
- **エラー通知**: 重大エラーの即座通知

## 7. 業務フロー

### 7.1 基本業務フロー

#### マトリックス表示フロー
```
1. ユーザーログイン
   ↓
2. 加工集計マトリックス画面アクセス
   ↓
3. 加工集計グループ選択
   ↓
4. 検索実行
   ↓
5. マトリックスデータ取得・表示
   ↓
6. 在庫状況確認・分析
   ↓
7. 必要に応じて印刷・出力
```

#### マスタ管理フロー
```
1. 加工集計グループマスタ一覧表示
   ↓
2. 新規作成・編集・削除操作
   ↓
3. データ検証・保存
   ↓
4. マトリックス表示への反映
```

### 7.2 エラー処理フロー

#### データ取得エラー時
```
1. エラー発生検知
   ↓
2. ログ出力
   ↓
3. ユーザーへのエラーメッセージ表示
   ↓
4. トップページへのリダイレクト
```

#### 表示エラー時
```
1. データ不整合検知
   ↓
2. デフォルト値での表示
   ↓
3. エラーログ記録
   ↓
4. 継続処理
```

## 8. 関連機能

### 8.1 連携機能

#### 在庫管理機能
- **在庫詳細画面**: 個別在庫の詳細確認
- **在庫集計一覧**: 全体在庫の集計表示
- **入庫管理**: 在庫データの更新

#### 加工管理機能
- **加工依頼管理**: 加工業務の進捗管理
- **加工指示書**: 加工作業の指示書発行
- **加工戻り管理**: 加工完了データの管理
