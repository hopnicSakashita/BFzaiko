# BF製造明細管理機能 詳細設計書

## 1. 機能概要

### 機能名
BF製造明細管理機能（BF製造工程分割管理システム）

### 機能目的
**バイフォーカル（BF）レンズの製造工程**における分割管理を行い、製品ID・LOT・分割番号による詳細なトレーサビリティと、製造データ（BPRD_DAT）との自動連動による在庫管理の基盤を提供する。

### システム位置づけ
- **BFセクション**の製造管理機能（ナビゲーション「BF」> NC製造明細）
- BPRD_MEI（BF製造明細）とBPRD_DAT（BF製造データ）の連携管理
- BF在庫計算（Get_Zaiko_Qty_BF）の基礎データ提供

### 主要機能
1. **BF製造明細一覧画面**: 製造明細の検索・一覧表示
2. **BF製造明細登録画面**: 新規製造明細の登録・BPRD_DAT自動作成
3. **BF製造明細編集画面**: 既存明細の数量編集・差分連動更新

## 2. BF製造明細一覧画面

### 2.1 画面概要

#### アクセス情報
- **URL**: `/bprd_mei/list`
- **HTTPメソッド**: GET, POST
- **認証**: 必須（@login_required）
- **ナビゲーション**: BF > NC製造明細

#### 画面目的
BF製造明細データの検索・一覧表示により、製造工程の詳細状況把握と明細管理業務の効率化を図る。

### 2.2 処理フロー

#### メイン処理フロー
```
1. BF製造明細一覧画面アクセス（/bprd_mei/list）
   ↓
2. 認証チェック（@login_required）
   ↓
3. GET: 初期画面表示（検索フォーム表示）
   POST: 検索実行
   ↓
4. 検索条件取得・検証
   ├─ 製品ID（部分一致検索）
   └─ LOT番号（完全一致検索、数値変換）
   ↓
5. BF製造明細検索実行
   ├─ BPRD_MEIテーブル検索
   └─ 製品ID → LOT → No の昇順並び替え
   ↓
6. 検索結果表示
   ├─ BF製造明細一覧テーブル表示
   └─ 新規作成・編集ボタン表示
```

#### 検索処理詳細
- **製品ID検索**: 部分一致検索（前方・後方・中間一致対応）
- **LOT番号検索**: 数値変換後の完全一致検索（変換エラー時はエラーメッセージ表示）
- **並び順**: 製品ID → LOT番号 → 分割No の昇順で固定
- **検索結果**: BPRD_MEIテーブルから条件に合致する製造明細データを取得

### 2.3 データ項目

#### 検索条件項目
- **製品ID**: BPRD_MEI.BPDM_PRD_ID（テキスト入力、部分一致）
- **LOT番号**: BPRD_MEI.BPDM_LOT（数値入力、完全一致）

#### 表示項目
- **明細ID**: BPRD_MEI.BPDM_ID
- **製品ID**: BPRD_MEI.BPDM_PRD_ID
- **LOT番号**: BPRD_MEI.BPDM_LOT
- **分割No**: BPRD_MEI.BPDM_NO
- **数量**: BPRD_MEI.BPDM_QTY
- **操作**: 編集ボタン

### 2.4 業務ルール
- 製品ID: 部分一致検索（前方・後方・中間一致対応）
- LOT番号: 数値のみ受付、完全一致検索
- 並び順: 製品ID → LOT → 分割No の昇順（固定）

## 3. BF製造明細登録機能

### 3.1 画面概要

#### アクセス情報
- **表示URL**: `/bprd_mei/create`
- **保存処理**: 同一URL（POST）
- **認証**: 必須（@login_required）

#### 画面目的
新規BF製造明細の登録と、BPRD_DAT（BF製造データ）の自動作成・更新による製造工程管理。

### 3.2 処理フロー

#### 登録処理フロー
```
1. BF製造明細登録画面アクセス（/bprd_mei/create）
   ↓
2. 製品マスタ取得（BFSP_MST）
   ├─ BFSP_SORT順での並び替え
   └─ プルダウン選択肢生成
   ↓
3. フォーム表示（製品ID、LOT、分割No、数量）
   ↓
4. ユーザー入力・送信
   ↓
5. 入力値検証
   ├─ 必須項目チェック
   ├─ 数値範囲チェック
   └─ 重複チェック（製品ID+LOT+No）
   ↓
6. BF製造明細作成処理（BprdMei.create()）
   ├─ BPRD_MEI レコード作成
   └─ BPRD_DAT 連動処理
   ↓
7. 完了メッセージ・一覧画面遷移
```

#### BPRD_DAT連動処理フロー
```
1. 同一製品ID+LOTのBPRD_DATレコード検索
   ↓
2. 存在チェック分岐
   ├─ 存在する: 数量加算更新（BPDD_QTY += 明細数量）
   └─ 存在しない: 新規作成
       ├─ BPDD_PRD_ID = 製品ID
       ├─ BPDD_LOT = LOT番号
       ├─ BPDD_QTY = 明細数量
       ├─ BPDD_FLG = 0（未出荷）
       └─ BPDD_PROC = 0（ノンコート）
   ↓
3. トランザクションコミット
```

### 3.3 データ項目

#### 入力項目
- **製品ID**: BPRD_MEI.BPDM_PRD_ID（セレクトボックス、BFSP_MST連携）
- **LOT番号**: BPRD_MEI.BPDM_LOT（数値入力、0-999999）
- **分割No**: BPRD_MEI.BPDM_NO（数値入力、0-9999）
- **数量**: BPRD_MEI.BPDM_QTY（数値入力、0-99999）

#### 参照項目（製品マスタ）
- **製品選択肢**: BFSP_MST.BFSP_PRD_ID（BFSP_SORT順）
- **表示形式**: 製品ID - 製品仕様組み合わせ

### 3.4 業務ルール
- **一意性制約**: 製品ID + LOT + 分割No の組み合わせで一意
- **必須項目**: 全項目必須入力
- **数値範囲**: LOT（0-999999）、分割No（0-9999）、数量（0-99999）
- **自動連動**: BPRD_DAT の新規作成または数量加算更新

### 3.5 入力値検証

#### サーバーサイド検証
- **必須項目チェック**: 製品ID、LOT番号、分割No、数量の全項目が入力されているか確認
- **数値範囲チェック**: LOT番号（0-999999）、分割No（0-9999）、数量（0-99999）の範囲内か確認
- **重複チェック**: 製品ID+LOT+分割Noの組み合わせが既に存在しないか確認
- **エラー処理**: 検証エラー時は適切なエラーメッセージを表示し、入力画面に戻る

## 4. BF製造明細編集機能

### 4.1 画面概要

#### アクセス情報
- **表示URL**: `/bprd_mei/<int:mei_id>/edit`
- **更新URL**: `/bprd_mei/<int:mei_id>/update`
- **認証**: 必須（@login_required）

#### 画面目的
既存BF製造明細の数量編集と、BPRD_DATとの差分連動更新による整合性維持。

### 4.2 処理フロー

#### 編集処理フロー
```
1. BF製造明細編集画面アクセス（/bprd_mei/<mei_id>/edit）
   ↓
2. 明細ID検証・明細データ取得
   ├─ BPRD_MEI.BPDM_ID での検索
   └─ 存在チェック（404エラー処理）
   ↓
3. 編集フォーム表示
   ├─ 製品ID、LOT、分割No: 読み取り専用
   └─ 数量: 編集可能
   ↓
4. ユーザー入力・送信（/bprd_mei/<mei_id>/update）
   ↓
5. 更新値検証・差分計算
   ├─ 数量 ≥ 0 チェック
   └─ 差分 = 新数量 - 現数量
   ↓
6. BPRD_DAT差分更新処理
   ├─ 同一製品ID+LOTのBPRD_DAT検索
   ├─ 数量更新（BPDD_QTY += 差分）
   └─ 負数チェック（BPDD_QTY < 0 の場合エラー）
   ↓
7. BPRD_MEI更新・トランザクションコミット
```

#### 差分連動更新処理
- **差分計算**: 新数量 - 現数量で差分を算出
- **BPRD_DAT検索**: 同一製品ID+LOTの製造データを検索
- **数量更新**: BPRD_DATの数量に差分を加算
- **負数チェック**: 更新後の数量が0未満になる場合はエラー処理
- **整合性確保**: 関連データが存在しない場合もエラー処理
- **最終更新**: BPRD_MEIの数量を新数量で更新し、トランザクションコミット

### 4.3 データ項目

#### 表示項目（読み取り専用）
- **明細ID**: BPRD_MEI.BPDM_ID
- **製品ID**: BPRD_MEI.BPDM_PRD_ID
- **LOT番号**: BPRD_MEI.BPDM_LOT
- **分割No**: BPRD_MEI.BPDM_NO

#### 編集項目
- **数量**: BPRD_MEI.BPDM_QTY（数値入力、0以上）

### 4.4 業務ルール
- **編集制限**: 数量のみ編集可能（製品ID、LOT、分割Noは変更不可）
- **数量制限**: 0以上の数値のみ受付
- **整合性チェック**: BPRD_DAT数量が負数になる変更は禁止
- **差分更新**: 変更前後の差分のみBPRD_DATに反映

## 5. データベース設計（BF専用）

### 5.1 主要テーブル

#### BPRD_MEI（BF製造明細テーブル）
```sql
CREATE TABLE BPRD_MEI (
    BPDM_ID decimal(8) identity(1,1),    -- 明細ID（主キー）
    BPDM_PRD_ID varchar(4),              -- 製品ID（BFSP_MST.BFSP_PRD_ID）
    BPDM_LOT decimal(6,0),               -- LOT番号
    BPDM_NO decimal(4,0),                -- 分割番号
    BPDM_QTY decimal(5,0),               -- 数量
    PRIMARY KEY (BPDM_ID),
    UNIQUE KEY uk_bprd_mei (BPDM_PRD_ID, BPDM_LOT, BPDM_NO)
);
```

#### 関連テーブル
- **BPRD_DAT**: BF製造データテーブル（集約先）
- **BFSP_MST**: BF規格マスタテーブル（製品情報）

### 5.2 データ関係性

#### BPRD_MEI と BPRD_DAT の関係
- **1対多関係**: 1つのBPRD_DATに対して複数のBPRD_MEI
- **集約関係**: BPRD_MEIの数量合計 = BPRD_DATの数量
- **連動更新**: BPRD_MEI操作時にBPRD_DAT自動更新

```
BPRD_DAT (製造データ)
├─ 製品ID: 1001, LOT: 001, 数量: 100
│
└─ BPRD_MEI (製造明細)
   ├─ 製品ID: 1001, LOT: 001, No: 1, 数量: 30
   ├─ 製品ID: 1001, LOT: 001, No: 2, 数量: 40
   └─ 製品ID: 1001, LOT: 001, No: 3, 数量: 30
   　　　　　　　　　　　　　　　　　合計: 100
```

### 5.3 制約・インデックス
- **主キー**: BPDM_ID（自動採番）
- **ユニークキー**: BPDM_PRD_ID + BPDM_LOT + BPDM_NO
- **外部キー**: BPDM_PRD_ID → BFSP_MST.BFSP_PRD_ID（参照整合性）

## 6. モデル設計

### 6.1 BprdMeiModel（SQLAlchemyモデル）
- **テーブル名**: BPRD_MEI
- **主キー**: BPDM_ID（自動採番）
- **データ型**:
  - BPDM_PRD_ID: 文字列4文字（製品ID）
  - BPDM_LOT: 数値6桁（LOT番号）
  - BPDM_NO: 数値4桁（分割番号）
  - BPDM_QTY: 数値5桁（数量）

### 6.2 BprdMei（業務ロジッククラス）
- **get_by_prd_id()**: 製品IDによる製造明細検索機能
- **create()**: 新規製造明細作成処理（BPRD_DATとの連動処理含む）
- **update()**: 製造明細更新処理（差分連動更新含む）
- **delete()**: 製造明細削除処理（関連データ整合性確保）

## 7. エラーハンドリング

### 7.1 業務エラーパターン
- **入力値エラー**: 必須項目未入力、数値範囲外
- **重複エラー**: 製品ID+LOT+No の組み合わせ重複
- **整合性エラー**: BPRD_DAT数量負数、関連データ不存在

### 7.2 システムエラーパターン
- **データベースエラー**: 接続エラー、SQL実行エラー
- **トランザクションエラー**: コミット失敗、ロック競合
- **アプリケーションエラー**: 予期しない例外

### 7.3 エラーハンドリング方法
- **整合性エラー**: データの整合性制約違反時のロールバックとエラーログ記録
- **データベースエラー**: SQL実行エラー時のロールバックとエラーログ記録
- **予期しないエラー**: その他の例外発生時のロールバックとエラーログ記録
- **ユーザー通知**: 各エラー種別に応じた適切なメッセージ表示
- **トランザクション管理**: エラー発生時は確実にロールバックを実行

## 8. 関連ファイル・関数

### 8.1 主要ファイル
- **ルーティング**: `app/routes.py`
  - `list_bprd_mei()` (194-230行)
  - `create_bprd_mei()` (232-266行)
  - `edit_bprd_mei()` (124-139行)
  - `update_bprd_mei()` (141-190行)

- **モデル**: `app/models.py`
  - `BprdMeiModel` (61-70行)
  - `BprdMei` (513-627行)

- **テンプレート**: 
  - `app/templates/bprd_mei_list.html`
  - `app/templates/bprd_mei_create.html`
  - `app/templates/bprd_mei_edit.html`

### 8.2 関連定数
- **app/constants.py**: DatabaseConstants クラス
  - BPDD_FLG_NOT_SHIPPED（未出荷フラグ）
  - PROC_NON_COAT（ノンコート加工区分）

### 8.3 在庫計算連携
- **Get_Zaiko_Qty_BF(BPDD_ID)**: BPRD_DATの数量を基準とした在庫計算
- **製造明細**: 在庫計算の基礎となるデータ品質を保証

---

**作成日**: 2025年7月  
**更新日**: 2025年7月  
**バージョン**: 1.0  
**対象システム**: BFZaiko在庫管理システム（BF専用）