# バーコード機能 詳細設計書

## 1. 機能概要

### 機能名
バーコード管理システム（Barcode Management System）

### 機能目的
出荷業務の効率化とデータ精度向上を目的として、出荷先別のバーコード仕様に対応したバーコード生成・読み取り・検証機能を提供する。

### システム位置づけ
- **横断的機能**: BF系統・一般系統双方で活用
- **出荷業務支援**: 各出荷先の固有バーコード仕様への対応
- **品質管理基盤**: バーコードスキャンによる出荷前検証

### 主要機能群
1. **バーコード生成**: 出荷先別バーコード自動生成
2. **出荷一覧連携**: 検索条件に基づくバーコード一括生成
3. **マスタ管理**: BBCD_DAT/CBCD_MST統合管理
4. **スキャン・検証**: カメラによるDataMatrix読み取り・照合
5. **CSV取込**: 一括データ管理機能

## 2. バーコード生成機能

### 2.1 機能概要

#### 実装クラス
- **BarcodeGenerator**: `app/barcode_generator.py`
- **ShipmentBarcodeSaver**: `app/barcode_saver.py`
- **主要メソッド**: `make_barcode_y()`, `make_barcode_s()`, `make_barcode_s_shipment()`

#### 生成対象
- **ヤンガー向けバーコード**: 出荷先ID 503, 504
- **サンレー向けバーコード**: 出荷先ID 501, 502
- **一般出荷バーコード**: CBCD_MST連携
- **出荷一覧連携バーコード**: 検索条件に基づく一括生成

### 2.2 ヤンガー向けバーコード生成

#### バーコード仕様
```
形式: 01{GTIN}11{coating_date}42239210{lot}{coating_date}240{BCD}

構成要素:
- 01: プリフィックス（固定）
- GTIN: BFSP_MST.BFSP_Y_GTIN（14桁GTINコード）
- 11: セパレータ（固定）
- coating_date: コート日（YYMMDD形式）
- 42239210: 固定識別子
- lot: ロット番号（6桁、0パディング）
- 240: サフィックス（固定）
- BCD: BFSP_MST.BFSP_Y_BCD（製品固有バーコード）
```

#### 実装仕様
- **メソッド**: `BarcodeGenerator.make_barcode_y(gtin, lot, coating_date, bcd)`
- **処理内容**: 
  - 日付フォーマット変換（YYYYMMDD → YYMMDD）
  - ロット番号6桁パディング
  - バーコード構成要素結合
- **データソース**: BFSP_MST（GTIN、BCD）、BPRD_DAT（LOT、コート日）

### 2.3 サンレー向けバーコード生成

#### バーコード仕様
```
形式: 10{day}{month_char}{year}240{barcode_val}

構成要素:
- 10: プリフィックス（固定）
- day: 日付（2桁、0パディング）
- month_char: 月のアルファベット変換（1月=A, 2月=B, ..., 12月=L）
- year: 年（下2桁）
- 240: セパレータ（固定）
- barcode_val: 製品固有バーコード値
```

#### 実装仕様
- **メソッド**: `BarcodeGenerator.make_barcode_s(coating_date, barcode_val)`
- **処理内容**:
  - 日付解析（YYMMDD形式）
  - 月のアルファベット変換（1月=A, 2月=B, ..., 12月=L）
  - バーコード構成要素結合
- **データソース**: BPRD_DAT（コート日）、BFSP_MST（製品バーコード値）

### 2.4 加工区分別バーコード選択ロジック

#### 加工区分判定
- **ノンコート（PROC=0）**: BFSP_S_NC使用
- **ハードコート（PROC=1）**: BFSP_S_HC使用
- **デフォルト**: BFSP_S_NC使用

## 3. バーコードマスタ管理機能

### 3.1 BBCD_DAT（バーコード取込テーブル）管理

#### テーブル構造
- **BBCD_ID**: ID（3文字以内）
- **BBCD_NO**: バーコード（60文字以内）
- **BBCD_NM**: バーコード名（30文字以内）

#### データ管理方式
- **全件削除・再作成方式**: 取込時に既存データ削除後新規登録
- **一意性保証**: BBCD_ID主キーによる重複防止
- **大量データ対応**: 最大999件処理制限

#### CSV取込機能（/barcode_import）
- ファイルアップロード検証
- 一時ファイル保存・処理
- BBCD_DAT一括更新
- エラーハンドリング・ログ出力

### 3.2 CBCD_MST（バーコードマスタテーブル）管理

#### テーブル構造
- **CBCD_ID**: ID（自動採番）
- **CBCD_PRD_ID**: 製品ID
- **CBCD_TO**: 出荷先ID
- **CBCD_NM**: 製品名
- **CBCD_NO1/NO2**: バーコード１・２
- **CBCD_FLG**: フラグ

#### 一般出荷バーコード生成
- **機能**: `make_barcode_s_shipment()`
- **処理**: サンレー形式ベースの一般出荷バーコード生成

## 4. バーコード保存機能

### 4.1 BF出荷バーコード保存（ShipmentBarcodeSaver）

#### 実装クラス
- **ShipmentBarcodeSaver**: `app/barcode_saver.py`
- **主要メソッド**: `save_shipment_barcodes()`

#### 処理フロー
```
1. 未出荷データ検索（BSHK_FLG = 0）
   ↓
2. 既存BBCD_DATデータ削除
   ↓
3. 出荷先別バーコード生成ループ
   ├─ 503,504: ヤンガー向けバーコード
   ├─ 501,502: サンレー向けバーコード  
   └─ その他: スキップ
   ↓
4. BBCD_DAT一括保存
   ├─ 100件ごとのバッチコミット
   └─ エラー時ロールバック
   ↓
5. 処理結果・統計表示
```

### 4.2 一般出荷バーコード保存（ShipmentBarcodeSaver）

#### 実装クラス
- **ShipmentBarcodeSaver**: `app/barcode_saver.py`
- **主要メソッド**: `save_shipment_barcodes_common()`

#### 処理フロー
```
1. 一般出荷データ検索（ShipmentCommon.get_shipment_list()）
   ↓
2. 既存BBCD_DATデータ削除
   ↓
3. CBCD_MST連携バーコード生成ループ
   ├─ 製品ID・出荷先IDによるマスタ検索
   ├─ CBCD_NO1 + LOT番号によるバーコード生成
   └─ マスタデータなしの場合はスキップ
   ↓
4. BBCD_DAT一括保存
   ├─ 100件ごとのバッチコミット
   └─ エラー時ロールバック
   ↓
5. 処理結果・統計表示
```

### 4.3 出荷一覧連携機能

#### 画面連携
- **BF出荷一覧**: `app/templates/shipment_list.html`
- **一般出荷一覧**: `app/templates/common/common_shipment_list.html`

#### JavaScript処理
バーコードボタンクリック時の処理として、以下の機能を実装しています：

1. **検索フォームデータ取得**: ページ内の検索フォーム（#searchForm）から全入力値を取得
2. **URLパラメータ構築**: 空でない値のみをURLSearchParamsオブジェクトに追加
3. **API呼び出し**: Flaskのurl_for()を使用してバーコード生成APIエンドポイントを生成し、検索条件をクエリパラメータとして付加
4. **ページ遷移**: window.location.hrefでバーコード生成画面に遷移

この処理により、現在の検索条件をそのままバーコード生成機能に引き継ぎ、効率的なバーコード生成が可能となります。

#### 検索条件対応
- **BF系統**: ベース、加入度数、L/R、カラー、加工タイプ、出荷日、出荷先、受注番号、出荷ステータス、受注日
- **一般系統**: 出荷日範囲、手配日範囲、出荷先

#### ルート設定
- **BF系統**: `/shipment_barcode` → `routes.py:shipment_barcode()`
- **一般系統**: `/common/shipment_barcode` → `routes_common.py:shipment_barcode()`

## 5. バーコードスキャン機能

### 5.1 カメラスキャン画面

#### アクセス情報
- **URL**: `/barcode_scan`
- **テンプレート**: `app/templates/barcode_scan.html`
- **認証**: 必須（@login_required）

#### 技術仕様
- **ライブラリ**: ZXing.js BrowserDatamatrixCodeReader
- **カメラ設定**: 背面カメラ優先、高解像度設定
- **対象形式**: DataMatrix専用読み取り

### 5.2 バーコード検証ロジック

#### 検証処理フロー
```
1. スキャンデータ取得
   ↓
2. 文字列正規化
   ├─ 制御文字除去
   ├─ 空白文字トリム
   └─ 大文字変換
   ↓
3. 期待値との照合
   ├─ 文字列完全一致チェック
   └─ 結果判定（成功/失敗）
   ↓
4. フィードバック出力
   ├─ 音声通知（周波数別）
   ├─ 画面色変更（緑/赤）
   └─ メッセージ表示
```

#### フィードバック仕様
- **barcode_scan.html（一般スキャン）**: バーコード検出時カメラ停止
- **barcode_scan_csv.html（CSVスキャン）**:
  - **検証成功時**: 800Hz音声、緑色表示、カメラ継続
  - **検証失敗時**: 400Hz音声、赤色表示、カメラ停止

### 5.3 連続スキャン機能

#### 処理制御ロジック
- **barcode_scan.html**: バーコード検出時カメラ停止
- **barcode_scan_csv.html**:
  - **検証成功時**: カメラ継続、連続スキャン可能
  - **検証失敗時**: カメラ停止、手動再開
- **スキャン状態管理**: 実行中・停止中状態制御

## 6. バーコードCSVスキャン機能

### 6.1 機能概要

#### アクセス情報  
- **URL**: `/barcode_scan_csv`
- **テンプレート**: `app/templates/barcode_scan_csv.html`
- **データソース**: BBCD_DAT

#### 機能目的
BBCD_DATテーブルに登録済みのバーコードデータを一覧表示し、各バーコードに対する連続スキャン検証を実行する。

### 6.2 処理フロー

#### 画面表示・スキャン処理
```
1. BBCD_DATデータ一覧取得・表示
   ↓
2. バーコード項目選択・カメラ起動
   ↓  
3. 連続スキャンループ
   ├─ DataMatrix読み取り実行
   ├─ BBCD_NO期待値との照合
   ├─ 検証成功時: カメラ継続・連続スキャン可能
   └─ 検証失敗時: カメラ停止・手動再開
   ↓
4. 手動で次のバーコード選択・スキャン継続
```

## 7. エラーハンドリング・ログ機能

### 7.1 データベースエラー処理

#### トランザクション管理
- **統一パターン**: try-except-finally構造
- **エラー種別**: IntegrityError、SQLAlchemyError、一般例外
- **ロールバック**: エラー時自動ロールバック実行

### 7.2 ファイル処理エラー

#### 一時ファイル管理
- **セキュリティ**: secure_filename()による安全なファイル名処理
- **リソース管理**: finally句による確実な一時ファイル削除
- **エラー種別**: FileNotFoundError、PermissionError対応

### 7.3 カメラ・デバイスエラー

#### JavaScript エラーハンドリング
- **カメラアクセスエラー**: NotFoundError、NotAllowedError、NotReadableError対応
- **リソース解放**: カメラストリーム・リーダーの適切な解放処理

## 8. 運用・保守機能

### 8.1 データ管理
- **BBCD_DAT**: 全件削除・再作成方式での管理
- **CBCD_MST**: マスタデータとしての永続管理
- **エラーログ**: `logger_utils.py`による統一ログ管理

## 9. 関連ファイル・設定

### 9.1 主要実装ファイル
- **バーコード生成**: `app/barcode_generator.py`
- **バーコード保存**: `app/barcode_saver.py`
- **ルーティング**: `app/routes.py`

### 9.2 テンプレートファイル
- **バーコード取込**: `app/templates/barcode_import.html`
- **バーコードスキャン**: `app/templates/barcode_scan.html`
- **CSVスキャン**: `app/templates/barcode_scan_csv.html`

### 9.3 データベース関連
- **テーブル作成**: `sql/CREATE_BBCD_DAT.sql`, `sql/CREATE_CBCD_MST.sql`
- **制約・インデックス**: 主キー制約、文字数制限

### 9.4 フロントエンド依存関係
- **ZXing.js**: DataMatrix読み取りライブラリ
- **Web Audio API**: 音声フィードバック
- **MediaDevices API**: カメラアクセス

---

**作成日**: 2025年7月  
**更新日**: 2025年7月  
**バージョン**: 1.0  
**対象システム**: BFZaiko在庫管理システム（バーコード機能）