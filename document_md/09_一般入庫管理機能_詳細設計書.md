# 一般入庫管理機能 詳細設計書

## 1. 機能概要

### 機能名
一般入庫管理システム（General Inventory Management System）

### 機能目的
BF系統以外の一般製品（共通製品）の入庫・在庫・出荷を統合管理し、効率的な在庫運用と正確な在庫管理を実現する。

### システム位置づけ
- **一般在庫管理**: BF系統と区分した一般製品の統合管理
- **入出庫連携**: 入庫から出荷までの一連の在庫フロー管理
- **多様な出荷形態**: 直接出荷・加工依頼・廃棄ロス等の対応

### 主要管理対象テーブル
1. **CPRD_DAT**: 一般製品入庫データ（在庫ベース）
2. **CSHK_DAT**: 一般出荷データ（出荷・加工・ロス管理）
3. **CPRC_DAT**: 一般加工データ（加工プロセス管理）

## 2. 一般入庫データ管理（CPRD_DAT）

### 2.1 機能概要

#### テーブル構造（CPRD_DAT）
```sql
CREATE TABLE CPRD_DAT (
    CPDD_ID decimal(10,0) IDENTITY(1,1) PRIMARY KEY,  -- 製造ID（自動採番）
    CPDD_PRD_ID varchar(5),                           -- 製品ID（PRD_MST参照）
    CPDD_LOT decimal(6,0),                            -- LOT番号
    CPDD_SPRIT1 decimal(2,0),                         -- 分割番号1
    CPDD_SPRIT2 decimal(2,0),                         -- 分割番号2
    CPDD_RANK decimal(2,0),                           -- ランク（KBN_MST.RANK参照）
    CPDD_QTY decimal(5,0),                            -- 数量
    CPDD_FLG decimal(1,0),                            -- フラグ（0:有効、9:削除）
    CPDD_PCD_ID decimal(10,0)                         -- 加工ID
);
```

#### システム特徴
- **在庫ベース管理**: 入庫データを基準とした在庫管理
- **製品マスタ連携**: PRD_MSTとの参照関係、KBN_MSTランク連携
- **残数量計算**: 入庫数量から出荷数量を差し引いた管理
- **分割管理**: SPRIT1/SPRIT2による分割番号管理
- **ランク管理**: 品質ランク（A/B/C/D）による分類

### 2.2 入庫データCRUD機能

#### 一覧表示機能（/common/cprd_dat）
- **URL**: `GET /common/cprd_dat`
- **表示項目**: CPDD_ID、製品ID、LOT、分割番号、ランク、数量、製品表示名、ランク名
- **JOIN**: PRD_MST（製品名取得）、KBN_MST（ランク名取得）
- **ソート**: CPDD_ID降順（最新順）
- **フラグフィルタ**: 有効データ（FLG≠9）のみ表示

#### 新規作成機能（/common/cprd_dat/create）
- **URL**: `GET/POST /common/cprd_dat/create`
- **入力項目**: 製品ID、LOT番号、分割番号1/2、ランク、数量、加工ID
- **入力検証**: 製品マスタ存在確認、ランクKBN_MST参照確認
- **自動採番**: CPDD_ID（IDENTITY自動採番）
- **初期値設定**: CPDD_FLG=0（有効）

#### 編集機能（/common/cprd_dat/<int:cpdd_id>/edit）
- **URL**: `GET/POST /common/cprd_dat/<cpdd_id>/edit`
- **編集可能項目**: 製品ID、LOT、分割番号、ランク、数量、加工ID
- **編集制限**: 出荷済みデータの編集制御（CSHK_DAT参照あり）
- **更新処理**: トランザクション管理による一括更新

#### 削除機能（/common/cprd_dat/<int:cpdd_id>/delete）
- **URL**: `POST /common/cprd_dat/<cpdd_id>/delete`
- **削除方式**: 論理削除（CPDD_FLG=9設定）
- **削除制限**: 出荷済みデータの削除禁止
- **関連チェック**: CSHK_DAT参照データ存在確認

### 2.3 データ検証・計算機能

#### 在庫残数量計算
- **機能**: `Get_CPRD_ZAN_Qty()` SQL関数
- **計算式**: 入庫数量 - 出荷数量（CSHK_DATから集計）
- **リアルタイム計算**: 出荷データ更新時の自動再計算

#### 入力検証ルール
- **製品ID**: PRD_MST存在確認、有効性チェック
- **数量**: 正の数値、小数点制限
- **日付**: 未来日制限、妥当な日付形式

## 3. 一般出荷データ管理（CSHK_DAT）

### 3.1 機能概要

#### テーブル構造（CSHK_DAT）
```sql
CREATE TABLE CSHK_DAT (
    CSHK_ID decimal(10,0) IDENTITY(1,1) PRIMARY KEY,  -- 出荷ID（自動採番）
    CSHK_KBN decimal(1,0),                            -- 出荷区分
    CSHK_TO decimal(3,0),                             -- 出荷先ID（CZTR_MST参照）
    CSHK_PRC_ID decimal(10,0),                        -- 加工ID
    CSHK_PRD_ID varchar(5),                           -- 製品ID（PRD_MST参照）
    CSHK_DT datetime2,                                -- 出荷日
    CSHK_ORD_DT datetime2,                            -- 手配日
    CSHK_PDD_ID decimal(10,0),                        -- 製造ID（CPRD_DAT参照）
    CSHK_RCP_ID decimal(10,0),                        -- 受注ID
    CSHK_QTY decimal(5,0),                            -- 数量
    CSHK_FLG decimal(1,0)                             -- フラグ（0:有効、9:削除）
);
```

#### 出荷区分管理（CSHK_KBN）
- **1**: 出荷（直接顧客出荷）
- **2**: 加工（外注加工依頼）
- **3**: ロス・廃棄（損失処理）
- **その他**: 区分値はDBConstants.CSHK_KBN_*で定義

#### システム特徴
- **製造ID連携**: CSHK_PDD_IDでCPRD_DATと関連付け
- **出荷先管理**: CSHK_TOでCZTR_MSTと連携
- **手配日管理**: 出荷日とは別に手配日を管理

### 3.2 出荷データCRUD機能

#### 出荷作成機能
- **個別出荷作成**: `/common/cprd_dat/<cpdd_id>/shipment_create` - 特定入庫データからの出荷作成
- **一括出荷作成**: `/common/cprd_dat/shipment` (POST) - 複数データの一括出荷処理
- **入力項目**: 出荷区分、出荷先、数量、出荷日、手配日
- **在庫チェック**: `Get_CPRD_ZAN_Qty()`による残数量確認
- **数量制限**: 在庫残数量以下での出荷数量制限

#### 出荷一覧機能（/common/shipment_list）
- **URL**: `GET /common/shipment_list`
- **検索条件**: 出荷区分、出荷先、期間（出荷日範囲）、製品ID
- **表示項目**: 出荷ID、区分、出荷先名、製品名、数量、出荷日、手配日
- **JOIN**: CZTR_MST（出荷先名）、PRD_MST（製品名）、CPRD_DAT（製造情報）
- **ページング**: 大量データ対応
- **PDF出力**: `/common/export_shipment_pdf`による帳票出力

#### 出荷更新・削除機能
- **更新機能**: `/common/cprd_dat/shipment/update` (POST) - 出荷データ更新
- **削除機能**: `/common/cprd_dat/shipment/delete` (POST) - 論理削除（CSHK_FLG=9）
- **一括削除**: `/common/delete_shipment` (POST) - 複数データ削除
- **制御ロジック**: 加工中データの削除禁止、在庫数量復元処理

### 3.3 出荷検証・制御機能

#### 在庫数量チェック
- **出荷前検証**: 在庫残数量と出荷予定数量の照合
- **超過防止**: 在庫不足時の出荷禁止制御
- **警告表示**: 在庫僅少時の警告メッセージ

#### 出荷先検証
- **マスタ参照**: CZTR_MST有効性確認
- **区分整合性**: 出荷区分と出荷先区分の整合性確認

## 4. 一般加工データ管理（CPRC_DAT）

### 4.1 機能概要

#### テーブル構造
- **CPRC_ID**: 加工データID（主キー）
- **CPRC_CSHK_ID**: 出荷データID（CSHK_DAT参照）
- **CPRC_PRG**: 加工進捗状況
- **CPRC_START_DT**: 加工開始日
- **CPRC_END_DT**: 加工完了予定日
- **CPRC_FLG**: 状態フラグ

#### システム特徴
- **加工トラッキング**: 外注加工の進捗管理
- **スケジュール管理**: 加工期間の管理
- **戻り処理**: 加工完了後の在庫戻し処理

### 4.2 加工プロセス管理

#### 加工依頼処理
- **出荷連携**: CSHK_DAT（加工区分）からの自動連携
- **加工会社選択**: 加工マスタ（CPRC_MST）からの選択
- **スケジュール設定**: 加工期間の設定

#### 進捗管理
- **状況更新**: 加工進捗の段階的更新
- **完了処理**: 加工完了時の在庫戻し処理
- **遅延管理**: 予定超過時の警告・通知

## 5. 共通機能

### 5.1 在庫集計・表示機能

#### 在庫詳細表示（/common/stock_detail/<prd_id>/<rank>）
- **URL**: `GET /common/stock_detail/<prd_id>/<rank>`
- **パラメータ**: 製品ID、ランク指定
- **表示内容**: 
  - 製品情報（PRD_MST連携）
  - ランク別在庫一覧（CPRD_DAT）
  - 出荷履歴（CSHK_DAT）
  - 残数量計算（`Get_CPRD_ZAN_Qty()`関数使用）
- **絞り込み**: 有効データのみ（FLG=0）

#### 在庫集計表示（/common/stock_summary）
- **URL**: `GET /common/stock_summary`
- **集計方式**: 
  - 製品別集計（PRD_ID、RANK別）
  - 総入庫数量、総出荷数量、残数量計算
  - LOT別・分割番号別サマリ
- **表示項目**: 製品ID、製品名、ランク、総入庫数、総出荷数、在庫残数
- **ソート**: 製品ID、ランク順

### 5.2 データ取込機能

#### CSV取込（/common/csv_import）
- **URL**: `GET/POST /common/csv_import`
- **対象ファイル**: CSV形式（拡張子チェック）
- **ファイル制限**: 10MB以下のファイルサイズ制限
- **処理フロー**:
  1. ファイルアップロード・セキュリティチェック（`secure_filename()`）
  2. 一時ディレクトリ保存（`app/temp/`）
  3. CSV解析・データ検証（`import_csv_common()`関数呼び出し）
  4. CPRD_DAT一括登録
  5. 一時ファイル削除
- **エラーハンドリング**: 
  - OperationalError: DB接続エラー
  - SQLAlchemyError: SQL実行エラー
  - Exception: その他予期しないエラー
- **処理結果**: 成功件数・失敗件数・エラー詳細表示

#### API機能群
- **顧客一覧取得**: `/common/api/get_customer_list` - CZTR_MST顧客データ取得
- **加工一覧取得**: `/common/api/get_cprc_list/<prd_id>` - 製品別加工データ取得
- **出荷一覧取得**: `/common/api/get_shipment_list/<cpdd_id>` - 入庫ID別出荷データ取得
- **在庫残数取得**: `/common/api/get_zaiko_zan/<cpdd_id>` - 特定入庫データの残数量取得

### 5.3 検索・フィルタ機能

#### 高度検索
- **複合条件**: 複数条件での絞り込み検索
- **期間指定**: 日付範囲での検索
- **数量範囲**: 在庫数量範囲での検索

#### 表示制御
- **ページング**: 大量データの分割表示
- **ソート**: 各項目でのソート機能
- **表示項目**: 必要項目の選択表示

## 6. 業務フロー

### 6.1 基本入出庫フロー
```
1. 一般製品入庫
   ├─ 製品ID・LOT・ランク設定
   ├─ CPRD_DAT新規登録（CPDD_ID自動採番）
   ├─ 分割番号（SPRIT1/2）設定
   └─ フラグ初期値（CPDD_FLG=0）設定
   ↓
2. 在庫管理・確認
   ├─ Get_CPRD_ZAN_Qty()による残数量計算
   ├─ PRD_MST・KBN_MST結合による詳細表示
   └─ 在庫状況リアルタイム確認
   ↓
3. 出荷処理
   ├─ 出荷区分・出荷先・数量決定
   ├─ 在庫残数量チェック（超過防止）
   ├─ CSHK_DAT作成（CSHK_PDD_ID=CPDD_ID連携）
   ├─ 出荷日・手配日設定
   └─ トランザクション管理による一貫性保証
```

### 6.2 加工依頼フロー
```
1. 加工依頼出荷
   ├─ CSHK_DAT作成（CSHK_KBN=2：加工区分）
   ├─ CSHK_PRC_ID設定（加工ID指定）
   ├─ CSHK_TO設定（加工会社指定）
   └─ 在庫数量減算処理
   ↓
2. 加工プロセス管理
   ├─ CPRC_DAT作成（CSHK_ID連携）
   ├─ 開始日・完了予定日設定
   ├─ 進捗状況更新（CPRC_PRG）
   └─ 加工会社別進捗管理
   ↓
3. 加工完了・戻り処理
   ├─ 加工完了フラグ更新
   ├─ 加工結果データ登録
   ├─ 必要に応じてCPRD_DAT新規作成（戻り在庫）
   └─ 加工履歴・コスト管理
```

### 6.3 CSV取込フロー
```
1. ファイルアップロード
   ├─ CSV形式・サイズ検証
   ├─ secure_filename()によるセキュリティチェック
   └─ 一時ディレクトリ保存
   ↓
2. データ解析・検証
   ├─ CSV内容解析
   ├─ 製品マスタ参照確認
   ├─ データ型・範囲チェック
   └─ 重複データ確認
   ↓
3. 一括登録処理
   ├─ トランザクション開始
   ├─ CPRD_DAT一括INSERT
   ├─ エラー発生時ロールバック
   ├─ 正常時コミット
   └─ 一時ファイル削除
```

## 7. エラーハンドリング・制御

### 7.1 データ整合性制御
- **参照整合性**: 外部キー制約による整合性保証
- **トランザクション管理**: 関連データの一括更新制御
- **ロールバック**: エラー時の一貫した状態復旧

### 7.2 業務ルール制御
- **在庫超過防止**: 出荷数量の在庫数量超過防止
- **重複防止**: 同一データの重複登録防止
- **状態管理**: 各データの状態フラグ管理

### 7.3 ログ・監査機能
- **操作ログ**: 全ての更新操作のログ記録
- **エラーログ**: システムエラーの詳細記録
- **監査証跡**: データ変更の履歴管理

## 8. 関連ファイル・設定

### 8.1 主要実装ファイル
- **ルーティング**: `app/routes_common.py`
- **データモデル**: `app/models_common.py`
- **共通処理**: `app/shipment_common.py`

### 8.2 テンプレートファイル
- **入庫データ管理**: `app/templates/common/cprd_dat_list.html`, `app/templates/common/cprd_dat_create.html`, `app/templates/common/cprd_dat_edit.html`
- **出荷管理**: `app/templates/common/cprd_dat_shipment_create.html`, `app/templates/common/common_shipment_list.html`
- **在庫表示**: `app/templates/common/common_stock_detail.html`, `app/templates/common/common_stock_summary.html`
- **CSV取込**: `app/templates/common/csv_import_common.html`
- **加工依頼**: `app/templates/common/process_request_list.html`

### 8.3 データベース関連
- **テーブル作成**: `sql/CREATE_CPRD_DAT.sql`, `sql/CREATE_CSHK_DAT.sql`, `sql/CREATE_CPRC_DAT.sql`
- **関数定義**: `sql/Get_CPRD_ZAN_Qty.sql`, `sql/Get_CSHK_PRC_ZAN_Qty.sql`
- **制約・インデックス**: 外部キー制約、複合インデックス

---

**作成日**: 2025年7月  
**更新日**: 2025年7月  
**バージョン**: 1.0  
**対象システム**: BFZaiko在庫管理システム（一般入庫管理機能）