# BF在庫検索機能（ノンコート・ハードコート）詳細設計書

## 1. 画面概要

### 画面名
- ノンコート在庫検索画面
- ハードコート在庫検索画面

### 画面目的
レンズの在庫状況を加工種別（ノンコート/ハードコート）ごとに検索・表示し、在庫管理業務と出荷計画の効率化を図る。各在庫に対する受注残数や詳細情報を提供し、直接出荷作成画面へ遷移可能。

### アクセス情報
- **ノンコート在庫検索**
  - URL: `/noncoat-stock`
  - HTTPメソッド: GET, POST
  - 認証: 必須（@login_required）

- **ハードコート在庫検索**
  - URL: `/hardcoat-stock`
  - HTTPメソッド: GET, POST
  - 認証: 必須（@login_required）

## 2. 業務概要

### 主要業務
1. **多条件検索機能**
   - 製品ID、LOT番号、ベース、加入度数、L/R、カラーでの絞り込み
   - 部分一致・完全一致での柔軟な検索

2. **在庫情報表示**
   - 在庫数量の表示（Get_Zaiko_Qty_BF関数使用）
   - 受注残数の表示（Get_ODR_ZAN_Qty_BF関数使用）
   - LOT管理による詳細追跡

3. **出荷連携機能**
   - 検索結果から直接出荷作成画面へ遷移
   - 加工種別に応じた適切な出荷フローへの誘導

4. **PDF出力機能**
   - 検索結果のPDF帳票出力
   - 検索条件を含む詳細レポート生成

### 業務上の重要性
- **在庫の可視化**: リアルタイムでの在庫状況把握
- **出荷効率化**: 在庫検索から出荷作成までのシームレスな連携
- **品質管理**: LOT番号による製造ロット別管理
- **業務統制**: 加工種別による適切な業務フロー制御

### 加工種別による機能差分

#### ノンコート在庫検索
- **対象**: 未加工レンズ（BPDD_PROC = 0）
- **特徴**: ノンコート・ハードコート両方の受注残を表示
- **出荷連携**: 通常の出荷作成画面（/shipping/create）

#### ハードコート在庫検索
- **対象**: 加工済みレンズ（BPDD_PROC = 1）
- **特徴**: ハードコート受注残とコート日を表示
- **出荷連携**: ハードコート専用出荷作成画面（/shipping/create_hard）

## 3. 処理フロー

### 3.1 メイン処理フロー
```
1. 在庫検索画面アクセス（/noncoat-stock または /hardcoat-stock）
   ↓
2. 認証チェック（@login_required）
   ↓
3. GET: 初期画面表示（検索フォーム表示）
   POST: 検索実行
   ↓
4. 検索条件フォーム処理
   ├─ バリデーション実行
   └─ 動的選択肢生成（BfspMst.get_choices）
   ↓
5. 在庫検索実行
   ├─ ノンコート: PrdDat.search_noncoat_stock()
   └─ ハードコート: PrdDat.search_hardcoat_stock()
   ↓
6. 検索結果表示
   ├─ 在庫一覧テーブル表示
   ├─ PDF出力ボタン表示（結果が存在する場合）
   └─ 出荷作成リンク表示
```

### 3.2 在庫検索処理フロー

#### ノンコート在庫検索（PrdDat.search_noncoat_stock()）
```
1. データベースセッション取得
   ↓
2. 基本クエリ構築
   ├─ BPRD_DAT（製造データ）をベースとする
   ├─ BFSP_MST（BF規格マスタ）とLEFT JOIN
   └─ BRCP_DAT（受注データ）とLEFT JOIN
   ↓
3. 検索条件適用
   ├─ BPDD_PROC = 0（ノンコート）で絞り込み
   ├─ Get_Zaiko_Qty_BF() > 0（在庫有り）で絞り込み
   └─ 各検索条件でのフィルタリング
   ↓
4. 受注残数計算
   ├─ NC残: Get_ODR_ZAN_Qty_BF（PROC=0）
   └─ HC残: Get_ODR_ZAN_Qty_BF（PROC=1）
   ↓
5. 並び順設定（カラー→ベース→加入度数→LR→LOT）
   ↓
6. 検索結果返却
```

#### ハードコート在庫検索（PrdDat.search_hardcoat_stock()）
```
1. データベースセッション取得
   ↓
2. 基本クエリ構築
   ├─ BPRD_DAT（製造データ）をベースとする
   ├─ BFSP_MST（BF規格マスタ）とLEFT JOIN
   └─ BRCP_DAT（受注データ）とLEFT JOIN
   ↓
3. 検索条件適用
   ├─ BPDD_PROC = 1（ハードコート）で絞り込み
   ├─ Get_Zaiko_Qty_BF() > 0（在庫有り）で絞り込み
   └─ 各検索条件でのフィルタリング
   ↓
4. 受注残数・コート日取得
   ├─ HC残: Get_ODR_ZAN_Qty_BF（PROC=1）
   └─ コート日: BPDD_CRT
   ↓
5. 並び順設定（カラー→ベース→加入度数→LR→LOT）
   ↓
6. 検索結果返却
```

### 3.3 PDF出力処理フロー
```
1. PDF出力リンククリック（/noncoat_stock_pdf または /hardcoat_stock_pdf）
   ↓
2. URLパラメータから検索条件取得
   ↓
3. 同一検索条件で在庫検索再実行
   ↓
4. PDF生成処理
   ├─ ReportLabライブラリ使用
   ├─ 日本語フォント自動選択
   └─ A4サイズ、適切なマージン設定
   ↓
5. PDFファイル返却（noncoat_stocks.pdf / hardcoat_stocks.pdf）
```

## 4. 画面レイアウト

### 4.1 画面構造
```
├── base.html（共通テンプレート）
│   ├── 共通ヘッダー（ナビゲーション）
│   ├── サイドメニュー
│   └── メインコンテンツエリア
│       ├── ページタイトル
│       ├── 検索条件セクション
│       ├── 検索ボタン・PDF出力ボタン
│       └── 検索結果テーブル
```

### 4.2 検索条件セクション
```
┌─────────────────────────────────────────────────────────────┐
│                   在庫検索条件                              │
├─────────────────────────────────────────────────────────────┤
│ 製品ID: [____]  LOT: [____]    ベース: [選択▼]            │
│ 加入度数: [選択▼]  L/R: [選択▼]  カラー: [選択▼]           │
│                                                             │
│ [検索実行] [クリア] [PDF出力] ※PDF出力は検索結果有時のみ    │
└─────────────────────────────────────────────────────────────┘
```

### 4.3 ノンコート在庫検索結果テーブル
```
┌───────┬───────┬──────┬──────┬──────┬──────┬──────┬──────┬──────┬──────┐
│製造ID │ LOT  │ベース│加入度数│ L/R │カラー│在庫数│NC残 │HC残 │ 操作 │
├───────┼───────┼──────┼──────┼──────┼──────┼──────┼──────┼──────┼──────┤
│ 12345 │ 001  │  2   │ 150  │  L  │ BR  │ 100 │  30 │  20 │[出荷]│
│ 12346 │ 002  │  4   │ 200  │  R  │ SG  │  50 │   0 │  10 │[出荷]│
└───────┴───────┴──────┴──────┴──────┴──────┴──────┴──────┴──────┴──────┘
```

### 4.4 ハードコート在庫検索結果テーブル
```
┌───────┬───────┬──────┬──────┬──────┬──────┬──────┬──────┬─────────┬──────┐
│製造ID │ LOT  │ベース│加入度数│ L/R │カラー│在庫数│HC残 │コート日 │ 操作 │
├───────┼───────┼──────┼──────┼──────┼──────┼──────┼──────┼─────────┼──────┤
│ 12347 │ 003  │  2   │ 150  │  L  │ BR  │  80 │  25 │2025-07-15│[出荷]│
│ 12348 │ 004  │  6   │ 225  │  R  │ GY  │  30 │   5 │2025-07-16│[出荷]│
└───────┴───────┴──────┴──────┴──────┴──────┴──────┴──────┴─────────┴──────┘
```

## 5. データ項目

### 5.1 検索条件項目

#### 製品ID
- **項目名**: product_id
- **データソース**: BFSP_MST.BFSP_PRD_ID
- **データ型**: VARCHAR(4)
- **入力方式**: テキスト入力（部分一致検索）
- **必須/任意**: 任意

#### LOT番号
- **項目名**: lot
- **データソース**: BPRD_DAT.BPDD_LOT
- **データ型**: NUMERIC(6,0)
- **入力方式**: 数値入力（完全一致検索）
- **必須/任意**: 任意

#### ベース
- **項目名**: base
- **データソース**: BFSP_MST.BFSP_BASE
- **データ型**: NUMERIC(1,0)
- **入力方式**: セレクトボックス（動的選択肢）
- **必須/任意**: 任意

#### 加入度数
- **項目名**: adp
- **データソース**: BFSP_MST.BFSP_ADP
- **データ型**: NUMERIC(3,0)
- **入力方式**: セレクトボックス（動的選択肢）
- **必須/任意**: 任意

#### L/R
- **項目名**: lr
- **データソース**: BFSP_MST.BFSP_LR
- **データ型**: VARCHAR(1)
- **入力方式**: セレクトボックス（動的選択肢）
- **必須/任意**: 任意

#### カラー
- **項目名**: clr
- **データソース**: BFSP_MST.BFSP_CLR
- **データ型**: VARCHAR(2)
- **入力方式**: セレクトボックス（動的選択肢）
- **必須/任意**: 任意

### 5.2 表示項目

#### 共通表示項目

##### 製造ID
- **データソース**: BPRD_DAT.BPDD_ID
- **表示形式**: 数値（5桁）
- **説明**: 製造データの一意識別子

##### LOT番号
- **データソース**: BPRD_DAT.BPDD_LOT
- **表示形式**: 数値（3桁、ゼロ埋め）
- **説明**: 製造ロット番号

##### 製品仕様（ベース、加入度数、L/R、カラー）
- **データソース**: BFSP_MST各項目
- **表示形式**: 製品識別用の参考情報
- **説明**: レンズの物理的仕様

##### 在庫数
- **データソース**: Get_Zaiko_Qty_BF(BPDD_ID)
- **表示形式**: 数値（正の整数のみ表示）
- **説明**: 現在の利用可能在庫数

#### ノンコート固有項目

##### NC残（ノンコート受注残）
- **データソース**: Get_ODR_ZAN_Qty_BF（PROC=0）
- **表示形式**: 数値（0以上）
- **説明**: ノンコート出荷予定数量

##### HC残（ハードコート受注残）
- **データソース**: Get_ODR_ZAN_Qty_BF（PROC=1）
- **表示形式**: 数値（0以上）
- **説明**: ハードコート出荷予定数量

#### ハードコート固有項目

##### HC残（ハードコート受注残）
- **データソース**: Get_ODR_ZAN_Qty_BF（PROC=1）
- **表示形式**: 数値（0以上）
- **説明**: ハードコート出荷予定数量

##### コート日
- **データソース**: BPRD_DAT.BPDD_CRT
- **表示形式**: 日付（YYYY-MM-DD）
- **説明**: ハードコート加工実施日

## 6. 業務ルール

### 6.1 検索対象制限
- **ノンコート**: BPDD_PROC = 0（未加工レンズ）のみ
- **ハードコート**: BPDD_PROC = 1（加工済レンズ）のみ
- **在庫有りのみ**: Get_Zaiko_Qty_BF() > 0 の条件で絞り込み

### 6.2 検索方式
- **製品ID**: 部分一致検索（前方一致）
- **LOT番号**: 完全一致検索
- **その他項目**: 完全一致検索（選択肢から選択）

### 6.3 並び順ルール
1. カラー（BFSP_CLR）昇順
2. ベース（BFSP_BASE）昇順
3. 加入度数（BFSP_ADP）昇順
4. L/R（BFSP_LR）昇順
5. LOT番号（BPDD_LOT）昇順

### 6.4 出荷連携ルール
- **ノンコート**: `/shipping/create/<stock_id>` へ遷移
- **ハードコート**: `/shipping/create_hard/<stock_id>` へ遷移
- **stock_id**: BPDD_ID（製造データの主キー）を使用

## 7. フォーム仕様

### 7.1 フォームクラス
- **ファイル**: `app/forms.py`
- **クラス**: `NoncoatStockSearchForm`（両機能で共通使用）

### 7.2 動的選択肢生成
```python
# 選択肢は製品マスタから動的に生成
form.base.choices = BfspMst.get_choices('BFSP_BASE')
form.adp.choices = BfspMst.get_choices('BFSP_ADP')
form.lr.choices = BfspMst.get_choices('BFSP_LR')
form.clr.choices = BfspMst.get_choices('BFSP_CLR')
```

### 7.3 CSRF保護
- **WTForms**: 自動CSRFトークン生成
- **テンプレート**: `{{ csrf_token() }}` による保護

## 8. PDF出力機能

### 8.1 PDF出力URL
- **ノンコート**: `/noncoat_stock_pdf`
- **ハードコート**: `/hardcoat_stock_pdf`

### 8.2 PDF生成仕様
- **ライブラリ**: ReportLab
- **用紙サイズ**: A4
- **フォント**: 日本語対応フォント自動選択
- **ファイル名**: 
  - ノンコート: `noncoat_stocks.pdf`
  - ハードコート: `hardcoat_stocks.pdf`

### 8.3 PDF内容
- **ヘッダー**: タイトル、出力日時
- **検索条件**: 指定された検索条件の表示
- **データ**: 検索結果データの表形式表示
- **フッター**: ページ番号

## 9. エラーハンドリング

### 9.1 検索エラーパターン
- **データベース接続エラー**: 「データベースに接続できません」
- **SQL実行エラー**: 「検索処理でエラーが発生しました」
- **検索結果なし**: 「検索条件に一致するデータが見つかりません」

### 9.2 PDF出力エラーパターン
- **PDF生成エラー**: 「PDF生成に失敗しました」
- **ファイル出力エラー**: 「ファイル出力でエラーが発生しました」

### 9.3 エラーハンドリング方法
- **ログ出力**: log_error()関数でサーバーログ記録
- **ユーザー通知**: flashメッセージでエラー内容表示
- **セッション管理**: finally節で確実なセッションクローズ

## 10. 関連ファイル・関数

### 10.1 主要ファイル
- **ルーティング**: `app/routes.py`
  - `noncoat_stock_search()` (268-296行)
  - `hardcoat_stock_search()` (344-372行)
  - `noncoat_stock_pdf()` (298-342行)
  - `hardcoat_stock_pdf()` (374-418行)

- **モデル**: `app/models.py`
  - `PrdDat.search_noncoat_stock()` (656-719行)
  - `PrdDat.search_hardcoat_stock()` (722-786行)

- **フォーム**: `app/forms.py`
  - `NoncoatStockSearchForm` (8-14行)

- **テンプレート**:
  - `app/templates/noncoat_stock_search.html`
  - `app/templates/hardcoat_stock_search.html`

- **PDF出力**: `app/export_pdf.py`
  - `noncoat_stock_export_pdf()` (186-279行)
  - `hardcoat_stock_export_pdf()` (281-376行)

### 10.2 データベーステーブル
- **BPRD_DAT**: 製造データテーブル（メイン）
- **BFSP_MST**: BF規格マスタテーブル
- **BRCP_DAT**: 受注データテーブル（受注残計算用）

### 10.3 SQL関数
- **Get_Zaiko_Qty_BF()**: 在庫数量計算関数
- **Get_ODR_ZAN_Qty_BF()**: 受注残数量計算関数

### 10.4 定数ファイル
- **app/constants.py**: DatabaseConstants クラス
  - PROC_NON_COAT (0)
  - PROC_HARD_COAT (1)

## 11. セキュリティ仕様

### 11.1 認証・認可
- **ログイン必須**: @login_required デコレータ
- **セッション管理**: Flask標準セッション機能

### 11.2 入力検証
- **WTForms**: フォームバリデーション
- **CSRF保護**: 自動CSRFトークン検証
- **SQLインジェクション対策**: パラメータ化クエリ使用

### 11.3 データ保護
- **機密データ**: 在庫数・受注残数の適切な表示制御
- **ログ記録**: 検索操作・エラーの詳細ログ出力

---

**作成日**: 2025年7月  
**更新日**: 2025年7月  
**バージョン**: 1.0  
**対象システム**: BFZaiko在庫管理システム