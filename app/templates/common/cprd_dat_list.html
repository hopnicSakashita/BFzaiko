{% extends "base.html" %}

{% block title %}入庫データ一覧{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">入庫データ一覧</h2>
            
            <!-- 検索フォーム -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">検索条件</h5>
                </div>
                <div class="card-body">
                    <form method="GET" action="{{ url_for('common.cprd_dat_list') }}" id="searchForm">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="prd_id" class="form-label">製品ID</label>
                                <div class="input-group">
                                    <select class="form-control" id="prd_id_select" style="border-radius: 0.375rem 0 0 0.375rem;">
                                        <option value="">選択してください</option>
                                        {% for prd in prd_list %}
                                        <option value="{{ prd.PRD_ID }}" {{ 'selected' if search_prd_id == prd.PRD_ID else '' }}>
                                            {{ prd.PRD_ID }} - {{ prd.PRD_DSP_NM or prd.PRD_NAME or '' }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <span class="input-group-text" style="border-radius: 0;">または</span>
                                    <input type="text" class="form-control" id="prd_id_input" name="prd_id" 
                                           placeholder="製品IDを直接入力" maxlength="5" 
                                           value="{{ search_prd_id or '' }}" 
                                           style="border-radius: 0 0.375rem 0.375rem 0;">
                                </div>
                                <div class="form-text">製品IDを選択するか、直接入力してください（5文字以内）</div>
                            </div>
                            <div class="col-md-2">
                                <label for="prd_name" class="form-label">製品名</label>
                                <input type="text" class="form-control" id="prd_name" name="prd_name" 
                                       value="{{ search_prd_name or '' }}" placeholder="部分一致検索">
                            </div>
                            <div class="col-md-2">
                                <label for="lot" class="form-label">LOT</label>
                                <input type="number" class="form-control" id="lot" name="lot" 
                                       value="{{ search_lot or '' }}" min="0" max="999999">
                            </div>
                            <div class="col-md-2">
                                <label for="rank" class="form-label">ランク</label>
                                <select class="form-control" id="rank" name="rank">
                                    <option value="">選択してください</option>
                                    {% for rank in rank_list %}
                                    <option value="{{ rank.KBN_NO }}" 
                                            {{ 'selected' if search_rank == rank.KBN_NO|string else '' }}>
                                        {{ rank.KBN_NO }} - {{ rank.KBN_NM }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="stock_status" class="form-label">在庫状況</label>
                                <select class="form-control" id="stock_status" name="stock_status">
                                    <option value="">全て</option>
                                    <option value="1" {{ 'selected' if search_stock_status == '1' else '' }}>在庫あり</option>
                                    <option value="0" {{ 'selected' if search_stock_status == '0' else '' }}>在庫なし</option>
                                </select>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button type="submit" name="search" value="1" class="btn btn-primary me-2">検索</button>
                                <a href="{{ url_for('common.cprd_dat_list') }}" class="btn btn-secondary me-2">クリア</a>
                                <a href="{{ url_for('common.cprd_dat_create') }}" class="btn btn-success">新規追加</a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- データ一覧 -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        入庫データ一覧 
                        {% if cprd_list %}
                            <span class="badge bg-primary">{{ cprd_list|length }}件</span>
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    {% if is_search_executed %}
                        {% if cprd_list %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>入庫ID</th>
                                        <th>製品ID</th>
                                        <th>製品名</th>
                                        <th>LOT</th>
                                        <th>分割1</th>
                                        <th>分割2</th>
                                        <th>ランク</th>
                                        <th>入庫数量</th>
                                        <th>在庫残</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for cprd in cprd_list %}
                                    <tr>
                                        <td>{{ cprd.CPDD_ID }}</td>
                                        <td>{{ cprd.CPDD_PRD_ID or '' }}</td>
                                        <td>{{ cprd.PRD_DSP_NM or '－' }}</td>
                                        <td>{{ cprd.CPDD_LOT or '' }}</td>
                                        <td>{{ cprd.CPDD_SPRIT1 or '' }}</td>
                                        <td>{{ cprd.CPDD_SPRIT2 or '' }}</td>
                                        <td>{{ cprd.RANK_NAME or '－' }}</td>
                                        <td>{{ cprd.CPDD_QTY or '' }}</td>
                                        <td>
                                            {% if cprd.ZAIKO_ZAN is defined %}
                                                <span class="badge {{ 'bg-success' if cprd.ZAIKO_ZAN > 0 else 'bg-warning' if cprd.ZAIKO_ZAN == 0 else 'bg-danger' }}">
                                                    {{ cprd.ZAIKO_ZAN or 0 }}
                                                </span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                {% if cprd.CPDD_FLG == 0 %}
                                                <a href="{{ url_for('common.cprd_dat_edit', cpdd_id=cprd.CPDD_ID) }}" 
                                                   class="btn btn-sm btn-outline-primary" title="編集">
                                                    <i class="bi bi-pencil-square"></i> 編集
                                                </a>
                                                {% if cprd.ZAIKO_ZAN and cprd.ZAIKO_ZAN > 0 %}
                                                <a href="{{ url_for('common.cprd_dat_shipment_create', cpdd_id=cprd.CPDD_ID) }}" 
                                                   class="btn btn-sm btn-outline-info" title="出庫">
                                                    <i class="bi bi-box-arrow-right"></i> 出庫
                                                </a>
                                                {% else %}
                                                <span class="btn btn-sm btn-outline-secondary" title="在庫残がないため出庫不可">
                                                    <i class="bi bi-box-arrow-right"></i> 出庫不可
                                                </span>
                                                {% endif %}
                                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                                        onclick="confirmDelete({{ cprd.CPDD_ID }})" title="削除">
                                                    <i class="bi bi-trash"></i> 削除
                                                </button>
                                                {% else %}
                                                <span class="btn btn-sm btn-outline-secondary" title="フラグが0以外のため編集不可">
                                                    <i class="bi bi-pencil-square"></i> 編集不可
                                                </span>
                                                <span class="btn btn-sm btn-outline-secondary" title="フラグが0以外のため出庫不可">
                                                    <i class="bi bi-box-arrow-right"></i> 出庫不可
                                                </span>
                                                <span class="btn btn-sm btn-outline-secondary" title="フラグが0以外のため削除不可">
                                                    <i class="bi bi-trash"></i> 削除不可
                                                </span>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <p class="text-muted">検索条件に一致するデータが見つかりませんでした。</p>
                            <a href="{{ url_for('common.cprd_dat_create') }}" class="btn btn-primary">
                                <i class="bi bi-plus-circle"></i> 新規作成
                            </a>
                        </div>
                        {% endif %}
                    {% else %}
                    <div class="text-center py-4">
                        <p class="text-muted">検索条件を入力して「検索」ボタンを押してください。</p>
                        <a href="{{ url_for('common.cprd_dat_create') }}" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> 新規作成
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 削除確認モーダル -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">削除確認</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>この入庫データを削除してもよろしいですか？</p>
                <p class="text-danger">この操作は元に戻せません。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">削除</button>
            </div>
        </div>
    </div>
</div>

<!-- 出庫モーダル -->
<div class="modal fade" id="shipmentModal" tabindex="-1" aria-labelledby="shipmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shipmentModalLabel">出庫処理</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="shipmentForm">
                    <!-- 基本情報（表示のみ） -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">入庫ID</label>
                            <input type="text" class="form-control" id="shipment_cpdd_id" readonly>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">製品ID</label>
                            <input type="text" class="form-control" id="shipment_prd_id" readonly>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">在庫残数量</label>
                            <input type="text" class="form-control" id="shipment_zaiko_zan" readonly>
                        </div>
                    </div>
                    
                    <!-- 出荷区分選択 -->
                    <div class="mb-3">
                        <label for="shipment_kbn" class="form-label">出荷区分 <span class="text-danger">*</span></label>
                        <select class="form-control" id="shipment_kbn" name="shipment_kbn" required onchange="onShipmentKbnChange()">
                            <option value="">選択してください</option>
                            <option value="0">出荷</option>
                            <option value="1">加工</option>
                            <option value="2">欠損</option>
                        </select>
                    </div>
                    
                    <!-- 共通項目 -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="shipment_qty" class="form-label">出庫数量 <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="shipment_qty" name="shipment_qty" 
                                   min="1" required placeholder="出庫数量を入力">
                            <div class="form-text">1以上の数値を入力してください（在庫残数量以下）</div>
                        </div>
                        <div class="col-md-4">
                            <label for="shipment_dt" class="form-label">出荷日 <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="shipment_dt" name="shipment_dt" required>
                        </div>
                        <div class="col-md-4">
                            <label for="shipment_ord_dt" class="form-label">注文日 <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="shipment_ord_dt" name="shipment_ord_dt" required>
                        </div>
                    </div>
                    
                    <!-- 出荷先選択（出荷時のみ表示） -->
                    <div class="mb-3" id="shipment_to_group" style="display: none;">
                        <label for="shipment_to" class="form-label">出荷先 <span class="text-danger">*</span></label>
                        <select class="form-control" id="shipment_to" name="shipment_to">
                            <option value="">選択してください</option>
                            <!-- JavaScript で動的に設定 -->
                        </select>
                    </div>
                    
                    <!-- 加工ID選択（加工時のみ表示） -->
                    <div class="mb-3" id="shipment_prc_id_group" style="display: none;">
                        <label for="shipment_prc_id" class="form-label">加工ID <span class="text-danger">*</span></label>
                        <select class="form-control" id="shipment_prc_id" name="shipment_prc_id">
                            <option value="">選択してください</option>
                            <!-- JavaScript で動的に設定 -->
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-info" id="confirmShipmentBtn">出庫実行</button>
            </div>
        </div>
    </div>
</div>

<script>
let deleteId = null;
let shipmentData = null;

function confirmDelete(cpddId) {
    deleteId = cpddId;
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

function showShipmentModal(cpddId, prdId, zaikoZan) {
    shipmentData = {
        cpddId: cpddId,
        prdId: prdId,
        zaikoZan: zaikoZan
    };
    
    // フォームの初期値設定
    document.getElementById('shipment_cpdd_id').value = cpddId;
    document.getElementById('shipment_prd_id').value = prdId;
    document.getElementById('shipment_zaiko_zan').value = zaikoZan;
    document.getElementById('shipment_qty').value = '';
    document.getElementById('shipment_qty').max = zaikoZan;
    document.getElementById('shipment_kbn').value = '';
    document.getElementById('shipment_dt').value = new Date().toISOString().split('T')[0];
    document.getElementById('shipment_ord_dt').value = new Date().toISOString().split('T')[0];
    
    // フィールドグループを初期化
    resetShipmentFields();
    
    const modal = new bootstrap.Modal(document.getElementById('shipmentModal'));
    modal.show();
}

// 出荷区分変更時の処理
function onShipmentKbnChange() {
    const kbn = document.getElementById('shipment_kbn').value;
    resetShipmentFields();
    
    if (kbn === '0') {  // 出荷
        showShipmentToGroup();
    } else if (kbn === '1') {  // 加工
        showShipmentPrcIdGroup();
    } else if (kbn === '2') {  // 欠損
        // 欠損の場合は追加の入力項目なし
    }
}

// フィールドグループのリセット
function resetShipmentFields() {
    document.getElementById('shipment_to_group').style.display = 'none';
    document.getElementById('shipment_prc_id_group').style.display = 'none';
    document.getElementById('shipment_to').value = '';
    document.getElementById('shipment_prc_id').value = '';
    document.getElementById('shipment_to').innerHTML = '<option value="">選択してください</option>';
    document.getElementById('shipment_prc_id').innerHTML = '<option value="">選択してください</option>';
}

// 出荷先グループの表示と得意先リストの取得
function showShipmentToGroup() {
    document.getElementById('shipment_to_group').style.display = 'block';
    
    // 得意先リストを取得
    fetch('/common/api/get_customer_list')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('shipment_to');
                select.innerHTML = '<option value="">選択してください</option>';
                data.data.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.CZTR_ID;
                    option.textContent = `${customer.CZTR_ID} - ${customer.CZTR_NM}`;
                    select.appendChild(option);
                });
            } else {
                alert('得意先リストの取得に失敗しました: ' + (data.error || ''));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('得意先リストの取得中にエラーが発生しました');
        });
}

// 加工IDグループの表示と加工リストの取得
function showShipmentPrcIdGroup() {
    document.getElementById('shipment_prc_id_group').style.display = 'block';
    
    if (!shipmentData || !shipmentData.prdId) {
        alert('製品IDが取得できません');
        return;
    }
    
    // 加工リストを取得
    fetch(`/common/api/get_cprc_list/${shipmentData.prdId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('shipment_prc_id');
                select.innerHTML = '<option value="">選択してください</option>';
                data.data.forEach(cprc => {
                    const option = document.createElement('option');
                    option.value = cprc.CPRC_ID;
                    option.textContent = `${cprc.CPRC_ID} - ${cprc.CPRC_NM}`;
                    select.appendChild(option);
                });
            } else {
                alert('加工リストの取得に失敗しました: ' + (data.error || ''));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('加工リストの取得中にエラーが発生しました');
        });
}

document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
    if (deleteId) {
        fetch(`{{ url_for('common.cprd_dat_delete', cpdd_id=0) }}`.replace('0', deleteId), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() if csrf_token else '' }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('削除に失敗しました: ' + (data.error || '不明なエラー'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('削除処理中にエラーが発生しました');
        });
    }
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
    modal.hide();
});

// 出庫処理
document.getElementById('confirmShipmentBtn').addEventListener('click', function() {
    if (!shipmentData) return;
    
    const kbn = document.getElementById('shipment_kbn').value;
    const qty = parseInt(document.getElementById('shipment_qty').value);
    const dt = document.getElementById('shipment_dt').value;
    const ordDt = document.getElementById('shipment_ord_dt').value;
    const to = document.getElementById('shipment_to').value;
    const prcId = document.getElementById('shipment_prc_id').value;
    
    // 基本バリデーション
    if (!kbn) {
        alert('出荷区分を選択してください。');
        return;
    }
    
    if (!qty || qty <= 0) {
        alert('出庫数量を正しく入力してください。');
        return;
    }
    
    if (qty > shipmentData.zaikoZan) {
        alert('出庫数量が在庫残数量を超えています。');
        return;
    }
    
    if (!dt) {
        alert('出荷日を入力してください。');
        return;
    }
    
    if (!ordDt) {
        alert('注文日を入力してください。');
        return;
    }
    
    // 出荷区分別バリデーション
    if (kbn === '0' && !to) {  // 出荷
        alert('出荷先を選択してください。');
        return;
    }
    
    if (kbn === '1' && !prcId) {  // 加工
        alert('加工IDを選択してください。');
        return;
    }
    
    // リクエストデータを構築
    const requestData = {
        cpdd_id: shipmentData.cpddId,
        cshk_kbn: parseInt(kbn),
        qty: qty,
        cshk_dt: dt,
        cshk_ord_dt: ordDt
    };
    
    // 出荷区分別の項目を追加
    if (kbn === '0') {  // 出荷
        requestData.cshk_to = parseInt(to);
    } else if (kbn === '1') {  // 加工
        requestData.cshk_prc_id = parseInt(prcId);
    }
    
    // 出庫処理実行
    fetch(`{{ url_for('common.cprd_dat_shipment') }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() if csrf_token else '' }}'
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message || '出庫処理が完了しました。');
            location.reload();
        } else {
            alert('出庫処理に失敗しました: ' + (data.error || '不明なエラー'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('出庫処理中にエラーが発生しました');
    });
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('shipmentModal'));
    modal.hide();
});

// 出庫数量の入力チェック
document.getElementById('shipment_qty').addEventListener('input', function() {
    const qty = parseInt(this.value);
    const maxQty = shipmentData ? shipmentData.zaikoZan : 0;
    
    if (qty > maxQty) {
        this.setCustomValidity(`出庫数量は${maxQty}以下で入力してください。`);
    } else {
        this.setCustomValidity('');
    }
});

// 製品IDの選択と入力の連動
const prdIdSelect = document.getElementById('prd_id_select');
const prdIdInput = document.getElementById('prd_id_input');

// セレクトボックスが変更されたとき、入力フィールドをクリア
prdIdSelect.addEventListener('change', function() {
    if (this.value) {
        prdIdInput.value = '';
    }
});

// 入力フィールドが変更されたとき、セレクトボックスをリセット
prdIdInput.addEventListener('input', function() {
    if (this.value) {
        prdIdSelect.value = '';
    }
});

// フォーム送信時の処理
document.getElementById('searchForm').addEventListener('submit', function(e) {
    // 入力フィールドに値がある場合は、それを優先
    if (prdIdInput.value.trim()) {
        // 入力フィールドの値をそのまま使用
    } else if (prdIdSelect.value) {
        // セレクトボックスの値を入力フィールドに設定
        prdIdInput.value = prdIdSelect.value;
    }
    
    // 500件超過時の確認ダイアログ
    const formData = new FormData(this);
    const hasConditions = formData.get('prd_id') || formData.get('prd_name') || formData.get('lot') || formData.get('rank');
    
    if (hasConditions && formData.get('search') === '1') {
        // 検索条件が設定されている場合は一旦実行を許可
        return true;
    }
});

// 検索実行時の500件チェック
{% if is_search_executed %}
document.addEventListener('DOMContentLoaded', function() {
    const resultCount = {{ cprd_list|length }};
    if (resultCount > 500) {
        const message = `検索結果が${resultCount}件表示されています。表示に時間がかかる場合があります。`;
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-warning alert-dismissible fade show mt-3';
        alertDiv.innerHTML = `
            <i class="bi bi-exclamation-triangle"></i> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // サイドメニューがある場合のメッセージ表示位置調整
        const mainContent = document.querySelector('.container-fluid .row .col-12');
        if (mainContent) {
            mainContent.insertBefore(alertDiv, mainContent.firstChild);
        } else {
            const container = document.querySelector('.container-fluid');
            container.insertBefore(alertDiv, container.firstChild);
        }
    }
});
{% endif %}
</script>
{% endblock %} 