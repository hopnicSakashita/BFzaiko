====================================================================
在庫管理システム - バーコード関連画面 詳細設計書
====================================================================

■ 1. 画面概要
====================================================================
【画面名】
　1. バーコードCSV取込画面
　2. バーコード読込画面
　3. バーコード読込（CSV）画面

【画面目的】
　1. バーコードCSV取込画面
　　- バーコードマスタデータをCSVファイルから一括取込する
　　- 取込結果の確認とエラー表示を行う

　2. バーコード読込画面
　　- 製品情報を入力してバーコードを生成する
　　- カメラを使用したバーコードの読み取りをサポート
　　- 製品情報とバーコードの紐付けを管理

　3. バーコード読込（CSV）画面
　　- 既存のバーコードマスタからバーコードを選択
　　- カメラを使用したバーコードの読み取りをサポート
　　- バーコードの検証と結果表示

【アクセス情報】
　1. バーコードCSV取込画面
　　- URL: /barcode_import
　　- HTTP メソッド: GET, POST
　　- 認証: 必須 (@login_required)

　2. バーコード読込画面
　　- URL: /barcode_scan
　　- HTTP メソッド: GET, POST
　　- 認証: 必須 (@login_required)

　3. バーコード読込（CSV）画面
　　- URL: /barcode_scan_csv
　　- HTTP メソッド: GET, POST
　　- 認証: 必須 (@login_required)

■ 2. 業務概要
====================================================================
【主要業務】
　1. バーコードCSV取込画面
　　- CSVファイルのアップロード
　　- ヘッダー行の有無設定
　　- 取込結果の表示
　　- エラー情報の表示

　2. バーコード読込画面
　　- 製品情報入力によるバーコード生成
　　- バーコード検証
　　- カメラによるバーコード読み取り
　　- 製品情報の表示

　3. バーコード読込（CSV）画面
　　- バーコードマスタからの選択
　　- バーコード検証
　　- カメラによるバーコード読み取り
　　- 検証結果の表示と音声フィードバック

【業務上の重要性】
　- バーコードによる在庫管理の基盤となる画面
　- 製品の追跡可能性を確保する重要な機能
　- 在庫管理の効率化と正確性向上に寄与

【重要な業務ルール】
　- CSVファイルの形式は固定（BBCD_ID, BBCD_NO, BBCD_NM）
　- バーコードの重複は許可しない
　- カメラ読み取りはDataMatrix形式に特化
　- 製品情報とバーコードの紐付けは必須
　- 検証結果は音声でフィードバック

■ 3. 処理フロー
====================================================================
【3.1 バーコードCSV取込処理フロー】
```
1. 画面アクセス（/barcode_import）
　　↓
2. 認証チェック（@login_required）
　　↓
3. barcode_import()関数実行
　　↓
4. GET: テンプレートレンダリング（初期表示）
   POST: フォームデータ処理
　　↓
5. CSVファイルアップロード
　　↓
6. CSVファイル解析
　　├─ ヘッダー行チェック
　　└─ データ形式検証
　　↓
7. データベース保存
　　├─ 重複チェック
　　└─ エラーハンドリング
　　↓
8. 結果表示
```

【3.2 バーコード読込（CSV）処理フロー】
```
1. 画面アクセス（/barcode_scan_csv）
　　↓
2. 認証チェック（@login_required）
　　↓
3. barcode_scan_csv()関数実行
　　↓
4. バーコードマスタデータ取得
　　↓
5. テンプレートレンダリング
　　↓
6. バーコード選択
　　↓
7. カメラ読み取り
　　├─ カメラ起動
　　├─ バーコード検出
　　└─ 検証処理
　　↓
8. 結果表示と音声フィードバック
```

■ 4. 画面レイアウト
====================================================================
【4.1 バーコードCSV取込画面】
```
┌─────────────────────────────────────────────────────────────┐
│                     バーコードCSV取込                        │
├─────────────────────────────────────────────────────────────┤
│ CSVファイルを選択                                           │
│ [ファイル選択]                                              │
│ CSVファイルの形式：BBCD_ID, BBCD_NO, BBCD_NM               │
│                                                             │
│ [ ] ヘッダー行を含む                                        │
│                                                             │
│ [アップロード]                                              │
└─────────────────────────────────────────────────────────────┘
```

【4.2 バーコード読込（CSV）画面】
```
┌─────────────────────────────────────────────────────────────┐
│                     バーコード読込                          │
├─────────────────────────────────────────────────────────────┤
│ バーコード選択                                             │
│ [バーコード選択▼]                                          │
│                                                             │
│ バーコード入力                                             │
│ [バーコード入力欄]                                         │
│ 検証データ：[検証データ表示欄]                             │
│                                                             │
│ 検証結果                                                   │
│ [結果表示エリア]                                           │
│                                                             │
│ カメラ読み取り                                             │
│ [カメラ起動] [カメラ停止]                                  │
│ [カメラ表示エリア]                                         │
└─────────────────────────────────────────────────────────────┘
```

■ 5. データ項目
====================================================================
【5.1 バーコードCSV取込画面】

◆ CSVファイル
　- 項目ID: file
　- データ型: FILE
　- 入力方式: ファイル選択
　- 必須/任意: 必須
　- ファイル形式: .csv

◆ ヘッダー行
　- 項目ID: hasHeader
　- データ型: BOOLEAN
　- 入力方式: チェックボックス
　- 必須/任意: 任意
　- 初期値: false

【5.2 バーコード読込（CSV）画面】

◆ バーコード選択
　- 項目ID: bcdSelect
　- データ型: VARCHAR(60)
　- 入力方式: セレクトボックス
　- 必須/任意: 必須
　- データソース: BBCD_MST

◆ バーコード入力
　- 項目ID: barcodeInput
　- データ型: VARCHAR(60)
　- 入力方式: テキスト入力
　- 必須/任意: 任意
　- 入力制限: 制御文字不可

◆ 検証データ
　- 項目ID: validationStr
　- データ型: VARCHAR(60)
　- 表示方式: テキスト表示
　- 更新: バーコード選択時

■ 6. 業務ルール
====================================================================
【6.1 CSV取込ルール】
　- CSVファイルの形式は固定（BBCD_ID, BBCD_NO, BBCD_NM）
　- BBCD_IDは3文字以内
　- BBCD_NOは60文字以内
　- BBCD_NMは30文字以内
　- 重複データはスキップ
　- エラー行は記録し、処理を継続

【6.2 バーコード検証ルール】
　- バーコードマスタとの照合
　- 入力値の制御文字除去
　- 大文字への統一
　- 検証結果の音声フィードバック
　　├─ 成功時: 800Hzの音
　　└─ 失敗時: 400Hzの音

【6.3 カメラ読み取りルール】
　- DataMatrix形式のバーコードのみ対応
　- カメラの解像度は1920x1080推奨
　- ズーム機能をサポート（2.0倍推奨）
　- 読み取り成功時は自動的に検証処理を実行
　- エラー時は自動的にカメラを停止

■ 7. エラーハンドリング
====================================================================
【7.1 CSV取込エラー】
　- ファイル形式エラー: 「CSVファイルの形式が正しくありません」
　- データ形式エラー: 「データの形式が正しくありません」
　- 重複エラー: 「重複するデータが存在します」
　- システムエラー: 「システムエラーが発生しました」

【7.2 バーコード検証エラー】
　- バーコード未選択: 「バーコードを選択してください」
　- 検証エラー: 「バーコードが一致しません」
　- システムエラー: 「システムエラーが発生しました」

【7.3 カメラ読み取りエラー】
　- カメラ未対応: 「お使いのブラウザはカメラ機能をサポートしていません」
　- カメラ起動エラー: 「カメラの起動に失敗しました」
　- 読み取りエラー: 「バーコードの読み取りに失敗しました」

■ 8. 関連ファイル・関数
====================================================================
【8.1 主要ファイル・関数】

◆ ルーティング
　- ファイル: app/routes.py
　- 関数: barcode_import(), barcode_scan(), barcode_scan_csv()
　- 機能: バーコード関連画面の表示制御とAPI処理
　- 認証: @login_required デコレータ

◆ テンプレート
　- ファイル: app/templates/barcode_import.html
　- 機能: バーコードCSV取込画面のHTML表示
　- 継承: base.html

　- ファイル: app/templates/barcode_scan.html
　- 機能: バーコード読込画面のHTML表示
　- 継承: base.html

　- ファイル: app/templates/barcode_scan_csv.html
　- 機能: バーコード読込（CSV）画面のHTML表示
　- 継承: base.html

◆ JavaScript
　- ファイル: app/static/js/barcode.js
　- 機能: バーコード検証・カメラ制御
　- ライブラリ: zxing-js/browser
　- 音声制御: Web Audio API

【8.2 データベーステーブル】

◆ BBCD_MST（バーコードマスタテーブル）
　- 主要項目: BBCD_ID, BBCD_NO, BBCD_NM
　- 業務用途: バーコード情報の管理

◆ BSHK_DAT（出荷データテーブル）
　- 主要項目: 
　　├─ BSHK_ID: 出荷ID（自動採番）
　　├─ BSHK_TO: 出荷先ID
　　├─ BSHK_PDD_ID: 製造ID
　　├─ BSHK_RCP_ID: 受注ID
　　├─ BSHK_DT: 出荷日
　　├─ BSHK_QTY: 数量
　　├─ BSHK_FLG: フラグ
　　└─ BSHK_ORD_DT: 手配日
　- 業務用途: 出荷情報の管理
　- 関連: バーコードによる出荷処理

【8.3 関連画面・機能】
　- 在庫管理画面: バーコードによる在庫検索
　- 出荷管理画面: バーコードによる出荷処理
　- 製品マスタ画面: 製品情報の管理 