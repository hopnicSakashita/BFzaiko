====================================================================
在庫管理システム - CSVデータ取込画面 詳細設計書（改訂版）
====================================================================

■ 1. 画面概要
====================================================================
【画面名】
　製造データCSV取込画面

【画面目的】
　製造データのCSVファイルを取り込み、1列目から75列目の特定データを抽出して
　ノンコート製造データ（BPRD_DAT）と製造明細データ（BPRD_MEI）に登録する業務機能を提供する。

【アクセス情報】
　- URL: /prd_dat/import_csv
　- 認証: 必須（ログイン後のみアクセス可能）
　- 初期表示: GET方式
　- CSV取込実行: POST方式

■ 2. 業務概要
====================================================================
【主要業務】
　1. 製造現場からのCSVファイル受付・解析
　2. 製品ID・LOT・No・数量データの抽出・検証
　3. ノンコート製造データとしてデータベース登録
　4. 重複チェック・品質管理による信頼性確保

【業務上の重要性】
　- 製造現場とシステムをつなぐデータ投入の入口
　- 在庫管理の基盤となる製造実績データの正確な取込
　- 後続の在庫検索・出荷作業の基礎データ提供

【対象データ】
　- ノンコート製造データのみ（BPDD_PROC = DatabaseConstants.PROC_NON_COAT）
　- 有効データとして登録（BPDD_FLG = DatabaseConstants.BPDD_FLG_NOT_SHIPPED）
　- 75列目に記載された実際製造数量

■ 3. 画面レイアウト
====================================================================
【3.1 画面構成】
```
┌─────────────────────────────────────────────────────────┐
│                 製造データCSV取込                      │
├─────────────────────────────────────────────────────────┤
│ [エラー・成功メッセージエリア]                         │
├─────────────────────────────────────────────────────────┤
│ CSVファイル選択                                        │
│ ┌─────────────────┐                                   │
│ │ ファイルを選択  │ [参照]                           │
│ └─────────────────┘                                   │
│                                                       │
│ □ ヘッダー行あり                                      │
│                                                       │
│ [取り込み実行]  [戻る]                                │
└─────────────────────────────────────────────────────────┘
```

【3.2 入力項目詳細】

◆ CSVファイル選択
　- 必須項目
　- 受け入れ形式: .csv拡張子のファイルのみ
　- 対応エンコード: UTF-8、Shift-JIS、CP932自動判定
　- 最低必要列数: 76列（75列目まで使用）

◆ ヘッダー行有無チェック
　- 任意項目（初期値：チェック無し）
　- CSVの1行目がヘッダー行の場合にチェック
　- チェック時は1行目をスキップして処理

■ 4. CSVファイル仕様
====================================================================
【4.1 ファイル形式要件】

◆ 基本要件
　- ファイル拡張子: .csv
　- 最低列数: 76列（75列目まで使用）
　- 文字エンコード: UTF-8、Shift-JIS、CP932のいずれか
　- 行数制限: なし（システムで処理可能な範囲）

【4.2 データ抽出仕様】

◆ 1列目からの抽出項目
```
位置      抽出項目     抽出範囲       データ型    用途
─────────────────────────────────────────────────
1-4文字   製品ID      1列目の1-4位   文字列      製品識別
5-10文字  LOT        1列目の5-10位  数値        製造ロット番号
12-13文字 No(前半)    1列目の12-13位 数値        明細番号前半
16文字    No(後半)    1列目の16位    数値        明細番号後半
```

◆ 75列目データ
　- 項目名: 製造数量
　- データ型: 数値
　- 処理条件: 0より大きい値のみ処理対象
　- 用途: 実際の製造数量として登録

■ 5. 業務ルール
====================================================================
【5.1 データ検証ルール】

◆ 製品ID検証
　- BF規格マスタ（BFSP_MST）に存在する製品IDのみ受付
　- 存在しない製品IDはスキップ（エラーメッセージ出力）

◆ 数量検証
　- 75列目の数量が0以下の場合はスキップ
　- 数値でない場合はエラーとして処理
　- NULL値は0として扱いスキップ

◆ データ整合性チェック
　- 1列目の文字数不足の場合はスキップ
　- LOTが数値でない場合は0として処理
　- Noが数値でない場合は"00"として処理

【5.2 重複チェックルール】

◆ 製造明細の一意性制約
　- 対象テーブル: BPRD_MEI
　- チェック項目: 製品ID + LOT + No の組み合わせ
　- 重複時の処理: 該当行をスキップして重複カウントに計上

◆ 製造データの統合処理
　- 同一製品ID+LOTが既存の場合: 数量を加算更新
　- 新規の場合: 新しいレコードとして登録
　- 更新・登録ともにBPRD_MEI明細も同時作成

【5.3 エラーハンドリングルール】

◆ ファイルレベルエラー
　- ファイル未選択: エラーメッセージ表示、処理中断
　- 不正拡張子: CSVファイル選択を促すメッセージ
　- 空ファイル: ファイル内容確認を促すメッセージ
　- エンコードエラー: 対応エンコード一覧を案内

◆ 行レベルエラー
　- 列数不足: 最低76列必要メッセージ、スキップカウント
　- 製品ID不正: 製品ID取得不可メッセージ、スキップカウント
　- 数量不正: 数値変換エラーメッセージ、スキップカウント

■ 6. 処理フロー
====================================================================
【6.1 メイン処理フロー】
```
1. CSVデータ取込画面アクセス（/prd_dat/import_csv）
　　↓
2. 認証チェック（ログイン必須）
　　↓
3. GET方式：ファイル選択フォーム表示
　　POST方式：CSV取込処理実行
　　↓
4. ファイル形式・サイズ・拡張子チェック
　　↓
5. 一時ファイル保存・エンコーディング自動判定
　　↓
6. import_csv_nonecoat()関数でCSV解析・データ登録
　　↓
7. 取込結果集計（成功・スキップ・重複・エラー各件数）
　　↓
8. 結果メッセージをフラッシュメッセージで表示
　　↓
9. 一時ファイル削除・画面再表示
```

【6.2 CSV解析処理フロー】
```
1. エンコーディング自動判定（UTF-8-sig → UTF-8 → Shift-JIS → CP932）
　　↓
2. CSVファイル読み込み・ヘッダー行スキップ判定
　　↓
3. 各行順次処理
　　├─ 列数チェック（最低76列）
　　├─ 1列目から製品ID・LOT・No抽出
　　├─ 製品IDのBFSP_MST存在チェック
　　├─ 75列目数量取得・数値チェック
　　└─ 0より大きい数量のみ処理継続
　　↓
4. 重複チェック（BPRD_MEI一意性制約）
　　├─ 重複なし：BPRD_DAT・BPRD_MEI登録
　　└─ 重複あり：スキップして重複カウント
　　↓
5. 個別コミット・エラー時ロールバック
　　↓
6. 処理結果統計情報返却
```

【6.3 データ登録処理フロー】
```
1. 製造データ（BPRD_DAT）処理
　　├─ 既存レコード検索（製品ID + LOT）
　　├─ 既存あり：数量加算更新
　　└─ 既存なし：新規レコード作成
　　↓
2. 製造明細（BPRD_MEI）処理
　　├─ 新規明細レコード作成
　　├─ 製品ID・LOT・No・数量セット
　　└─ セッション追加
　　↓
3. データベースコミット
　　├─ 成功時：成功カウント増加
　　└─ 失敗時：ロールバック・エラーカウント増加
```

■ 7. 処理結果仕様
====================================================================
【7.1 処理統計情報】

◆ 合計行数（total）
　- CSVファイルの総データ行数（ヘッダー行除く）

◆ 成功行数（success）
　- 正常にデータベースへ登録された行数
　- BPRD_DAT・BPRD_MEI両方の登録完了をもって成功

◆ スキップ行数（skipped）
　- 業務条件によりスキップされた行数
　- 列数不足・製品ID不存在・数量0以下など

◆ 重複行数（duplicate）
　- BPRD_MEI一意性制約により重複でスキップされた行数

◆ エラー行数（error）
　- システムエラーにより処理失敗した行数
　- データベースエラー・予期せぬ例外など

【7.2 結果メッセージ表示】

◆ 成功時メッセージ
　- 「CSV取り込み完了: 合計X行、成功Y行、スキップZ行、重複A行、エラーB行」
　- 成功種別: success（緑色表示）

◆ 警告時メッセージ
　- 成功行数が0の場合の結果表示
　- 成功種別: warning（黄色表示）

◆ エラー詳細表示
　- 最大5件までの具体的エラー内容表示
　- 6件目以降は件数のみ表示
　- 成功種別: error（赤色表示）

■ 8. 関連ファイル・関数
====================================================================
【8.1 ルーティング関数】
　- app/routes.py: import_csv()
　  * CSV取込画面の表示・処理制御
　  * ファイルアップロード・バリデーション
　  * 一時ファイル管理・結果表示

【8.2 データ処理関数】
　- app/import_csv.py: import_csv_nonecoat()
　  * CSV解析・データ抽出・登録のメイン処理
　  * エンコーディング自動判定
　  * 行単位での業務検証・データベース登録
　  * エラーハンドリング・統計情報集計

【8.3 モデル・フォーム】
　- app/models.py: PrdDatModel（BPRD_DAT）
　  * 製造データテーブルのモデル
　  * 既存データ検索・数量更新処理
　- app/models.py: BprdMeiModel（BPRD_MEI）
　  * 製造明細テーブルのモデル
　  * 明細データ新規作成・一意性制約管理
　- app/models.py: BfspMstModel（BFSP_MST）
　  * BF規格マスタテーブルのモデル
　  * 製品ID存在チェック
　- app/models.py: process_text_to_db()
　  * データベース登録用の文字列処理
　- app/models.py: log_error()
　  * 統一エラーログ記録

【8.4 テンプレート】
　- app/templates/import_csv.html
　  * CSV取込画面のテンプレート
　  * ファイル選択フォーム・結果表示

【8.5 データベーステーブル】
　- BPRD_DAT: 製造データテーブル
　  * 主要項目: BPDD_ID（製造ID）、BPDD_PRD_ID（製品ID）、BPDD_LOT（LOT）、BPDD_QTY（数量）、BPDD_FLG（フラグ）、BPDD_PROC（加工ID）
　  * 業務用途: 製造実績データの管理・在庫計算の基盤
　- BPRD_MEI: 製造明細テーブル
　  * 主要項目: BPDM_ID（明細ID）、BPDM_PRD_ID（製品ID）、BPDM_LOT（LOT）、BPDM_NO（No）、BPDM_QTY（数量）
　  * 業務用途: 製造の詳細管理・重複チェック制約
　- BFSP_MST: BF規格マスタテーブル
　  * 主要項目: BFSP_PRD_ID（製品ID）、BFSP_BASE（ベース）、BFSP_ADP（加入度数）、BFSP_LR（L/R）、BFSP_CLR（色）
　  * 業務用途: 製品ID検証・製品仕様情報

【8.6 重要な業務関数】
　- get_db_session(): データベースセッション管理
　- トランザクション制御: コミット・ロールバック処理

【8.7 関連画面・機能】
　- ノンコート在庫検索画面: 取込データの在庫確認
　- 製造明細一覧画面: 取込結果の詳細確認
　- トップページ: 取込による在庫影響の確認

■ 9. 運用上の注意事項
====================================================================
【9.1 ファイル管理】
　- 一時ファイルは処理完了後に自動削除される
　- ファイルサイズ制限は通常のWebアプリケーション制限に従う
　- 同時アップロード制限はユーザー単位で制御

【9.2 データ品質管理】
　- 製品IDはBF規格マスタへの事前登録が必須
　- CSV作成元システムとの列位置整合性確認が重要
　- 数量データの妥当性は業務担当者での事前確認が推奨

【9.3 エラー対応】
　- エラー詳細はシステムログに記録される
　- 大量エラー発生時は業務担当者とシステム管理者への連絡
　- 重複エラーは業務運用での重複チェック体制見直しが必要
