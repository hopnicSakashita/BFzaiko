====================================================================
在庫管理システム - 製造明細一覧画面 詳細設計書（改訂版）
====================================================================

■ 1. 画面概要
====================================================================
【画面名】
　製造明細一覧画面

【画面の位置づけ】
　本画面は、製造明細データの検索・一覧表示・管理を行う基幹機能画面です。
　製造明細の確認から新規作成・編集に至る製造管理業務の起点となります。

【主要な役割】
　- 製造明細データの一元管理と検索機能
　- 製品ID・LOT番号による効率的な絞り込み検索
　- 新規製造明細作成および既存明細編集への導線提供
　- 製造データ（BPRD_DAT）との整合性を保った明細管理

【アクセス権限】
　- 要ログイン認証
　- URL: /bprd_mei/list
　- HTTPメソッド: GET（参照のみ）

■ 2. 業務概要
====================================================================
【業務背景】
　製造明細（BPRD_MEI）は、製造データ（BPRD_DAT）の詳細分割情報を管理するテーブルです。
　1つの製造データ（製品ID+LOT）に対して複数の製造明細（分割No毎）が紐づく構造となっており、
　製造工程における分割管理や品質トレーサビリティの確保に重要な役割を担います。

【処理対象データ】
　- BPRD_MEI（製造明細テーブル）：主要管理対象
　- BFSP_MST（BF規格マスタ）：製品選択時の参照
　- BPRD_DAT（製造データ）：製造明細の集約先（数量連動）

【業務重要性】
　- 製造明細の新規登録時、自動的にBPRD_DATの数量が更新される
　- 製造明細の数量変更時、関連するBPRD_DATの数量も連動更新される
　- 在庫計算（dbo.Get_Zaiko_Qty_BF関数）において、BPRD_DATの数量が基準値として使用される

■ 3. 処理フロー
====================================================================
【3.1 メイン処理フロー】
　1. 画面初期表示
　　　└─ 製造明細一覧の基本表示（検索条件なし）
　2. 検索条件入力
　　　├─ 製品ID入力（部分一致）
　　　└─ LOT番号入力（完全一致、数値）
　3. 検索実行
　　　├─ 検索条件バリデーション
　　　├─ BPRD_MEIテーブル検索
　　　└─ 結果一覧表示
　4. 操作選択
　　　├─ 新規作成ボタン → 製造明細登録画面へ
　　　├─ 修正ボタン → 製造明細編集画面へ
　　　└─ クリアボタン → 検索条件リセット

【3.2 詳細処理フロー】

◆ 検索処理フロー
　1. GETパラメータから検索条件を取得
　2. 製品ID条件チェック
　　　├─ 入力あり → LIKE検索条件追加（%製品ID%）
　　　└─ 入力なし → 条件なし
　3. LOT番号条件チェック
　　　├─ 入力あり → 数値変換後、完全一致条件追加
　　　├─ 数値変換エラー → エラーメッセージ表示
　　　└─ 入力なし → 条件なし
　4. データベース検索実行
　　　├─ 並び順：製品ID → LOT → No順
　　　└─ 結果取得
　5. 検索結果表示
　　　├─ データあり → テーブル表示
　　　└─ データなし → 「データが見つかりません」表示

◆ 画面遷移フロー
　1. 新規作成ボタン押下 → /bprd_mei/create へ遷移
　2. 修正ボタン押下 → /bprd_mei/{明細ID}/edit へ遷移
　3. 検索ボタン押下 → 同一画面で条件付き再表示
　4. クリアボタン押下 → /bprd_mei/list（条件なし）へ遷移

■ 4. 画面レイアウト
====================================================================
【4.1 画面構成】
```
┌─────────────────────────────────────────────────────────────┐
│                    製造明細一覧                [新規作成]    │
├─────────────────────────────────────────────────────────────┤
│ [検索条件]                                                 │
│   製品ID: [_______] ロット: [______] [検索] [クリア]        │
├─────────────────────────────────────────────────────────────┤
│ [検索結果]                                                 │
│ ┌─────┬─────┬────┬────┬────┐                             │
│ │製品ID│ロット │No  │数量│操作│                             │
│ ├─────┼─────┼────┼────┼────┤                             │
│ │1001  │12345 │1   │25  │修正│                             │
│ │1002  │12346 │1   │30  │修正│                             │
│ └─────┴─────┴────┴────┴────┘                             │
└─────────────────────────────────────────────────────────────┘
```

【4.2 UI要素配置】
　- ページヘッダー：画面タイトル「製造明細一覧」+ 新規作成ボタン（右上）
　- 検索エリア：カード形式で囲まれた検索条件フォーム
　- 結果エリア：Bootstrap striped table でのデータ表示
　- 操作エリア：各行に修正ボタン配置

■ 5. データ項目
====================================================================
【5.1 検索条件項目】

◆ 製品ID (prd_id)
　- データ型: VARCHAR(4)
　- 必須/任意: 任意
　- 検索方式: 部分一致検索
　- 説明: 製品IDによる絞り込み検索
　- 入力例: "1001" → "%1001%" で検索

◆ LOT番号 (lot)
　- データ型: NUMERIC(6,0)
　- 必須/任意: 任意
　- 検索方式: 完全一致検索（数値変換後）
　- バリデーション: 数値チェック、変換エラー時はメッセージ表示
　- 説明: LOT番号による絞り込み検索

【5.2 表示項目】

◆ 製品ID
　- データソース: BPRD_MEI.BPDM_PRD_ID
　- データ型: VARCHAR(4)
　- 説明: 製品識別コード

◆ ロット
　- データソース: BPRD_MEI.BPDM_LOT
　- データ型: NUMERIC(6,0)
　- 説明: 製造ロット番号

◆ No
　- データソース: BPRD_MEI.BPDM_NO
　- データ型: NUMERIC(4,0)
　- 説明: 分割番号（同一製品ID+LOT内での識別番号）

◆ 数量
　- データソース: BPRD_MEI.BPDM_QTY
　- データ型: NUMERIC(5,0)
　- 説明: 明細単位での製造数量

◆ 操作
　- 表示: 修正ボタン
　- 遷移先: /bprd_mei/{明細ID}/edit
　- 説明: 個別明細の編集画面へのリンク

■ 6. 業務ルール
====================================================================
【6.1 データ表示ルール】

◆ 検索結果並び順
　1. 製品ID（BPDM_PRD_ID）昇順
　2. ロット（BPDM_LOT）昇順
　3. No（BPDM_NO）昇順

◆ 検索条件保持ルール
　- 検索実行後も検索条件を入力欄に保持
　- ページ遷移時もGETパラメータとして条件を維持

【6.2 データ整合性ルール】

◆ 製造明細と製造データの関係
　- 1つの製造データ（BPRD_DAT）に対して複数の製造明細（BPRD_MEI）が紐づく
　- 製造データの数量（BPDD_QTY）= 関連する全製造明細の数量合計
　- 製造明細の新規作成・更新・削除時に製造データの数量も連動更新

【6.3 権限・操作制限ルール】

◆ 画面アクセス制限
　- ログイン認証が必須
　- 参照のみの権限（データ変更は別画面）

◆ 検索機能制限
　- 製品ID：部分一致のみ、完全一致検索不可
　- LOT番号：完全一致のみ、範囲検索不可
　- ページング機能なし（全件表示）

【6.4 データ連携ルール】

◆ 関連テーブル連携
　- BFSP_MST（BF規格マスタ）：製品選択時の参照先
　- BPRD_DAT（製造データ）：明細数量の集約先
　- 在庫計算時はBPRD_DATの数量がdbo.Get_Zaiko_Qty_BF関数で使用される

■ 7. エラーハンドリング
====================================================================
【7.1 業務エラー】

◆ 検索条件エラー
　- LOT番号非数値エラー：「ロットは数値で入力してください。」
　- 原因：LOT番号欄に文字列入力
　- 対応：エラーメッセージ表示、検索処理は継続

◆ データ不存在エラー
　- 検索結果0件：「データが見つかりません」をテーブル内に表示
　- 原因：検索条件に合致するデータなし
　- 対応：空テーブル表示、検索条件は保持

【7.2 システムエラー】

◆ データベース接続エラー
　- エラーメッセージ：「一覧の取得中にエラーが発生しました: {エラー詳細}」
　- 原因：DB接続障害、SQL実行エラー
　- 対応：flashメッセージ表示、空の結果リスト表示

◆ 予期しないエラー
　- 原因：アプリケーション内部エラー
　- 対応：例外をキャッチしてflashメッセージ表示、画面は表示継続

【7.3 エラー表示方法】
　- Flash メッセージ：Bootstrap アラート形式で画面上部に表示
　- エラー時も画面表示は継続（白紙画面にならない）
　- エラー後も検索条件は保持される

■ 8. 関連ファイル・関数
====================================================================
【8.1 メイン処理関数】
　- list_bprd_mei(): 製造明細一覧表示処理（app/routes.py）
　　├─ 検索条件取得・バリデーション
　　├─ BPRD_MEI テーブル検索
　　└─ 結果一覧の画面表示

【8.2 関連テーブル・モデル】
　- BprdMeiModel: 製造明細テーブルのORMモデル（app/models.py）
　- BprdMei: 製造明細の業務ロジッククラス（app/models.py）
　　└─ create(): 新規明細作成時のBPRD_DAT連動更新
　　└─ get_by_prd_id(): 製品ID検索処理

【8.3 画面テンプレート】
　- bprd_mei_list.html: 一覧画面テンプレート（app/templates/）
　　├─ 検索フォーム（GET method）
　　├─ 結果テーブル（Bootstrap table）
　　└─ 新規作成・修正ボタン

【8.4 関連画面・機能】
　- 製造明細登録: /bprd_mei/create（create_bprd_mei関数）
　　└─ BprdMei.create()による新規作成処理
　- 製造明細編集: /bprd_mei/<mei_id>/edit（edit_bprd_mei関数）
　　└─ 明細数量変更時のBPRD_DAT連動更新
　- 製造明細更新: /bprd_mei/<mei_id>/update（update_bprd_mei関数）
　　└─ 数量差分計算によるBPRD_DAT.BPDD_QTY更新

【8.5 データベース関数】
　- dbo.Get_Zaiko_Qty_BF(): 在庫数量計算（BPRD_DATの数量ベース）
　　└─ 製造明細管理がこの関数の計算基準に影響

【8.6 特記事項】
　- 製造明細の数量管理はBPRD_DATとの整合性が重要
　- 明細レベルでの分割管理により、製造トレーサビリティを確保
　- 在庫管理システム全体の基礎データとして機能
