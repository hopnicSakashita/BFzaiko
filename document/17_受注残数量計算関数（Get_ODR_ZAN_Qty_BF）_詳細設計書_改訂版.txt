====================================================================
在庫管理システム - 受注残数量計算関数（Get_ODR_ZAN_Qty_BF）詳細設計書（改訂版）
====================================================================

■ 1. 画面概要
====================================================================
【機能名】
　受注残数量計算関数（Get_ODR_ZAN_Qty_BF）

【機能ID】
　FUNCTION_ODR_ZAN_QTY

【アクセス権限】
　- 対象: システム内部関数（直接アクセス不可）
　- 認証: 各機能画面の認証に依存
　- 権限: データベース関数として自動実行

【機能の位置づけ】
　在庫管理システムの核心的な業務計算機能。受注管理・出荷計画・
　在庫管理の各業務で受注残数量の正確な把握に不可欠な計算処理を担う。

■ 2. 業務概要
====================================================================
【業務目的】
　1. 受注数量から出荷済み数量を差し引いた受注残数量の正確な算出
　2. 受注完了判定による業務ステータス管理
　3. 出荷計画立案時の受注残数量リアルタイム提供
　4. 受注一覧での残数量表示による業務効率化
　5. 在庫検索時の受注需要数量把握

【主要業務機能】
　1. 受注残数量計算：受注数量 - 累計出荷数量
　2. 受注完了判定：残数量0での完了ステータス判定
　3. 出荷超過検知：負値による数量不整合の検出
　4. リアルタイム計算：最新の出荷状況を反映した即座計算
　5. 複数機能連携：各業務画面での一貫した数値提供

【業務上の重要性】
　- 受注管理業務の正確性確保
　- 出荷計画立案の基礎データ提供
　- 在庫と需要のバランス把握
　- 業務プロセス全体の整合性維持
　- 顧客納期管理の精度向上

■ 3. 処理フロー
====================================================================
【3.1 メインフロー】
　1. 受注ID指定による関数呼び出し
　　　↓
　2. 受注データ（BRCP_DAT）から受注数量取得
　　　↓
　3. 出荷データ（BSHK_DAT）から累計出荷数量取得
　　　↓
　4. 受注残数量計算（受注数量 - 累計出荷数量）
　　　↓
　5. 計算結果の返却
　　　↓
　6. 呼び出し元での受注残数量活用

【3.2 受注数量取得フロー】
　1. 受注ID（BRCP_ID）による主キー検索
　　　↓
　2. BRCP_DAT.BRCP_QTY（受注数量）取得
　　　├─ データ存在 → 受注数量を変数格納
　　　└─ データ無し → NULL値処理

【3.3 出荷数量合計取得フロー】
　1. 受注ID（BSHK_RCP_ID）による関連出荷データ検索
　　　↓
　2. BSHK_DAT.BSHK_QTY の SUM集計実行
　　　├─ 出荷データ存在 → 合計数量算出
　　　├─ 出荷データ無し → 0として処理
　　　└─ NULL値 → ISNULL関数で0変換

【3.4 受注残数量計算フロー】
　1. 基本計算：受注数量 - 累計出荷数量
　　　↓
　2. 計算結果判定
　　　├─ 正値 → 受注残あり（継続処理対象）
　　　├─ 0 → 受注完了（完了ステータス）
　　　└─ 負値 → 出荷超過（データ不整合警告）
　　　　　　↓
　3. 業務ルール適用・結果返却

■ 4. 画面レイアウト
====================================================================
【4.1 関数使用箇所での表示例】

◆ 受注データ検索画面
　┌─────────────────────────────────┐
　│ 受注ID │ 受注日 │ 製品ID │ 受注数量 │ 残数量 │
　├─────────────────────────────────┤
　│ 12345  │ 2024/01 │ A001   │ 100     │ 50    │
　│ 12346  │ 2024/01 │ A002   │ 200     │ 200   │
　│ 12347  │ 2024/01 │ A003   │ 150     │ 0     │
　└─────────────────────────────────┘

◆ 在庫検索画面（受注需要表示）
　┌─────────────────────────────────┐
　│ 製品ID │ 在庫数量 │ 受注残合計 │ 充足状況 │
　├─────────────────────────────────┤
　│ A001   │ 80       │ 150       │ 不足     │
　│ A002   │ 300      │ 200       │ 余剰     │
　└─────────────────────────────────┘

◆ 出荷作成画面（残数量チェック）
　┌─────────────────────────────────┐
　│ 受注ID：12345  残数量：50個           │
　│ 出荷数量：[___] （最大50個まで）        │
　└─────────────────────────────────┘

【4.2 業務ステータス表示】
　- 受注残あり：青色表示（継続処理対象）
　- 受注完了：緑色表示（完了ステータス）
　- 出荷超過：赤色表示（要確認・データ修正）

■ 5. データ項目
====================================================================
【5.1 入力データ】
　- 受注ID（BRCP_ID）：計算対象受注の一意識別子
　- データソース：各機能画面からの関数呼び出し

【5.2 参照データ】

◆ 受注データ（BRCP_DAT）
　- 受注ID（BRCP_ID）：主キー
　- 受注数量（BRCP_QTY）：計算ベース数量
　- 受注日（BRCP_DT）：業務管理用
　- 製品ID（BRCP_PRD_ID）：製品識別

◆ 出荷データ（BSHK_DAT）
　- 受注ID（BSHK_RCP_ID）：外部キー参照
　- 出荷数量（BSHK_QTY）：累計計算対象
　- 出荷日（BSHK_DT）：出荷実績管理
　- 出荷ステータス（BSHK_FLG）：有効データ判定

【5.3 出力データ】
　- 受注残数量：受注数量から出荷数量を差し引いた結果
　- データ型：数値（最大5桁）
　- 値の意味：正値=残あり、0=完了、負値=超過

■ 6. 業務ルール
====================================================================
【6.1 受注残数量計算ルール】
　1. 基本計算式
　　- 受注残数量 = 受注数量 - 累計出荷数量
　　- 小数点計算は行わない（整数単位）

　2. NULL値処理ルール
　　- 受注数量NULL → 計算不可（NULL返却）
　　- 出荷数量NULL → 0として計算継続

　3. 負値許可ルール
　　- 出荷超過時も実際の残数量を返却
　　- 業務側で警告表示・修正処理実施

【6.2 データ整合性ルール】
　1. 受注データ参照ルール
　　- 削除済み受注は計算対象外
　　- 無効フラグ受注の取扱い確認

　2. 出荷データ集計ルール
　　- 有効出荷データのみ集計対象
　　- 取消出荷は集計から除外

【6.3 業務判定ルール】
　1. 受注完了判定
　　- 受注残数量 = 0 → 受注完了
　　- 受注完了時の後続処理トリガー

　2. 出荷可能数量判定
　　- 受注残数量 > 0 → 出荷可能
　　- 0以下の場合は出荷不可警告

　3. 在庫需要計算
　　- 受注残数量の合計 = 製品別需要数量
　　- 在庫充足率の計算基準

■ 7. エラーハンドリング
====================================================================
【7.1 データエラー】
　- 存在しない受注ID：NULL返却・業務側で確認促進
　- 受注数量NULL：計算不可・データ修正要求
　- 範囲外数値：型変換エラー・入力値確認

【7.2 業務エラー】
　- 出荷超過状態：負値返却・警告表示・原因調査
　- データ不整合：関連データ確認・修正処理
　- 重複出荷：出荷データ見直し・重複排除

【7.3 システムエラー】
　- データベース接続エラー：一時的計算不可・再試行
　- テーブルロック：計算待機・タイムアウト処理
　- メモリ不足：大量計算制限・分割処理

【7.4 呼び出し側エラー対策】
　- NULL結果処理：ISNULL関数で0変換
　- エラー表示：「計算できません」メッセージ
　- 代替処理：手動確認・直接データ参照

■ 8. 関連ファイル・関数
====================================================================
【8.1 データベース関数】
　◆ 主要ファイル
　　- sql/Get_ODR_ZAN_Qty_BF.sql：関数定義SQL
　　- dbo.Get_ODR_ZAN_Qty_BF：データベース関数本体

　◆ 関連テーブル
　　- BRCP_DAT：受注データテーブル
　　- BSHK_DAT：出荷データテーブル

【8.2 呼び出し元ファイル・関数】
　◆ 受注検索機能（app/models.py）
　　- BrcpDat.search_orders()：受注一覧での残数量表示
　　- line 474, 512, 514：関数呼び出し箇所

　◆ 在庫検索機能（app/models.py）  
　　- PrdDat.search_noncoat_stock()：ノンコート在庫検索
　　- PrdDat.search_hardcoat_stock()：ハードコート在庫検索
　　- line 685, 686, 751：受注需要数量計算

　◆ 出荷作成機能（app/shipment.py）
　　- Shipment.create_shipping()：出荷作成時残数量チェック
　　- line 250, 260, 282, 292, 388, 394, 562：関数使用

　◆ トップページ集計（app/models.py）
　　- summary_data()：サマリー情報計算
　　- line 392, 399：全体集計での使用

【8.3 連携関数】
　◆ 関連計算関数
　　- Get_Zaiko_Qty_BF：在庫数量計算関数（併用）
　　- ISNULL関数：NULL値処理（組み合わせ使用）

　◆ 業務処理関数
　　- flash_success/error：計算結果メッセージ表示
　　- check_data_consistency：データ整合性チェック

【8.4 設計書関連】
　◆ 機能設計書での使用記載
　　- 02_受注データ検索：ZAN_QTY項目
　　- 04_ノンコート在庫検索：order_remaining項目  
　　- 05_出荷一覧：remaining_qty項目
　　- 08_ハードコート在庫検索：受注残表示
　　- 12_ハードコート出荷作成：受注残チェック

　◆ 関数仕様書
　　- 18_在庫数量計算関数：併用する計算関数
　　- データベース設計書：テーブル構造定義
