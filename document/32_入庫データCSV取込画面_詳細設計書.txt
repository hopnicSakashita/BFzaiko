# 入庫データCSV取込画面詳細設計書

## 1. 概要
CSVファイルから入庫データ（CPRD_DAT）を一括登録するための画面。
特定の列（75列目と76列目）の数量データを異なるランクとして処理し、入庫データとして登録する。

## 2. 画面構成
### 2.1 ヘッダー部
- 画面タイトル「入庫データCSV取込」を表示

### 2.2 メッセージ表示部
- フラッシュメッセージによるエラーや処理結果の表示
- メッセージの種類に応じて適切なスタイル（success/error等）を適用

### 2.3 入力フォーム
#### 2.3.1 CSVファイル選択
- ファイル選択コントロール
- 拡張子制限：.csvのみ許可
- 必須入力項目

#### 2.3.2 ヘッダー行設定
- チェックボックス「ヘッダー行あり」
- CSVの1行目がヘッダーの場合にチェック

### 2.4 取込仕様説明部
- 取込処理の仕様をリスト形式で表示
- 主要な処理内容と制約事項を明示

### 2.5 操作ボタン部
- 「取り込み実行」ボタン：CSVデータの取込処理を実行
- 「戻る」ボタン：トップページに戻る

## 3. 機能詳細
### 3.1 CSVファイル取込
1. ファイル形式チェック
   - 拡張子が.csvであることを確認
   - ファイルが選択されていることを確認

2. データ処理
   - ヘッダー行の有無に応じた読み込み開始位置の調整
   - 75列目（ランク1）と76列目（ランク2）の数量データ取得
   - 両方の列が0の場合はスキップ
   - 既存データとの重複チェック

3. データ登録
   - CPRD_DATテーブルへの登録処理
   - ランク別のレコード作成
   - 重複データのスキップ処理

### 3.2 フォーム送信制御
- フォーム送信時の2重送信防止
- 送信中の進捗表示（ボタンテキストの変更）

## 4. エラー処理
### 4.1 入力チェック
- ファイル未選択エラー
- ファイル形式エラー（.csv以外）
- ファイルサイズ制限エラー

### 4.2 データ処理エラー
- CSVフォーマットエラー
- 必要な列数不足エラー
- データ型不一致エラー
- 重複データエラー

### 4.3 システムエラー
- ファイル読み込みエラー
- データベース登録エラー
- その他システムエラー

## 5. 画面遷移
### 5.1 正常時
- 取込成功：処理結果メッセージを表示し、同画面に留まる
- 戻るボタン：トップページに遷移

### 5.2 異常時
- エラー発生時：エラーメッセージを表示し、同画面に留まる

## 6. セキュリティ考慮事項
- ファイルアップロードの制限（拡張子、サイズ）
- CSRFトークンによる保護
- アップロードされたファイルの適切な処理
- 不正なデータの検証とサニタイズ

## 7. パフォーマンス考慮事項
- 大容量ファイルの適切な処理
- メモリ使用量の最適化
- 処理の進捗表示
- 2重送信防止による不要な処理の抑制

## 8. 補足事項
### 8.1 CSVファイル仕様
- 75列目：ランク1の数量データ
- 76列目：ランク2の数量データ
- 両列とも0の場合は処理対象外
- 既存データと重複する場合はスキップ

### 8.2 エラーメッセージ表示
- get_flashed_messagesによるメッセージ管理
- メッセージの種類に応じたスタイル適用
- エラー内容の明確な表示 