====================================================================
在庫管理システム - 製造明細編集画面 詳細設計書（改訂版）
====================================================================

■ 1. 画面概要
====================================================================
【画面名】
　製造明細修正画面

【画面の位置づけ】
　本画面は、既存製造明細データの数量修正を行う専用編集画面です。
　製造明細の数量変更時に関連する製造データ（BPRD_DAT）の数量を
　自動連動更新し、データ整合性を保つ重要な機能を提供します。

【主要な役割】
　- 製造明細の数量のみの編集機能（製品ID・ロット・Noは変更不可）
　- 製造データ（BPRD_DAT）との数量連動更新
　- 数量変更時の整合性チェック機能
　- トランザクション制御による一貫性保証

【アクセス権限】
　- 要ログイン認証
　- URL: /bprd_mei/<int:mei_id>/edit（編集画面表示）
　- URL: /bprd_mei/<int:mei_id>/update（更新処理）
　- HTTPメソッド: GET（編集画面表示）, POST（更新処理）

■ 2. 業務概要
====================================================================
【業務背景】
　製造明細の数量修正は、製造実績の調整や誤入力の修正において重要な機能です。
　ただし、製品ID・ロット・Noは製造トレーサビリティの要であるため変更不可とし、
　数量のみの編集に限定することで、データの整合性と品質を保証します。

【処理対象データ】
　- BPRD_MEI（製造明細テーブル）：数量編集の対象
　- BPRD_DAT（製造データ）：明細変更時の連動更新対象

【業務重要性】
　- 明細数量変更時、BPRD_DATの数量も差分で自動更新される
　- 製造データの数量が0未満になる変更は業務ルール違反として禁止
　- 在庫計算（dbo.Get_Zaiko_Qty_BF関数）の基準値であるBPRD_DAT数量の正確性確保

【連動更新ルール】
　- 明細数量変更 → BPRD_DAT数量の差分更新
　- 更新前数量：A、更新後数量：B → BPRD_DAT数量 += (B - A)
　- 整合性チェック：BPRD_DAT数量が0未満になる場合は更新拒否

■ 3. 処理フロー
====================================================================
【3.1 メイン処理フロー】
　1. 編集画面表示
　　　├─ 製造明細ID指定によるデータ取得
　　　├─ 明細データ存在確認
　　　└─ 編集フォーム表示（数量のみ編集可）
　2. 数量編集
　　　├─ 製品ID・ロット・No表示（読み取り専用）
　　　└─ 数量入力（0以上の数値）
　3. 更新処理実行
　　　├─ 入力値バリデーション
　　　├─ 数量差分計算
　　　├─ BPRD_DAT整合性チェック
　　　├─ 明細・製造データ同時更新
　　　└─ 一覧画面へリダイレクト

【3.2 詳細処理フロー】

◆ 編集画面表示処理フロー
　1. URLパラメータから製造明細ID取得
　2. BPRD_MEI存在確認
　　　├─ 存在する → 編集フォーム表示
　　　└─ 存在しない → エラーメッセージ、一覧画面へリダイレクト
　3. 編集フォーム表示
　　　├─ 製品ID：読み取り専用表示
　　　├─ ロット：読み取り専用表示
　　　├─ No：読み取り専用表示
　　　└─ 数量：編集可能入力欄（現在値を初期表示）

◆ 更新処理フロー
　1. 入力値検証
　　　├─ 数量の数値変換チェック
　　　├─ 数量の範囲チェック（0以上）
　　　└─ 必須チェック（数量必須）
　2. 数量差分計算
　　　├─ 変更前数量：BPDM_QTY（現在値）
　　　├─ 変更後数量：入力値
　　　└─ 差分：変更後数量 - 変更前数量
　3. 製造データ整合性チェック
　　　├─ 同一製品ID+ロットのBPRD_DAT検索
　　　├─ BPDD_QTY + 差分 の計算
　　　└─ 結果が0未満なら更新拒否
　4. データ更新（トランザクション処理）
　　　├─ BPRD_MEI.BPDM_QTY更新
　　　├─ BPRD_DAT.BPDD_QTY更新（差分加算）
　　　└─ コミット実行
　5. 処理完了
　　　├─ 成功メッセージ表示
　　　└─ 製造明細一覧画面へリダイレクト

◆ エラー時処理フロー
　1. 数量バリデーションエラー → エラーメッセージ表示、編集画面再表示
　2. 整合性チェックエラー → エラーメッセージ表示、編集画面再表示
　3. システムエラー → ロールバック、エラーメッセージ表示、編集画面再表示

■ 4. 画面レイアウト
====================================================================
【4.1 画面構成】
```
┌─────────────────────────────────────────────────────────────┐
│                     製造明細修正                            │
├─────────────────────────────────────────────────────────────┤
│ 製品ID: 1001    ※読み取り専用                              │
│ ロット: 456789  ※読み取り専用                              │
│ No: 1          ※読み取り専用                              │
├─────────────────────────────────────────────────────────────┤
│ 数量: [____]   ※編集可能（number型、min="0"）             │
├─────────────────────────────────────────────────────────────┤
│ [更新] [戻る]                                              │
└─────────────────────────────────────────────────────────────┘
```

【4.2 UI要素配置】
　- ページヘッダー：「製造明細修正」タイトル
　- 基本情報エリア：読み取り専用フィールド（製品ID・ロット・No）
　- 編集エリア：数量入力フィールド（HTML5 number型）
　- 操作ボタン：更新（primary）+ 戻る（secondary）
　- メッセージエリア：フラッシュメッセージ表示領域

■ 5. データ項目
====================================================================
【5.1 表示項目（読み取り専用）】

◆ 製品ID
　- データソース: BPRD_MEI.BPDM_PRD_ID
　- データ型: VARCHAR(4)
　- 表示形式: input type="text" readonly
　- 説明: 製品識別コード（変更不可）

◆ ロット
　- データソース: BPRD_MEI.BPDM_LOT
　- データ型: NUMERIC(6,0)
　- 表示形式: input type="text" readonly
　- 説明: 製造ロット番号（変更不可）

◆ No
　- データソース: BPRD_MEI.BPDM_NO
　- データ型: NUMERIC(4,0)
　- 表示形式: input type="text" readonly
　- 説明: 分割番号（変更不可）

【5.2 編集項目】

◆ 数量 (qty)
　- データソース: BPRD_MEI.BPDM_QTY
　- データ型: NUMERIC(5,0)
　- 入力制約: 0以上の数値（min="0"）
　- HTML形式: input type="number" name="qty" required
　- 初期値: 現在の明細数量
　- 説明: 製造明細の数量（編集対象項目）

■ 6. 業務ルール
====================================================================
【6.1 編集制限ルール】

◆ 変更可能項目
　- 数量のみ編集可能（0以上の数値）

◆ 変更不可項目
　- 製品ID：製造トレーサビリティ保証のため変更不可
　- ロット：製造トレーサビリティ保証のため変更不可
　- No：分割番号の一意性保証のため変更不可

【6.2 数量変更ルール】

◆ 入力制約ルール
　- 数量：0以上の数値（負数不可）
　- 必須入力（空値不可）
　- 数値形式（文字列不可）

◆ 上下限ルール
　- 下限：0（0も許可）
　- 上限：99999（NUMERIC(5,0)の制約）

【6.3 データ整合性ルール】

◆ 製造データ連動ルール
　- 明細数量変更時、関連するBPRD_DATの数量も連動更新
　- 差分計算：新数量 - 旧数量 = 差分
　- BPRD_DAT更新：BPDD_QTY += 差分

◆ 整合性チェックルール
　- BPRD_DAT数量が0未満になる変更は禁止
　- チェック：(現在のBPDD_QTY + 差分) >= 0
　- 違反時：「製造データの合計数量が0未満になるため更新できません。」

【6.4 トランザクション制御ルール】

◆ 同時更新制御
　- 製造明細更新とBPRD_DAT更新は同一トランザクション
　- 一方でもエラーが発生した場合は全処理をロールバック
　- 部分的なデータ更新は発生させない

【6.5 データ存在確認ルール】

◆ 編集対象存在確認
　- 指定された製造明細IDのデータが存在すること
　- 存在しない場合は編集処理を実行しない

■ 7. エラーハンドリング
====================================================================
【7.1 業務エラー】

◆ 入力値バリデーションエラー
　- 数量負数エラー：「数量は0以上で入力してください。」
　- 数量形式エラー：「数量は正しい数値で入力してください。」
　- 原因：数値変換エラー（ValueError）

◆ データ整合性エラー
　- 明細不存在エラー：「指定された製造明細が見つかりません。」
　- 原因：URLパラメータの明細IDに対応するデータがない
　- 対応：一覧画面へリダイレクト

◆ 業務ルール違反エラー
　- 製造データ整合性エラー：「製造データの合計数量が0未満になるため更新できません。」
　- 原因：数量減少により関連するBPRD_DATの数量が負数になる
　- 対応：編集画面再表示

【7.2 システムエラー】

◆ 画面表示エラー
　- エラーメッセージ：「製造明細の編集画面表示中にエラーが発生しました: {エラー詳細}」
　- 原因：DB接続障害、データ取得エラー
　- 対応：一覧画面へリダイレクト

◆ 更新処理エラー
　- エラーメッセージ：「更新中にエラーが発生しました: {エラー詳細}」
　- 原因：DB更新エラー、トランザクションエラー
　- 対応：自動ロールバック、編集画面再表示

【7.3 成功処理】

◆ 更新成功
　- 成功メッセージ：「製造明細を更新しました。」
　- 対応：製造明細一覧画面へリダイレクト

【7.4 エラー表示方法】
　- Flash メッセージ：Bootstrap アラート形式で画面上部に表示
　- 自動リダイレクト：エラー時は編集画面または一覧画面へ適切に遷移
　- トランザクション制御：エラー時は確実にロールバック実行

■ 8. 関連ファイル・関数
====================================================================
【8.1 メイン処理関数】
　- edit_bprd_mei(): 製造明細編集画面表示処理（app/routes.py）
　　├─ 製造明細ID指定によるデータ取得
　　├─ 存在確認とエラーハンドリング
　　└─ 編集フォーム表示
　- update_bprd_mei(): 製造明細更新処理（app/routes.py）
　　├─ 入力値バリデーション
　　├─ 数量差分計算
　　├─ BPRD_DAT整合性チェック
　　└─ トランザクション制御による同時更新

【8.2 関連テーブル・モデル】
　- BprdMeiModel: 製造明細テーブルのORMモデル（app/models.py）
　　└─ 数量更新の対象テーブル
　- PrdDatModel: 製造データテーブルのORMモデル（app/models.py）
　　└─ 明細変更時の連動更新対象テーブル

【8.3 画面テンプレート】
　- bprd_mei_edit.html: 編集画面テンプレート（app/templates/）
　　├─ 基本情報表示（読み取り専用フィールド）
　　├─ 数量編集フォーム（HTML5制約付き）
　　├─ フラッシュメッセージ表示
　　└─ 更新・戻るボタン

【8.4 関連画面・機能】
　- 製造明細一覧: /bprd_mei/list（list_bprd_mei関数）
　　├─ 編集画面への遷移元
　　└─ 更新完了後のリダイレクト先
　- 製造明細登録: /bprd_mei/create（create_bprd_mei関数）
　　└─ 関連する新規作成機能

【8.5 データ連動処理】
　- 数量差分計算ロジック
　　├─ 変更前数量：BPDM_QTY（現在値）
　　├─ 変更後数量：フォーム入力値
　　└─ 差分：変更後数量 - 変更前数量
　- BPRD_DAT連動更新処理
　　├─ 同一製品ID+ロットのBPRD_DAT検索
　　├─ BPDD_QTY += 差分 による更新
　　└─ 整合性チェック（結果 >= 0）

【8.6 データベース関数】
　- dbo.Get_Zaiko_Qty_BF(): 在庫数量計算（BPRD_DATベース）
　　└─ 明細編集により変更されるBPRD_DAT数量が在庫計算に影響

【8.7 特記事項】
　- 製造明細編集は数量のみに限定し、トレーサビリティを保証
　- 製造データとの連動更新により、システム全体の整合性を保持
　- 差分更新による効率的なデータ管理
　- 在庫管理システム全体のデータ品質に直接影響する重要機能
