====================================================================
在庫管理システム - 製造明細登録画面 詳細設計書（改訂版）
====================================================================

■ 1. 画面概要
====================================================================
【画面名】
　製造明細新規作成画面

【画面の位置づけ】
　本画面は、新規製造明細データの登録を行う重要な入力画面です。
　製造工程で発生する分割管理データを製造明細として登録し、
　製造データ（BPRD_DAT）との整合性を自動で保つ機能を提供します。

【主要な役割】
　- 製造明細の新規登録による分割管理
　- 製品マスタからの製品選択機能
　- 製造データ（BPRD_DAT）の自動作成・数量更新
　- 重複防止機能による品質保証

【アクセス権限】
　- 要ログイン認証
　- URL: /bprd_mei/create
　- HTTPメソッド: GET（初期表示）, POST（登録処理）

■ 2. 業務概要
====================================================================
【業務背景】
　製造明細（BPRD_MEI）は、製造工程における分割管理のコアデータです。
　1つの製造データ（製品ID+LOT）に対して複数の分割番号（No）で明細を管理し、
　製造トレーサビリティの確保と品質管理の基盤として機能します。

【処理対象データ】
　- BPRD_MEI（製造明細テーブル）：新規登録対象
　- BFSP_MST（BF規格マスタ）：製品選択時の参照先
　- BPRD_DAT（製造データ）：明細登録時の自動更新対象

【業務重要性】
　- 製造明細登録時にBPRD_DATが自動作成または数量加算される
　- 同一製品ID+LOTの既存データがあれば数量加算、なければ新規作成
　- 在庫計算の基準となるBPRD_DAT数量の正確性を保証

【データ連動ルール】
　- 新規明細登録 → BPRD_DATの数量加算/新規作成
　- 重複チェック → 製品ID+LOT+Noの組み合わせで一意性保証
　- 製造データ初期値設定 → BPDD_FLG=0, BPDD_PROC=0

■ 3. 処理フロー
====================================================================
【3.1 メイン処理フロー】
　1. 画面初期表示
　　　├─ 製品マスタ一覧取得（BFSP_SORT順）
　　　└─ 新規作成フォーム表示
　2. データ入力
　　　├─ 製品ID選択（ドロップダウン）
　　　├─ ロット番号入力（0-999999）
　　　├─ 分割No入力（0-9999）
　　　└─ 数量入力（0-99999）
　3. 登録処理実行
　　　├─ 入力値バリデーション
　　　├─ 重複チェック
　　　├─ 製造明細登録
　　　├─ 製造データ連動更新
　　　└─ 一覧画面へリダイレクト

【3.2 詳細処理フロー】

◆ 初期表示処理フロー
　1. BFSP_MST（BF規格マスタ）から製品一覧取得
　　　├─ BFSP_SORT順でソート
　　　└─ 製品選択ドロップダウンに設定
　2. 新規作成フォーム表示
　　　├─ 製品ID：選択式（必須）
　　　├─ ロット：数値入力（0-999999、必須）
　　　├─ No：数値入力（0-9999、必須）
　　　└─ 数量：数値入力（0-99999、必須）

◆ 登録処理フロー
　1. 入力値検証
　　　├─ 必須項目チェック（全項目必須）
　　　├─ 数値変換チェック（ロット、No、数量）
　　　└─ 範囲チェック（各項目の上下限値）
　2. マスタ検証
　　　├─ 製品ID存在確認（BFSP_MST照合）
　　　└─ 重複チェック（製品ID+LOT+No組み合わせ）
　3. データ登録（トランザクション処理）
　　　├─ BPRD_MEI新規レコード作成
　　　├─ BPRD_DAT既存チェック（製品ID+LOT）
　　　├─ 既存あり → BPDD_QTY加算更新
　　　├─ 既存なし → BPRD_DAT新規作成
　　　└─ コミット実行
　4. 処理完了
　　　├─ 成功メッセージ表示
　　　└─ 製造明細一覧画面へリダイレクト

◆ エラー時処理フロー
　1. バリデーションエラー → エラーメッセージ表示、入力画面再表示
　2. 重複エラー → エラーメッセージ表示、入力画面再表示
　3. システムエラー → ロールバック、エラーメッセージ表示、入力画面再表示

■ 4. 画面レイアウト
====================================================================
【4.1 画面構成】
```
┌─────────────────────────────────────────────────────────────┐
│                   製造明細新規作成                          │
├─────────────────────────────────────────────────────────────┤
│ [新規作成]                                                 │
│   製品ID: [選択してください              ▼]                │
│          （製品ID - ベース 加入度数 L/R 色）               │
│   ロット: [______] 6桁以内の数値で入力してください          │
│   No:     [____] 4桁以内の数値で入力してください           │
│   数量:   [_____] 5桁以内の数値で入力してください          │
├─────────────────────────────────────────────────────────────┤
│ [操作ボタン]                                               │
│   [登録] [戻る]                                            │
└─────────────────────────────────────────────────────────────┘
```

【4.2 UI要素配置】
　- ページヘッダー：「製造明細新規作成」タイトル
　- 入力エリア：カード形式で囲まれた新規作成フォーム
　- 製品選択：ドロップダウン形式（「製品ID - 製品名」表示）
　- 数値入力：HTML5 number型でmin/max制限付き
　- 操作ボタン：登録（primary）+ 戻る（secondary）

■ 5. データ項目
====================================================================
【5.1 入力項目】

◆ 製品ID (prd_id)
　- データ型: VARCHAR(4)
　- 必須/任意: 必須
　- 入力方式: ドロップダウン選択
　- データソース: BFSP_MST（BFSP_SORT順）
　- 表示形式: 「製品ID - ベース 加入度数 L/R 色」
　- 説明: 製造対象製品の選択

◆ ロット (lot)
　- データ型: NUMERIC(6,0)
　- 必須/任意: 必須
　- 入力範囲: 0～999999
　- バリデーション: 数値チェック、範囲チェック
　- HTML5制約: min="0" max="999999" required
　- 説明: 製造ロット番号（6桁以内）

◆ No (no)
　- データ型: NUMERIC(4,0)
　- 必須/任意: 必須
　- 入力範囲: 0～9999
　- バリデーション: 数値チェック、範囲チェック
　- HTML5制約: min="0" max="9999" required
　- 説明: 同一ロット内での分割番号（4桁以内）

◆ 数量 (qty)
　- データ型: NUMERIC(5,0)
　- 必須/任意: 必須
　- 入力範囲: 0～99999
　- バリデーション: 数値チェック、範囲チェック
　- HTML5制約: min="0" max="99999" required
　- 説明: 明細単位での製造数量（5桁以内）

■ 6. 業務ルール
====================================================================
【6.1 入力制約ルール】

◆ 必須項目ルール
　- 全項目必須入力（製品ID、ロット、No、数量）
　- 空文字・NULL値は登録不可

◆ 数値範囲ルール
　- ロット：0～999999（6桁以内の正数）
　- No：0～9999（4桁以内の正数）
　- 数量：0～99999（5桁以内の正数、0も許可）

【6.2 一意性保証ルール】

◆ 重複防止ルール
　- 製品ID + ロット + No の組み合わせで一意性チェック
　- 既存の同一組み合わせが存在する場合は登録エラー

◆ 製品存在確認ルール
　- 選択された製品IDがBFSP_MSTに存在することを確認
　- 削除された製品IDは選択不可

【6.3 データ連動ルール】

◆ 製造データ自動処理ルール
　- 同一製品ID+ロットのBPRD_DATが既存の場合
　　└─ BPDD_QTY に新規明細の数量を加算
　- 同一製品ID+ロットのBPRD_DATが存在しない場合
　　├─ BPRD_DAT新規レコード作成
　　├─ BPDD_QTY = 新規明細の数量
　　├─ BPDD_FLG = DatabaseConstants.BPDD_FLG_NOT_SHIPPED（未処理フラグ）
└─ BPDD_PROC = DatabaseConstants.PROC_NON_COAT（ノンコート）

【6.4 トランザクション制御ルール】

◆ データ整合性保証
　- 製造明細登録とBPRD_DAT更新は同一トランザクション
　- エラー発生時は全処理をロールバック
　- 部分的なデータ更新は発生させない

【6.5 製品選択表示ルール】

◆ 製品一覧表示ルール
　- BFSP_MST.BFSP_SORT順で製品をソート表示
　- 表示形式：「製品ID - ベース 加入度数 L/R 色」
　- 初期選択状態：「選択してください」（空値）

■ 7. エラーハンドリング
====================================================================
【7.1 業務エラー】

◆ 入力値バリデーションエラー
　- 必須項目未入力：「すべての項目を入力してください。」
　- ロット範囲外：「ロットは0から999999の範囲で入力してください。」
　- No範囲外：「Noは0から9999の範囲で入力してください。」
　- 数量範囲外：「数量は0から99999の範囲で入力してください。」
　- 数値変換エラー：「ロット、No、数量は数値で入力してください。」

◆ データ整合性エラー
　- 製品ID不存在：「指定された製品IDは存在しません。」
　- 重複エラー：「同じ製品ID、ロット、Noの組み合わせが既に存在します。」

【7.2 システムエラー】

◆ 画面表示エラー
　- エラーメッセージ：「製造明細の作成画面表示中にエラーが発生しました: {エラー詳細}」
　- 原因：DB接続障害、製品マスタ取得エラー
　- 対応：一覧画面へリダイレクト

◆ 登録処理エラー
　- エラーメッセージ：「製造明細の作成中にエラーが発生しました: {エラー詳細}」
　- 原因：DB更新エラー、トランザクションエラー
　- 対応：自動ロールバック、入力画面再表示

【7.3 成功処理】

◆ 登録成功
　- 成功メッセージ：「製造明細を登録しました。」
　- 対応：製造明細一覧画面へリダイレクト

【7.4 エラー表示方法】
　- Flash メッセージ：Bootstrap アラート形式で画面上部に表示
　- HTML5バリデーション：即座に入力制限・エラー表示
　- 自動ロールバック：登録失敗時はデータの一貫性を保証

■ 8. 関連ファイル・関数
====================================================================
【8.1 メイン処理関数】
　- create_bprd_mei(): 製造明細登録画面表示・登録処理（app/routes.py）
　　├─ GET: 製品マスタ取得、新規作成フォーム表示
　　├─ POST: フォームデータ取得、BprdMei.create()呼び出し
　　└─ エラーハンドリング、リダイレクト処理

【8.2 関連テーブル・モデル】
　- BprdMeiModel: 製造明細テーブルのORMモデル（app/models.py）
　- BprdMei: 製造明細の業務ロジッククラス（app/models.py）
　　└─ create(): 新規明細作成・BPRD_DAT連動更新処理
　- BfspMstModel: BF規格マスタテーブル（製品選択用）
　- PrdDatModel: 製造データテーブル（連動更新対象）

【8.3 画面テンプレート】
　- bprd_mei_create.html: 新規作成画面テンプレート（app/templates/）
　　├─ 製品選択ドロップダウン（BFSP_SORT順）
　　├─ 数値入力フォーム（HTML5制約付き）
　　└─ 登録・戻るボタン

【8.4 関連画面・機能】
　- 製造明細一覧: /bprd_mei/list（list_bprd_mei関数）
　　└─ 登録完了後のリダイレクト先
　- 製造明細編集: /bprd_mei/<mei_id>/edit（edit_bprd_mei関数）
　　└─ 一覧画面からの修正機能

【8.5 業務ロジック処理】
　- BprdMei.create(): 製造明細新規作成メソッド（app/models.py）
　　├─ 入力値検証（必須、数値変換、範囲チェック）
　　├─ 製品ID存在確認（BFSP_MST照合）
　　├─ 重複チェック（製品ID+LOT+No）
　　├─ BPRD_MEI新規レコード作成
　　├─ BPRD_DAT連動処理（既存更新/新規作成）
　　└─ トランザクション制御（コミット/ロールバック）

【8.6 データベース関数】
　- dbo.Get_Zaiko_Qty_BF(): 在庫数量計算（BPRD_DATベース）
　　└─ 製造明細で管理される数量が在庫計算の基準となる

【8.7 特記事項】
　- 製造明細は製造データの詳細管理単位として機能
　- 登録により自動的にBPRD_DATの数量整合性が保たれる
　- 分割管理による製造トレーサビリティの確保
　- 在庫管理システム全体のデータ品質保証に寄与
