====================================================================
在庫管理システム - ノンコート在庫検索画面 詳細設計書（改訂版）
====================================================================

■ 1. 画面概要
====================================================================
【画面名】
　ノンコート在庫検索画面

【画面目的】
　ノンコート（未加工）レンズの在庫状況を検索・表示し、
　在庫数・受注残数の確認と出荷作業への遷移機能を提供する。

【アクセス情報】
　- URL: /noncoat-stock
　- 認証: 必須（ログイン後のみアクセス可能）

■ 2. 業務概要
====================================================================
【主要業務】
　1. 検索条件による在庫データの絞り込み検索
　2. ノンコート在庫一覧の表示
　3. 在庫数・受注残数の確認
　4. 出荷作業への遷移

【業務上の重要性】
　- 在庫管理業務の中核となる重要な検索機能
　- 出荷計画策定と在庫状況把握の基礎情報提供
　- ノンコート・ハードコート別受注残の可視化による効率的な在庫管理

【検索対象条件】
　- 在庫数量が0より大きいもののみ表示
　- ノンコート製造データのみ対象（BPDD_PROC = DatabaseConstants.PROC_NON_COAT）
　- 未出荷の有効データ（BPDD_FLG = DatabaseConstants.BPDD_FLG_NOT_SHIPPED）

【重要な業務ルール】
　- 在庫数量の算出は「dbo.Get_Zaiko_Qty_BF」関数で行う
　- NC残（ノンコート受注残）はBRCP_PROC = DatabaseConstants.PROC_NON_COATの受注データから計算
　- HC残（ハードコート受注残）はBRCP_PROC = DatabaseConstants.PROC_HARD_COATの受注データから計算
　- 受注残数量の算出は「dbo.Get_ODR_ZAN_Qty_BF」関数で行う

■ 3. 処理フロー
====================================================================
【3.1 メイン処理フロー】
```
1. ユーザーがノンコート在庫検索画面（/noncoat-stock）にアクセス
　　↓
2. @login_required デコレータで認証チェック
　　↓
3. routes.py の noncoat_stock_search() 関数実行
　　↓
4. NoncoatStockSearchForm() フォームインスタンス作成
　　↓
5. BfspMst.get_choices() で各選択肢を動的取得
　　↓
6. GET: 初期画面表示（検索フォームのみ）
   POST: 検索処理実行
　　↓
7. POST時: PrdDat.search_noncoat_stock() メソッド呼び出し
　　↓
8. 検索結果表示またはメッセージ表示
```

【3.2 検索処理詳細フロー】
```
PrdDat.search_noncoat_stock() 内部処理:
1. データベースセッション取得
　　↓
2. ノンコート在庫検索クエリ実行
　　- BPRD_DAT, BFSP_MST, BRCP_DAT テーブル結合
　　- dbo.Get_Zaiko_Qty_BF() で在庫数計算
　　- dbo.Get_ODR_ZAN_Qty_BF() で受注残計算
　　↓
3. 検索条件による動的フィルタリング
　　↓
4. 表示順序での並び替え（色→ベース→加入度数→LR→LOT）
　　↓
5. 検索結果を返却（例外時: log_error()でログ出力）
```

■ 4. 画面レイアウト
====================================================================
【4.1 画面構造】
```
├── base.html（共通テンプレート）
│   ├── ヘッダー（ナビゲーション）
│   ├── サイドメニュー
│   └── メインコンテンツエリア
│       └── noncoat_stock_search.html
│           ├── ページタイトル「ノンコート在庫検索」
│           ├── 検索条件セクション
│           │   ├── 検索フォーム（3列×2行レイアウト）
│           │   └── 検索ボタン
│           └── 検索結果セクション
│               └── 在庫一覧テーブル
```

【4.2 検索条件セクション】
```
┌───────────────────────────────────────────────────────────────────────────┐
│                        ノンコート在庫検索                                │
├──────────────────┬─────────────────┬──────────────────────────────────┤
│ 製品ID：           │ LOT：           │ ベース：                         │
│ [_____________]    │ [_____________] │ [▼全て______________]           │
├──────────────────┼─────────────────┼──────────────────────────────────┤
│ 加入度数：         │ L/R：           │ カラー：                         │
│ [▼全て__________] │ [▼全て_______] │ [▼全て______________]           │
├──────────────────┴─────────────────┴──────────────────────────────────┤
│                            [検索]                                      │
└───────────────────────────────────────────────────────────────────────────┘
```

【4.3 検索結果セクション】
```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│ 製造ID │ LOT  │ベース│加入度数│ LR │カラー│在庫数│NC残│HC残│    操作    │
├────────┼──────┼──────┼────────┼────┼──────┼──────┼────┼────┼────────────┤
│ 100001 │ 240101│  2   │  150   │ L  │ CL   │  50  │ 30 │ 20 │ [出荷]     │
│ 100002 │ 240101│  2   │  150   │ R  │ CL   │  45  │ 25 │ 15 │ [出荷]     │
│ 100003 │ 240102│  4   │  175   │ L  │ BR   │  30  │ 10 │  5 │ [出荷]     │
│ 100004 │ 240102│  4   │  175   │ R  │ BR   │  35  │ 15 │ 10 │ [出荷]     │
└────────┴──────┴──────┴────────┴────┴──────┴──────┴────┴────┴────────────┘
```

■ 5. データ項目
====================================================================
【5.1 検索条件項目】

◆ 製品ID
　- 入力方式: テキスト入力フィールド
　- 検索方式: 完全一致検索
　- 必須/任意: 任意項目（空欄可）

◆ LOT
　- 入力方式: テキスト入力フィールド
　- 検索方式: 完全一致検索
　- 必須/任意: 任意項目（空欄可）

◆ ベース・加入度数・L/R・カラー
　- 入力方式: プルダウン選択
　- 選択肢: 「全て」+ BFSP_MST.該当項目から動的取得
　- 必須/任意: 任意項目（「全て」選択可）

【5.2 表示項目】

◆ 製造ID（BPDD_ID）
　- 説明: 在庫を一意に識別するID
　- 用途: 出荷作業への遷移時に使用

◆ LOT（BPDD_LOT）
　- 説明: 製造ロット番号

◆ ベース〜カラー
　- データソース: BFSP_MST（BF規格マスタ）
　- 説明: 製品仕様情報

◆ 在庫数（stock_qty）
　- 説明: 現在の在庫残数
　- 計算方法: dbo.Get_Zaiko_Qty_BF関数による動的計算

◆ NC残（order_remaining）
　- 説明: ノンコート受注残数量
　- 対象: BRCP_PROC = DatabaseConstants.PROC_NON_COATの受注データから算出

◆ HC残（order_remaining2）
　- 説明: ハードコート受注残数量
　- 対象: BRCP_PROC = DatabaseConstants.PROC_HARD_COATの受注データから算出

◆ 操作
　- 表示: 出荷ボタン
　- 機能: 該当在庫の出荷作成画面に遷移

■ 6. 業務ルール
====================================================================
【6.1 検索データ取得ルール】
　- 基本テーブル：BPRD_DAT（製造データ）
　- 結合テーブル：BFSP_MST（BF規格マスタ）
　- 結合テーブル：BRCP_DAT（受注データ）× 2回（NC用、HC用）

【6.2 データ抽出条件】
　- BPDD_PROC = DatabaseConstants.PROC_NON_COAT（ノンコート製造データのみ）
　- BPDD_FLG = DatabaseConstants.BPDD_FLG_NOT_SHIPPED（未出荷の有効データ）
　- 在庫数量 > 0（在庫がある製品のみ）

【6.3 在庫数量・受注残計算ルール】

◆ 在庫数量計算
　- 使用関数: dbo.Get_Zaiko_Qty_BF(BPDD_ID)
　- 計算内容: 製造数量 - 出荷済み数量
　- NULL処理: NULL値は0として扱う

◆ 受注残数量計算
　- 使用関数: dbo.Get_ODR_ZAN_Qty_BF(BRCP_ID)
　- NC残: BRCP_PROC = DatabaseConstants.PROC_NON_COATの受注データから算出
　- HC残: BRCP_PROC = DatabaseConstants.PROC_HARD_COATの受注データから算出
　- NULL処理: NULL値は0として扱う

【6.4 表示順序ルール】
　- カラー（BFSP_CLR）
　- ベース（BFSP_BASE）
　- 加入度数（BFSP_ADP）
　- L/R（BFSP_LR）
　- LOT（BPDD_LOT）

【6.5 出荷作業遷移ルール】
　- 各在庫行の「出荷」ボタンクリック時
　- 製造ID（BPDD_ID）を引数として出荷作成画面へ遷移
　- URL: /shipping/create/{製造ID}

■ 7. エラーハンドリング
====================================================================
【7.1 業務エラー】
　- 検索結果なし: 「検索条件に一致する在庫データが見つかりませんでした。」
　- 認証エラー: ログイン画面へのリダイレクト

【7.2 システムエラー】
　- データベース接続エラー: 「在庫検索中にエラーが発生しました」
　- 予期せぬエラー: 「データベースへの接続に失敗しました。システム管理者に連絡してください。」

【7.3 エラーログ】
　- 全てのエラーは「log_error」関数でログ出力される
　- データベースエラー、予期せぬエラー等を記録

■ 8. 関連ファイル・関数
====================================================================
【8.1 主要ファイル・関数】

◆ ルーティング
　- ファイル: app/routes.py
　- 関数: noncoat_stock_search()
　- 機能: ノンコート在庫検索画面の表示制御
　- 認証: @login_required デコレータ

◆ データ取得モデル
　- ファイル: app/models.py
　- クラス: PrdDat
　- 関数: search_noncoat_stock()
　- 機能: ノンコート在庫データの検索・取得
　- 呼び出し元: routes.py の noncoat_stock_search()

◆ フォーム定義
　- ファイル: app/forms.py
　- クラス: NoncoatStockSearchForm
　- 機能: ノンコート在庫検索フォームの定義
　- 項目: product_id, lot, base, adp, lr, clr

◆ 選択肢取得
　- ファイル: app/models.py
　- クラス: BfspMst
　- 関数: get_choices()
　- 機能: BF規格マスタから選択肢を動的取得

◆ テンプレート
　- ファイル: app/templates/noncoat_stock_search.html
　- 機能: ノンコート在庫検索画面のHTML表示
　- 継承: base.html

◆ データベース関数
　- 関数: dbo.Get_Zaiko_Qty_BF()
　- 機能: 在庫数量計算関数
　- 関数: dbo.Get_ODR_ZAN_Qty_BF()
　- 機能: 受注残数量計算関数

◆ エラーログ
　- ファイル: app/models.py
　- 関数: log_error()
　- 機能: エラーログ記録機能

【8.2 データベーステーブル】

◆ BPRD_DAT（製造データテーブル）
　- 主要項目: BPDD_ID, BPDD_PRD_ID, BPDD_LOT, BPDD_PROC, BPDD_FLG
　- 業務用途: 在庫検索の基準データ

◆ BFSP_MST（BF規格マスタテーブル）
　- 主要項目: BFSP_PRD_ID, BFSP_BASE, BFSP_ADP, BFSP_LR, BFSP_CLR
　- 業務用途: 製品情報と選択肢提供

◆ BRCP_DAT（受注データテーブル）
　- 主要項目: BRCP_PRD_ID, BRCP_PROC, BRCP_QTY, BRCP_FLG
　- 業務用途: 受注残計算

【8.3 関連画面・機能】
　- 出荷作成画面: /shipping/create/<製造ID>
　- ハードコート在庫検索: /hardcoat_stock
　- ログイン画面: 認証必須のため
