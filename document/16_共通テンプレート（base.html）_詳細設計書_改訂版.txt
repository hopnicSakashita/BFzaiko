====================================================================
在庫管理システム - 共通テンプレート（base.html）詳細設計書（改訂版）
====================================================================

■ 1. 画面概要
====================================================================
【画面名】
　共通ベーステンプレート（base.html）

【画面ID】
　BASE_TEMPLATE

【アクセス権限】
　- 対象: システム利用者全員
　- 認証: セッション管理による認証状態判定
　- 権限: 各機能画面の権限に依存

【画面の位置づけ】
　在庫管理システムの全画面で共通使用される基盤テンプレート。
　システム全体のUI/UX統一、業務フロー案内、ユーザー操作性向上を担う。

■ 2. 業務概要
====================================================================
【業務目的】
　1. システム全体のUI統一による操作性向上
　2. 業務フロー案内による効率的な画面遷移
　3. ユーザー認証状態管理とセキュリティ確保
　4. 操作結果フィードバックによる業務品質向上
　5. レスポンシブ対応によるマルチデバイス利用

【主要業務機能】
　1. 統一ナビゲーション：業務フロー順での機能案内
　2. ユーザー認証表示：ログイン状態とユーザー識別
　3. メッセージ表示：操作結果・エラー情報の視覚化
　4. セッション管理：ログイン維持・自動ログアウト
　5. 画面遷移制御：業務フローに沿った適切な遷移

【業務上の重要性】
　- システム利用者の作業効率に直接影響
　- 誤操作防止・業務品質向上に貢献
　- 新規利用者の学習コスト削減
　- システム全体の保守性・拡張性確保

■ 3. 処理フロー
====================================================================
【3.1 メインフロー】
　1. ページ読み込み開始
　　　↓
　2. ユーザー認証状態確認
　　　↓
　3. ナビゲーションメニュー構築
　　　↓
　4. 現在ページのアクティブ状態設定
　　　↓
　5. 個別画面コンテンツ表示
　　　↓
　6. フラッシュメッセージ処理
　　　↓
　7. ユーザー操作待機

【3.2 ナビゲーション構築フロー】
　1. セッション情報取得
　　　├─ 認証済み → ユーザー名表示・ログアウトボタン表示
　　　└─ 未認証 → ログインボタンのみ表示
　　　　　　↓
　2. 現在ページ判定（request.endpoint）
　　　↓
　3. アクティブメニュー設定
　　　↓
　4. メニュー階層構築
　　　├─ トップページ
　　　├─ 受注データ機能群
　　　├─ ノンコート機能群（コラプシブル）
　　　├─ ハードコート機能群（コラプシブル）
　　　└─ 出荷データ機能群

【3.3 メッセージ表示フロー】
　1. フラッシュメッセージ取得
　　　↓
　2. メッセージカテゴリ判定
　　　├─ success → 成功メッセージ表示
　　　├─ error → エラーメッセージ表示
　　　├─ warning → 警告メッセージ表示
　　　└─ info → 情報メッセージ表示
　　　　　　↓
　3. 自動表示・自動消去制御
　　　├─ エラー → 手動クローズのみ
　　　└─ その他 → 10秒後自動消去

【3.4 ボタン制御フロー】
　1. ボタン操作検知
　　　↓
　2. 重複送信チェック
　　　├─ 初回操作 → 処理継続
　　　└─ 重複操作 → 操作無効化
　　　　　　↓
　3. ボタン状態変更
　　　├─ 無効化（disabled状態）
　　　├─ ローディング表示
　　　└─ テキスト変更
　　　　　　↓
　4. 処理完了後 → ボタン状態復元

■ 4. 画面レイアウト
====================================================================
【4.1 レイアウト構成】
　┌─────────────────────────────────┐
　│ ヘッダーナビゲーション（固定）                │
　│ ・ブランド名　・ユーザー情報　・ログアウト    │
　├─────────────────────────────────┤
　│ サイドメニュー │ メインコンテンツエリア      │
　│ ・業務メニュー │ ・アラート表示エリア        │
　│ ・機能分類     │ ・個別画面コンテンツ        │
　│ ・階層構造     │                             │
　└─────────────────────────────────┘

【4.2 業務メニュー階層】
　├─ トップページ
　├─ 受注データ入力
　├─ 受注データ検索
　├─ [ノンコート] （展開可能）
　│   ├─ NC製造データCSV取込
　│   ├─ NC製造明細一覧
　│   ├─ NC製造明細登録
　│   ├─ NC製造明細編集
　│   ├─ ノンコート在庫検索
　│   └─ 加工指示書
　├─ [ハードコート] （展開可能）
　│   ├─ ハードコートExcel読込
　│   ├─ ハードコート在庫検索
　│   └─ ハードコート出荷作成
　└─ 出荷一覧

【4.3 レスポンシブ対応】
　- PC表示: サイドメニュー固定表示
　- タブレット: サイドメニュー折りたたみ可能
　- モバイル: ハンバーガーメニュー形式

■ 5. データ項目
====================================================================
【5.1 セッション関連データ】
　- user_id: ユーザーID（認証状態判定）
　- user_name: ユーザー名（画面表示用）
　- login_time: ログイン時刻（セッション管理）

【5.2 ナビゲーション関連データ】
　- request.endpoint: 現在ページ識別子
　- アクティブメニュー判定用データ
　- メニュー階層構造データ

【5.3 メッセージ関連データ】
　- フラッシュメッセージ（カテゴリ別）
　　- success: 成功メッセージ
　　- error: エラーメッセージ
　　- warning: 警告メッセージ
　　- info: 情報メッセージ

【5.4 ページ固有データ】
　- ページタイトル
　- 個別画面コンテンツ
　- 画面固有CSS/JavaScript

■ 6. 業務ルール
====================================================================
【6.1 認証・セキュリティルール】
　1. セッション有効性チェック
　　- ログイン状態: ユーザー情報表示・全機能利用可能
　　- 未ログイン状態: ログイン画面表示・機能制限

　2. セッションタイムアウト管理
　　- 一定時間操作なし → 自動ログアウト
　　- セッション切れ → ログイン画面リダイレクト

【6.2 ナビゲーション表示ルール】
　1. アクティブメニュー表示
　　- 現在表示中の画面メニューをハイライト
　　- 階層メニューの場合、親メニューも展開状態維持

　2. メニュー分類表示
　　- 業務フロー順でのメニュー配置
　　- 関連機能のグループ化（ノンコート・ハードコート）

【6.3 メッセージ表示ルール】
　1. メッセージ優先度
　　- エラーメッセージ: 最優先表示・手動クローズ
　　- 警告メッセージ: 注意喚起・自動消去
　　- 成功メッセージ: 操作確認・自動消去
　　- 情報メッセージ: 補助情報・自動消去

　2. 複数メッセージ処理
　　- 同時表示可能
　　- カテゴリ別色分け表示
　　- 表示順序: エラー → 警告 → 成功 → 情報

【6.4 操作制御ルール】
　1. 重複送信防止
　　- ボタン押下時の二重送信防止
　　- 処理中状態の視覚化
　　- 処理完了まで操作無効化

　2. フォーム送信制御
　　- 送信前バリデーション
　　- 送信中状態表示
　　- エラー時の状態復元

■ 7. エラーハンドリング
====================================================================
【7.1 認証エラー】
　- セッション無効: ログイン画面リダイレクト
　- 権限不足: アクセスエラーページ表示
　- タイムアウト: 自動ログアウト・メッセージ表示

【7.2 システムエラー】
　- テンプレート読み込み失敗: 500エラーページ
　- 外部CDN読み込み失敗: 最低限UI継続表示
　- JavaScript実行エラー: 基本機能継続・ログ出力

【7.3 業務エラー】
　- 不正データ: エラーメッセージ表示・入力促進
　- 処理失敗: 詳細エラー情報表示・再実行案内
　- 通信エラー: 再試行案内・システム管理者連絡

【7.4 UI/UXエラー】
　- メニュー表示異常: デフォルトメニュー表示
　- レスポンシブ崩れ: モバイル最適化表示
　- ブラウザ互換性問題: 代替機能提供

■ 8. 関連ファイル・関数
====================================================================
【8.1 テンプレート関連】
　◆ 主要ファイル
　　- app/templates/base.html: ベーステンプレート
　　- app/templates/*/**.html: 各機能画面テンプレート

　◆ 継承関数
　　- {% extends "base.html" %}: テンプレート継承
　　- {% block content %}: コンテンツブロック
　　- {% block title %}: タイトルブロック
　　- {% block extra_css %}: 追加CSSブロック
　　- {% block extra_js %}: 追加JavaScriptブロック

【8.2 認証・セッション関連】
　◆ ルーティング関数
　　- auth.logout: ログアウト処理
　　- session.get('user_id'): ユーザーID取得
　　- session.get('user_name'): ユーザー名取得

　◆ セッション管理関数
　　- login_required: ログイン必須デコレータ
　　- check_session_validity: セッション有効性チェック

【8.3 メッセージ関連】
　◆ フラッシュメッセージ関数
　　- flash(message, category): メッセージ登録
　　- get_flashed_messages(with_categories=True): メッセージ取得

　◆ カテゴリ別表示関数
　　- flash_success(message): 成功メッセージ
　　- flash_error(message): エラーメッセージ
　　- flash_warning(message): 警告メッセージ
　　- flash_info(message): 情報メッセージ

【8.4 ナビゲーション関連】
　◆ URL生成関数
　　- url_for('index'): トップページURL
　　- url_for('order_input'): 受注データ入力URL
　　- url_for('order_search'): 受注データ検索URL
　　- url_for('import_csv'): CSV取込URL
　　- url_for('list_bprd_mei'): 製造明細一覧URL
　　- url_for('create_bprd_mei'): 製造明細登録URL
　　- url_for('edit_bprd_mei'): 製造明細編集URL
　　- url_for('noncoat_stock_search'): ノンコート在庫検索URL
　　- url_for('proc_order'): 加工指示書URL
　　- url_for('hardcoat_read_excel'): ハードコートExcel読込URL
　　- url_for('hardcoat_stock_search'): ハードコート在庫検索URL
　　- url_for('create_shipping_hard'): ハードコート出荷作成URL
　　- url_for('shipment_list'): 出荷一覧URL

　◆ ページ判定関数
　　- request.endpoint: 現在ページ識別
　　- is_active_menu(endpoint): アクティブメニュー判定

【8.5 外部依存関数】
　◆ 外部CDN（可用性確保）
　　- Bootstrap CSS/JS: UI framework
　　- Bootstrap Icons: アイコン表示
　　- jQuery: JavaScript操作補助

　◆ 代替処理関数
　　- fallback_css_load: CSS読み込み失敗時代替
　　- fallback_js_load: JavaScript読み込み失敗時代替 