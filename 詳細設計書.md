# BFZaiko在庫管理システム 詳細設計書

## 1. システム概要

### 1.1 システム名
**BFZaiko在庫管理システム（BF Stock Management System）**

### 1.2 技術スタック
- **フレームワーク**: Flask 3.0.0
- **言語**: Python 3.x
- **データベース**: Microsoft SQL Server
- **フロントエンド**: HTML5, CSS3, Bootstrap 5.3.0, JavaScript
- **認証**: セッションベース認証
- **デプロイ**: Gunicorn + WSGI

### 1.3 ライブラリ構成
```
flask==3.0.0
flask-sqlalchemy==3.1.1
pymssql==2.2.11
pandas==2.2.3
openpyxl==3.1.2
xlsxwriter==3.1.9
reportlab
flask_wtf
gunicorn==21.2.0
python-dotenv==1.0.0
```

### 1.4 システム目的
レンズ製造業における包括的な在庫管理システム。受注から出荷、製造、加工まで一元管理する。

## 2. アーキテクチャ設計

### 2.1 全体構成
```
BFZaiko/
├── app/                    # アプリケーションコア
│   ├── __init__.py        # Flask アプリ初期化
│   ├── auth.py            # 認証ロジック
│   ├── auth_routes.py     # 認証ルート
│   ├── routes.py          # メインルート
│   ├── routes_common.py   # 共通機能ルート
│   ├── routes_gradation.py # グラデーション機能
│   ├── routes_master.py   # マスタ管理ルート
│   ├── routes_total.py    # 集計機能ルート
│   ├── models.py          # データモデル（メイン）
│   ├── models_common.py   # 共通データモデル
│   ├── models_master.py   # マスタデータモデル
│   ├── models_total.py    # 集計データモデル
│   ├── database.py        # DB接続管理
│   ├── constants.py       # 定数定義
│   ├── forms.py           # Webフォーム定義
│   ├── logger_utils.py    # ログ管理
│   ├── export_excel.py    # Excel出力
│   ├── export_pdf.py      # PDF出力
│   ├── import_csv.py      # CSV取込
│   ├── import_excel.py    # Excel取込
│   ├── barcode_*.py       # バーコード関連
│   ├── shipment*.py       # 出荷関連
│   ├── gradation.py       # グラデーション処理
│   ├── templates/         # HTMLテンプレート
│   └── static/           # 静的ファイル
├── sql/                   # SQLスクリプト
├── document/             # 既存設計書
├── EXCEL/               # Excelテンプレート
├── run.py               # アプリケーション起動
├── requirements.txt     # 依存関係
└── README.md           # プロジェクト説明
```

### 2.2 Blueprint 構成
1. **auth**: 認証関連（ログイン/ログアウト）
2. **common_bp**: 共通機能（在庫・出荷・入庫）
3. **total_bp**: 集計機能（加工状況・集計表示）
4. **routes**: メイン機能（受注・製造・出荷）
5. **routes_gradation**: グラデーション加工
6. **routes_master**: マスタ管理

### 2.3 設計パターン
- **MVC アーキテクチャ**: Model(models.py) - View(templates/) - Controller(routes.py)
- **Blueprint パターン**: 機能別モジュール分割
- **Factory パターン**: Flask アプリ初期化
- **Repository パターン**: データアクセス層の抽象化

## 3. データベース設計

### 3.1 主要テーブル構成

#### 3.1.1 基本データテーブル
- **BRCP_DAT**: 受注データ
- **BPRD_DAT**: 製造・在庫データ
- **BSHK_DAT**: 出荷データ
- **BPRD_MEI**: 製造明細

#### 3.1.2 マスタテーブル
- **BFSP_MST**: 製品マスタ
- **BZTR_MST**: 取引先マスタ
- **KBN_MST**: 区分マスタ
- **CPRC_MST**: 加工マスタ
- **CPRG_MST**: 加工種別マスタ

#### 3.1.3 共通データテーブル
- **CPRD_DAT**: 共通製品データ
- **CPRC_DAT**: 共通加工データ
- **CSHK_DAT**: 共通出荷データ

#### 3.1.4 グラデーション関連テーブル
- **GPRR_DAT**: グラデーション加工依頼
- **GPRC_DAT**: グラデーション加工データ
- **GSHK_DAT**: グラデーション出荷データ

#### 3.1.5 バーコード関連テーブル
- **BBCD_DAT**: バーコードデータ
- **CBCD_MST**: バーコードマスタ

### 3.2 主要関数（SQL Server）
- **Get_ODR_ZAN_Qty_BF**: 受注残数量計算
- **Get_Zaiko_Qty_BF**: 在庫数量計算
- **Get_CPRD_ZAN_Qty**: 共通製品残数量計算
- **Get_CSHK_PRC_ZAN_Qty**: 共通出荷加工残数量計算

## 4. 機能一覧

### 4.1 認証・基本機能（2機能）

#### 4.1.1 ログイン画面
- **URL**: `/auth/login`
- **ファイル**: `login.html`
- **機能**: ユーザー認証、セッション管理
- **実装**: `auth_routes.py:login()`

#### 4.1.2 トップページ
- **URL**: `/`
- **ファイル**: `index.html`
- **機能**: ダッシュボード、受注残サマリ表示
- **実装**: `routes.py:index()`

### 4.2 受注・注文管理（2機能）

#### 4.2.1 受注データ入力
- **URL**: `/order_input`
- **ファイル**: `order_input.html`
- **機能**: 受注データ新規登録・更新
- **実装**: `routes.py:order_input()`

#### 4.2.2 受注データ検索
- **URL**: `/order_search`
- **ファイル**: `order_search.html`
- **機能**: 受注データ検索・一覧表示
- **実装**: `routes.py:order_search()`

### 4.3 在庫管理（2機能）

#### 4.3.1 ノンコート在庫検索
- **URL**: `/noncoat-stock`
- **ファイル**: `noncoat_stock_search.html`
- **機能**: ノンコート在庫検索・表示
- **実装**: `routes.py:noncoat_stock_search()`

#### 4.3.2 ハードコート在庫検索
- **URL**: `/hardcoat-stock`
- **ファイル**: `hardcoat_stock_search.html`
- **機能**: ハードコート在庫検索・表示
- **実装**: `routes.py:hardcoat_stock_search()`

### 4.4 出荷管理（3機能）

#### 4.4.1 出荷一覧
- **URL**: `/shipment_list`
- **ファイル**: `shipment_list.html`
- **機能**: 出荷データ検索・PDF/CSV出力・削除
- **実装**: `routes.py:shipment_list()`

#### 4.4.2 出荷作成（ノンコート）
- **URL**: `/shipping/create`
- **ファイル**: `shipping/create.html`
- **機能**: ノンコート在庫からの出荷データ作成
- **実装**: `routes.py:shipping_create()`

#### 4.4.3 出荷作成（ハードコート）
- **URL**: `/shipping/create_hard`
- **ファイル**: `shipping/create_hard.html`
- **機能**: ハードコート在庫からの出荷データ作成
- **実装**: `routes.py:shipping_create_hard()`

### 4.5 製造・加工管理（4機能）

#### 4.5.1 加工指示書
- **URL**: `/proc_order`
- **ファイル**: `proc_order.html`
- **機能**: 加工指示書管理・表示・Excel出力
- **実装**: `routes.py:proc_order()`

#### 4.5.2 製造明細一覧
- **URL**: `/bprd_mei_list`
- **ファイル**: `bprd_mei_list.html`
- **機能**: 製造明細一覧表示・管理
- **実装**: `routes.py:bprd_mei_list()`

#### 4.5.3 製造明細登録
- **URL**: `/bprd_mei_create`
- **ファイル**: `bprd_mei_create.html`
- **機能**: 新規製造明細登録
- **実装**: `routes.py:bprd_mei_create()`

#### 4.5.4 製造明細編集
- **URL**: `/bprd_mei_edit/<id>`
- **ファイル**: `bprd_mei_edit.html`
- **機能**: 既存製造明細編集・更新
- **実装**: `routes.py:bprd_mei_edit()`

### 4.6 データ取込・出力（2機能）

#### 4.6.1 CSVデータ取込
- **URL**: `/import_csv`
- **ファイル**: `import_csv.html`
- **機能**: CSVファイルからのデータ取込
- **実装**: `routes.py:import_csv()`

#### 4.6.2 ハードコートExcel読込
- **URL**: `/hardcoat_read_excel`
- **ファイル**: `hardcoat_read_excel.html`
- **機能**: Excelファイルからのハードコートデータ取込
- **実装**: `routes.py:hardcoat_read_excel()`

### 4.7 バーコード機能（3機能）

#### 4.7.1 バーコード読込
- **URL**: `/barcode_scan`
- **ファイル**: `barcode_scan.html`
- **機能**: カメラによるバーコード読み取り
- **実装**: `routes.py:barcode_scan()`

#### 4.7.2 バーコード取込
- **URL**: `/barcode_import`
- **ファイル**: `barcode_import.html`
- **機能**: バーコードデータ取込
- **実装**: `routes.py:barcode_import()`

#### 4.7.3 バーコードCSV読込
- **URL**: `/barcode_scan_csv`
- **ファイル**: `barcode_scan_csv.html`
- **機能**: CSVからのバーコード一括読込
- **実装**: `routes.py:barcode_scan_csv()`

### 4.8 グラデーション加工管理（8機能）

#### 4.8.1 コンベックス加工依頼管理
- **URL**: `/gradation/gprr_list`
- **ファイル**: `gradation/gprr_list.html`
- **機能**: 1回目加工依頼管理
- **実装**: `routes_gradation.py:gprr_list()`

#### 4.8.2 コンベックス加工データ管理
- **URL**: `/gradation/gprc_list`
- **ファイル**: `gradation/gprc_list.html`
- **機能**: 1回目加工戻りデータ管理
- **実装**: `routes_gradation.py:gprc_list()`

#### 4.8.3 ニデック加工依頼管理
- **URL**: `/gradation/nidec_proc_create`
- **ファイル**: `gradation/nidec_proc_create.html`
- **機能**: 2回目加工依頼管理
- **実装**: `routes_gradation.py:nidec_proc_create()`

#### 4.8.4 ニデック加工データ管理
- **URL**: `/gradation/nidec_gprc_list`
- **ファイル**: `gradation/nidec_gprc_list.html`
- **機能**: 2回目加工戻りデータ管理
- **実装**: `routes_gradation.py:nidec_gprc_list()`

#### 4.8.5 最終出荷管理
- **URL**: `/gradation/final_shipping_search`
- **ファイル**: `gradation/final_shipping_search.html`
- **機能**: 加工完了後の最終出荷管理
- **実装**: `routes_gradation.py:final_shipping_search()`

#### 4.8.6 加工状況マトリックス表示
- **URL**: `/gradation/processing_matrix`
- **ファイル**: `gradation/processing_matrix.html`
- **機能**: 加工状況の可視化
- **実装**: `routes_gradation.py:processing_matrix()`

#### 4.8.7 自動出荷機能
- **URL**: `/gradation/auto_shipping`
- **ファイル**: `gradation/auto_shipping.html`
- **機能**: バッチ処理による出荷自動化
- **実装**: `routes_gradation.py:auto_shipping()`

#### 4.8.8 グラデーション在庫管理
- **URL**: `/gradation/gshk_list`
- **ファイル**: `gradation/gshk_list.html`
- **機能**: グラデーション在庫一覧・編集
- **実装**: `routes_gradation.py:gshk_list()`

### 4.9 共通機能（6機能）

#### 4.9.1 在庫詳細表示
- **URL**: `/common/stock_detail`
- **ファイル**: `common/common_stock_detail.html`
- **機能**: 製品別在庫詳細表示
- **実装**: `routes_common.py:stock_detail()`

#### 4.9.2 在庫集計表示
- **URL**: `/common/stock_summary`
- **ファイル**: `common/common_stock_summary.html`
- **機能**: 製品別在庫集計表示
- **実装**: `routes_common.py:stock_summary()`

#### 4.9.3 入庫データ管理
- **URL**: `/common/cprd_dat_list`
- **ファイル**: `common/cprd_dat_list.html`
- **機能**: 入庫データ一覧・検索・管理
- **実装**: `routes_common.py:cprd_dat_list()`

#### 4.9.4 出荷データ作成
- **URL**: `/common/cprd_dat_shipment_create`
- **ファイル**: `common/cprd_dat_shipment_create.html`
- **機能**: 入庫データからの出荷作成
- **実装**: `routes_common.py:cprd_dat_shipment_create()`

#### 4.9.5 CSV取込（共通）
- **URL**: `/common/csv_import_common`
- **ファイル**: `common/csv_import_common.html`
- **機能**: 共通データのCSV一括取込
- **実装**: `routes_common.py:csv_import_common()`

#### 4.9.6 加工依頼一覧
- **URL**: `/common/process_request_list`
- **ファイル**: `common/process_request_list.html`
- **機能**: 加工依頼の検索・管理
- **実装**: `routes_common.py:process_request_list()`

### 4.10 マスタ管理（7機能）

#### 4.10.1 製品マスタ
- **URL**: `/master/prd_list`
- **ファイル**: `master/prd_list.html`
- **機能**: 製品マスタ管理
- **実装**: `routes_master.py:prd_list()`

#### 4.10.2 区分マスタ
- **URL**: `/master/kbn_list`
- **ファイル**: `master/kbn_list.html`
- **機能**: 区分マスタ管理
- **実装**: `routes_master.py:kbn_list()`

#### 4.10.3 加工マスタ
- **URL**: `/master/cprc_list`
- **ファイル**: `master/cprc_list.html`
- **機能**: 加工マスタ管理
- **実装**: `routes_master.py:cprc_list()`

#### 4.10.4 加工種別マスタ
- **URL**: `/master/cprg_list`
- **ファイル**: `master/cprg_list.html`
- **機能**: 加工種別マスタ管理
- **実装**: `routes_master.py:cprg_list()`

#### 4.10.5 取引先マスタ
- **URL**: `/master/cztr_list`
- **ファイル**: `master/cztr_list.html`
- **機能**: 取引先マスタ管理
- **実装**: `routes_master.py:cztr_list()`

#### 4.10.6 バーコードマスタ
- **URL**: `/master/cbcd_list`
- **ファイル**: `master/cbcd_list.html`
- **機能**: バーコードマスタ管理
- **実装**: `routes_master.py:cbcd_list()`

#### 4.10.7 集計機能
- **URL**: `/total/processing_matrix_cprg`
- **ファイル**: `total/processing_matrix_cprg.html`
- **機能**: 加工種別別集計表示
- **実装**: `routes_total.py:processing_matrix_cprg()`

## 5. セキュリティ設計

### 5.1 認証・認可
- **セッションベース認証**: `@login_required`デコレータ
- **パスワードハッシュ化**: Werkzeugハッシュ機能
- **セッション管理**: Flask Session

### 5.2 セキュリティ対策
- **SQLインジェクション対策**: パラメータ化クエリ使用
- **XSS対策**: Jinja2テンプレートの自動エスケープ
- **CSRF対策**: Flask-WTFのCSRFトークン
- **セッションハイジャック対策**: セッションIDローテーション

### 5.3 ログ管理
- **ログレベル**: DEBUG, INFO, WARNING, ERROR, CRITICAL
- **ログ出力**: `logger_utils.py`による統一管理
- **ログローテーション**: サイズベース・日付ベース

**文書作成日**: 2025年1月
**作成者**: Claude Code
**バージョン**: 1.0
**対象システム**: BFZaiko在庫管理システム